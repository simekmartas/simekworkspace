<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prodejní analytika - Mobil Maják</title>
    <!-- Legacy Browser Support First -->
    <script src="legacy-browser-support.js"></script>
    <link rel="stylesheet" href="legacy-browser-styles.css">
    <link rel="stylesheet" href="css-compatibility-patches.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="progressive-enhancement.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#ff1493">
    <meta name="description" content="Prodejní analytika - Mobil Maják">
    
    <style>
        .analytics-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            margin-top: 100px;
        }
        
        .analytics-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .analytics-header h1 {
            color: var(--text-primary);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .analytics-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff1493, #2196F3);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 20, 147, 0.15);
        }
        
        .stat-emoji {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .section-title {
            color: var(--text-primary);
            font-size: 1.8rem;
            font-weight: 600;
            margin: 3rem 0 1.5rem 0;
            text-align: center;
        }
        
        .chart-container {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .seller-table, .scenario-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .seller-table th, .seller-table td,
        .scenario-table th, .scenario-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .seller-table th, .scenario-table th {
            color: var(--primary-color);
            font-weight: 600;
            background: rgba(255, 20, 147, 0.05);
        }
        
        .seller-table td, .scenario-table td {
            color: var(--text-primary);
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ed573, #20bf6b);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .filter-section {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 3rem;
        }
        
        .filter-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #ff1493, #e91e63);
            color: white;
            border-color: var(--primary-color);
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .no-data-emoji {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        /* Admin nástroje styly */
        #admin-tools-toggle:hover {
            background: rgba(255,255,255,0.2) !important;
            color: var(--text-primary) !important;
            transform: translateY(-1px);
        }
        
        .admin-btn {
            transition: all 0.2s ease !important;
        }
        
        .admin-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        
        #admin-tools-content {
            transition: max-height 0.3s ease-out;
        }

        @media (max-width: 768px) {
            .analytics-container {
                padding: 1rem;
                margin-top: 80px;
            }
            
            .analytics-header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1.5rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .filter-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .filter-btn {
                width: 100%;
                min-width: auto;
                font-size: 0.85rem;
            }
            
            /* Zmenši text v tlačítkách prodejen na mobilu */
            .store-filter {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
            }
            
            /* Na mobilech zobraz méně tlačítek v řádku pro prodejny */
            #store-filters {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            #store-filters .filter-btn {
                text-align: center;
                justify-content: center;
            }
            
            /* Admin nástroje na mobilu */
            #admin-tools-content div {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .admin-btn {
                font-size: 0.75rem !important;
                padding: 0.5rem !important;
            }
            
            /* Scenario modal na mobilu */
            .scenario-modal .modal-content {
                max-height: 95vh !important;
                padding: 1rem !important;
            }
            
            .scenario-modal h2 {
                font-size: 1.3rem !important;
            }
            
            .scenario-modal .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5rem !important;
            }
            
            .scenario-modal .filter-buttons {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .scenario-modal .session-card {
                padding: 1rem !important;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">Mobil Maják</a>
            <nav>
                <ul>
                    <!-- Navigace bude dynamicky načtena pomocí JavaScriptu -->
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="analytics-container">
            <div class="analytics-header">
                <h1>📊 Prodejní analytika</h1>
                <p>Komplexní přehled výkonnosti prodejních týmů</p>
            </div>

            <div class="filter-section">
                <!-- Hlavní filtry - vždy viditelné -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--primary-color, #ff1493); margin-bottom: 1rem; text-align: center; font-size: 1rem;">📅 Časové období</h4>
                    <div class="filter-controls">
                        <button class="filter-btn time-filter active" onclick="setTimeFilter('all')">Všechna data</button>
                        <button class="filter-btn time-filter" onclick="setTimeFilter('today')">Dnes</button>
                        <button class="filter-btn time-filter" onclick="setTimeFilter('week')">Tento týden</button>
                        <button class="filter-btn time-filter" onclick="setTimeFilter('month')">Tento měsíc</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="color: var(--primary-color, #ff1493); margin-bottom: 1rem; text-align: center; font-size: 1rem;">🏪 Prodejna</h4>
                    <div class="filter-controls" id="store-filters">
                        <button class="filter-btn store-filter active" onclick="setStoreFilter('all')">Všechny prodejny</button>
                        <!-- Dynamicky načtené prodejny -->
                    </div>
                </div>
                
                <!-- Jednoduché akce -->
                <div style="margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="filter-btn" onclick="debugLoadData()" style="background: #2196F3; border-color: #2196F3; font-weight: 600;">
                            🔄 Obnovit data
                        </button>
                        <button class="filter-btn" onclick="resetAllFilters()" style="background: #ff9500; border-color: #ff9500; font-weight: 600;">
                            ↩️ Reset filtrů
                        </button>
                        <button class="filter-btn" onclick="showDeleteDataModal()" style="background: #ff4757; border-color: #ff4757; font-weight: 600;">
                            🗑️ Smazat data
                        </button>
                    </div>
                </div>
                
                <!-- Pokročilé nástroje - skládací -->
                <div style="text-align: center;">
                    <button id="admin-tools-toggle" onclick="toggleAdminTools()" style="
                        background: rgba(255,255,255,0.1); color: var(--text-secondary); 
                        border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; 
                        border-radius: 20px; cursor: pointer; font-size: 0.85rem; 
                        transition: all 0.3s ease; font-weight: 500;
                    ">
                        ⚙️ Pokročilé nástroje 
                        <span id="admin-tools-arrow" style="margin-left: 0.5rem; transition: transform 0.3s ease;">▼</span>
                    </button>
                    
                    <div id="admin-tools-content" style="
                        max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
                        margin-top: 0;
                    ">
                        <div style="
                            margin-top: 1rem; padding: 1rem; 
                            background: rgba(255,255,255,0.03); border-radius: 10px;
                            border: 1px solid rgba(255,255,255,0.1);
                        ">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem;">
                                <button class="filter-btn admin-btn" onclick="syncWithServer()" style="background: #ff9500; border-color: #ff9500; font-size: 0.8rem; padding: 0.6rem;">
                                    🔄 Sync server
                                </button>
                                <button class="filter-btn admin-btn" onclick="testServerConnection()" style="background: #2ed573; border-color: #2ed573; font-size: 0.8rem; padding: 0.6rem;">
                                    🌐 Test server
                                </button>
                                <button class="filter-btn admin-btn" onclick="cleanDuplicateSellerData()" style="background: #8e44ad; border-color: #8e44ad; font-size: 0.8rem; padding: 0.6rem;">
                                    🔧 Fix duplicity
                                </button>
                                <button class="filter-btn admin-btn" onclick="showSellerNameManager()" style="background: #6c5ce7; border-color: #6c5ce7; font-size: 0.8rem; padding: 0.6rem;">
                                    👤 Správa jmen
                                </button>
                                <button class="filter-btn admin-btn" onclick="resetServerData()" style="background: #e74c3c; border-color: #e74c3c; font-size: 0.8rem; padding: 0.6rem;">
                                    🌐 Reset serveru
                                </button>
                            </div>
                            
                            <div style="text-align: center; margin-top: 0.75rem; font-size: 0.75rem; color: var(--text-secondary);">
                                ⚠️ Nástroje pro správce systému
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analyticsContent">
                <div class="loading">
                    <div class="loading-spinner">⏳</div>
                    <p>Načítám analytické data...</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Mobil Maják. Všechna práva vyhrazena.</p>
        </div>
    </footer>

    <script src="theme-toggle.js"></script>
    <script src="sales-assistant.js"></script>
    <script src="navigation.js"></script>
    <script src="access-control.js"></script>
    
    <script>
        let currentTimeFilter = 'all';
        let currentStoreFilter = 'all';
        let analyticsData = null;
        let availableStores = [];

        // Kontrola přístupu - pouze pro administrátory
        function checkAdminAccess() {
            const userRole = localStorage.getItem('role');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            
            if (!isLoggedIn || (userRole !== 'Administrator' && userRole !== 'Administrátor')) {
                alert('Nemáte oprávnění k přístupu k této stránce.');
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // Načtení dostupných prodejen z dat
        function loadAvailableStores() {
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                console.log('🏪 Načítám prodejny ze', localData.length, 'sessions');
                
                const stores = new Set();
                const storeDebug = {};
                
                localData.forEach((session, index) => {
                    const store = session.store || session.prodejna || 'Neznámá prodejna';
                    if (store && store !== 'undefined' && store !== '') {
                        stores.add(store);
                        storeDebug[store] = (storeDebug[store] || 0) + 1;
                    }
                    
                    // Debug první 3 sessions
                    if (index < 3) {
                        console.log(`🏪 Session ${index}:`, {
                            store: session.store,
                            prodejna: session.prodejna,
                            keys: Object.keys(session)
                        });
                    }
                });
                
                availableStores = Array.from(stores).sort();
                console.log('🏪 Dostupné prodejny:', availableStores);
                console.log('🏪 Počty podle prodejen:', storeDebug);
                
                // Aktualizuj UI filtrů prodejen
                updateStoreFilters();
                
            } catch (error) {
                console.error('Chyba při načítání prodejen:', error);
            }
        }

        // Aktualizace UI filtrů prodejen
        function updateStoreFilters() {
            const storeFiltersContainer = document.getElementById('store-filters');
            if (!storeFiltersContainer) return;
            
            // Zachovej tlačítko "Všechny prodejny"
            const allButton = storeFiltersContainer.querySelector('.store-filter[onclick*="all"]');
            storeFiltersContainer.innerHTML = '';
            if (allButton) {
                storeFiltersContainer.appendChild(allButton);
            } else {
                storeFiltersContainer.innerHTML = '<button class="filter-btn store-filter active" onclick="setStoreFilter(\'all\')">Všechny prodejny</button>';
            }
            
            // Přidej tlačítka pro jednotlivé prodejny
            availableStores.forEach(store => {
                const button = document.createElement('button');
                button.className = 'filter-btn store-filter';
                button.textContent = `🏪 ${store}`;
                button.onclick = () => setStoreFilter(store);
                storeFiltersContainer.appendChild(button);
            });
        }

        // Nastavení časového filtru
        function setTimeFilter(filter) {
            currentTimeFilter = filter;
            
            // Aktualizuj aktivní tlačítko
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Najdi a aktivuj správné tlačítko
            const targetBtn = Array.from(document.querySelectorAll('.time-filter')).find(btn => 
                btn.onclick.toString().includes(filter)
            );
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            console.log('📅 Nastaven časový filtr:', filter);
            loadAnalytics();
        }

        // Nastavení filtru prodejny
        function setStoreFilter(store) {
            currentStoreFilter = store;
            
            // Aktualizuj aktivní tlačítko
            document.querySelectorAll('.store-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Najdi a aktivuj správné tlačítko
            if (store === 'all') {
                const allBtn = document.querySelector('.store-filter[onclick*="all"]');
                if (allBtn) allBtn.classList.add('active');
            } else {
                const targetBtn = Array.from(document.querySelectorAll('.store-filter')).find(btn => 
                    btn.textContent.includes(store)
                );
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
            }
            
            console.log('🏪 Nastaven filtr prodejny:', store);
            loadAnalytics();
        }

        // Načtení analytických dat
        async function loadAnalytics() {
            if (!checkAdminAccess()) return;
            
            const contentDiv = document.getElementById('analyticsContent');
            contentDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner">⏳</div>
                    <p>Načítám analytické data...</p>
                </div>
            `;
            
            console.log(`📊 Načítám data s filtry: čas="${currentTimeFilter}", prodejna="${currentStoreFilter}"`);
            
            try {
                // Zkus načíst ze serveru - PRIMÁRNÍ zdroj dat
                console.log('🌐 Načítám data ze serveru...');
                const response = await fetch('/api/sales-data');
                
                if (response.ok) {
                    const serverData = await response.json();
                    console.log('🌐 Server response:', serverData);
                    
                    if (serverData.success && serverData.salesData && Array.isArray(serverData.salesData)) {
                        console.log(`🌐 Server vrátil ${serverData.salesData.length} sessions`);
                        console.log('🌐 Sample server data:', serverData.salesData.slice(0, 2));
                        
                        // Synchronizuj server data do localStorage pro konzistenci
                        localStorage.setItem('sales_sessions', JSON.stringify(serverData.salesData));
                        
                        // Filtruj server data podle filtrů
                        const filteredData = filterSalesData(serverData.salesData);
                        console.log(`🌐 Po filtrování: ${filteredData.length} sessions`);
                        
                        if (filteredData.length === 0) {
                            console.warn('⚠️ Server data po filtrování prázdná');
                            // Zkus bez filtrů
                            const unfilteredStats = generateLocalStats(serverData.salesData);
                            if (unfilteredStats) {
                                // Reset filtrů a zobraz warning
                                currentTimeFilter = 'all';
                                currentStoreFilter = 'all';
                                updateFilterButtons();
                                
                                contentDiv.innerHTML = `
                                    <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid #ff9800; border-radius: 10px; padding: 1rem; margin-bottom: 2rem;">
                                        <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">⚠️ Filtry resetovány</h4>
                                        <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">
                                            Aktivní filtry nevrátily žádná data ze serveru. Zobrazuji všechna data.
                                        </p>
                                    </div>
                                `;
                                
                                renderAnalytics(unfilteredStats);
                                return;
                            }
                        }
                        
                        const stats = generateLocalStats(filteredData);
                        if (stats) {
                            analyticsData = stats;
                            renderAnalytics(analyticsData);
                            
                            // Aktualizuj info o filtrování
                            updateFilterInfo(serverData.salesData.length, filteredData.length);
                            return;
                        }
                    } else {
                        console.warn('⚠️ Server nevrátil validní data:', serverData);
                    }
                } else {
                    console.warn('⚠️ Server error:', response.status, response.statusText);
                }
                
                // Fallback na localStorage data
                console.log('📱 Fallback na localStorage...');
                throw new Error('Server nedostupný');
                
            } catch (error) {
                console.warn('⚠️ Server nedostupný, načítám data z localStorage:', error.message);
                
                // Načti data z localStorage jako fallback
                try {
                    const localSalesData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                    console.log('📱 localStorage fallback:', localSalesData.length, 'sessions');
                    
                    if (localSalesData.length === 0) {
                        contentDiv.innerHTML = `
                            <div class="no-data">
                                <span class="no-data-emoji">📈</span>
                                <h3>Zatím žádná data</h3>
                                <p>Server není dostupný a v localStorage nejsou žádná data.</p>
                                <p>Jakmile prodejci začnou používat prodejní asistent, zde se zobrazí analytické údaje.</p>
                                <div style="margin-top: 1rem;">
                                    <button class="filter-btn" onclick="loadAnalytics()">🔄 Zkusit znovu</button>
                                    <button class="filter-btn" onclick="syncWithServer()">🌐 Sync se serverem</button>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Zpracuj localStorage data stejně jako server data
                    const filteredData = filterSalesData(localSalesData);
                    console.log(`📱 Po filtrování localStorage: ${filteredData.length} sessions`);
                    
                    if (filteredData.length === 0) {
                        console.warn('⚠️ localStorage data po filtrování prázdná');
                        // Zobraz všechna data bez filtrů
                        const unfilteredStats = generateLocalStats(localSalesData);
                        if (unfilteredStats) {
                            // Reset filtrů
                            currentTimeFilter = 'all';
                            currentStoreFilter = 'all';
                            updateFilterButtons();
                            
                            contentDiv.innerHTML = `
                                <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid #ff9800; border-radius: 10px; padding: 1rem; margin-bottom: 2rem;">
                                    <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">⚠️ Filtry resetovány (Offline)</h4>
                                    <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">
                                        Server není dostupný. Zobrazuji všechna localStorage data bez filtrů.
                                    </p>
                                </div>
                            `;
                            
                            renderAnalytics(unfilteredStats);
                            return;
                        }
                    }
                    
                    const stats = generateLocalStats(filteredData);
                    if (stats) {
                        analyticsData = stats;
                        
                        // Přidej info o offline režimu
                        contentDiv.innerHTML = `
                            <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid #ff9800; border-radius: 10px; padding: 1rem; margin-bottom: 2rem;">
                                <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">📱 Offline režim</h4>
                                <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">
                                    Server není dostupný. Zobrazuji data z localStorage.
                                </p>
                            </div>
                        `;
                        
                        renderAnalytics(analyticsData);
                        updateFilterInfo(localSalesData.length, filteredData.length);
                    } else {
                        contentDiv.innerHTML = `
                            <div class="no-data">
                                <span class="no-data-emoji">⚠️</span>
                                <h3>Chyba při zpracování dat</h3>
                                <p>Data jsou dostupná (${localSalesData.length} sessions), ale nelze je zpracovat.</p>
                                <div style="margin-top: 1rem;">
                                    <button class="filter-btn" onclick="debugLoadData()">🔍 Debug info</button>
                                    <button class="filter-btn" onclick="resetAllFilters()">🔄 Reset filtrů</button>
                                </div>
                            </div>
                        `;
                    }
                    
                } catch (localError) {
                    console.error('❌ Chyba při načítání localStorage:', localError);
                    contentDiv.innerHTML = `
                        <div class="no-data">
                            <span class="no-data-emoji">💥</span>
                            <h3>Kritická chyba</h3>
                            <p>Server není dostupný a nelze načíst ani localStorage data.</p>
                            <button class="filter-btn" onclick="location.reload()">🔄 Obnovit stránku</button>
                        </div>
                    `;
                }
            }
        }

        // Filtrování dat podle času a prodejny
        function filterSalesData(salesData) {
            console.log('🔍 Filtrování dat:', {
                inputData: salesData.length,
                timeFilter: currentTimeFilter,
                storeFilter: currentStoreFilter
            });
            
            const filtered = salesData.filter(session => {
                // Debug pro první session
                if (salesData.indexOf(session) === 0) {
                    console.log('🔍 Sample session struktura:', {
                        timestamp: session.timestamp,
                        store: session.store,
                        prodejna: session.prodejna,
                        seller: session.seller,
                        keys: Object.keys(session)
                    });
                }
                
                // Časový filtr
                if (currentTimeFilter !== 'all') {
                    const sessionDate = new Date(session.timestamp);
                    const now = new Date();
                    
                    if (!session.timestamp) {
                        console.warn('⚠️ Session bez timestamp:', session);
                        return false;
                    }
                    
                    switch(currentTimeFilter) {
                        case 'today':
                            if (sessionDate.toDateString() !== now.toDateString()) {
                                return false;
                            }
                            break;
                        case 'week':
                            const weekAgo = new Date(now);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            if (sessionDate < weekAgo) {
                                return false;
                            }
                            break;
                        case 'month':
                            const monthAgo = new Date(now);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            if (sessionDate < monthAgo) {
                                return false;
                            }
                            break;
                    }
                }
                
                // Filtr prodejny
                if (currentStoreFilter !== 'all') {
                    const sessionStore = session.store || session.prodejna || 'Neznámá prodejna';
                    if (sessionStore !== currentStoreFilter) {
                        return false;
                    }
                }
                
                return true;
            });
            
            console.log(`🔍 Výsledek filtrování: ${filtered.length} z ${salesData.length} sessions`);
            return filtered;
        }

        // Aktualizace informací o filtrování
        function updateFilterInfo(totalSessions, filteredSessions) {
            const filterInfo = document.getElementById('filter-info');
            if (filterInfo) {
                filterInfo.remove();
            }
            
            // Pouze pokud jsou nějaké filtry aktivní
            if (currentTimeFilter !== 'all' || currentStoreFilter !== 'all') {
                const analyticsContainer = document.querySelector('.analytics-container');
                const contentDiv = document.getElementById('analyticsContent');
                
                if (analyticsContainer && contentDiv) {
                    const infoDiv = document.createElement('div');
                    infoDiv.id = 'filter-info';
                    infoDiv.innerHTML = `
                        <div style="
                            background: rgba(33, 150, 243, 0.1); border: 1px solid #2196F3; 
                            border-radius: 10px; padding: 1rem; margin-bottom: 2rem; 
                            border-left: 4px solid #2196F3; text-align: center;
                        ">
                            <div style="color: #2196F3; font-weight: 600; margin-bottom: 0.5rem;">
                                📊 Aktivní filtry
                            </div>
                            <div style="color: var(--text-primary, #333); font-size: 0.9rem;">
                                📅 <strong>Období:</strong> ${getTimeFilterName()} | 
                                🏪 <strong>Prodejna:</strong> ${currentStoreFilter === 'all' ? 'Všechny' : currentStoreFilter}
                            </div>
                            <div style="color: var(--text-secondary, #666); font-size: 0.8rem; margin-top: 0.5rem;">
                                Zobrazuji ${filteredSessions} z ${totalSessions} celkových sessions
                            </div>
                        </div>
                    `;
                    
                    analyticsContainer.insertBefore(infoDiv, contentDiv);
                }
            }
        }

        // Název časového filtru pro zobrazení
        function getTimeFilterName() {
            switch(currentTimeFilter) {
                case 'all': return 'Všechna data';
                case 'today': return 'Dnes';
                case 'week': return 'Tento týden';
                case 'month': return 'Tento měsíc';
                default: return currentTimeFilter;
            }
        }

        // Aktualizace stavu tlačítek filtrů
        function updateFilterButtons() {
            // Aktualizuj časové filtry
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.store-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Aktivuj správná tlačítka
            const allTimeBtn = Array.from(document.querySelectorAll('.time-filter')).find(btn => 
                btn.textContent.includes('Všechna data')
            );
            if (allTimeBtn) allTimeBtn.classList.add('active');
            
            const allStoreBtn = Array.from(document.querySelectorAll('.store-filter')).find(btn => 
                btn.textContent.includes('Všechny prodejny')
            );
            if (allStoreBtn) allStoreBtn.classList.add('active');
        }
        
        // Generování statistik z lokálních dat
        function generateLocalStats(salesData) {
            console.log('🏭 Generuji statistiky z dat:', {
                inputLength: salesData.length,
                sampleData: salesData.slice(0, 2)
            });
            
            if (!salesData || salesData.length === 0) {
                console.warn('⚠️ Žádná data pro generování statistik!');
                return null;
            }
            
            const stats = {
                totalSessions: salesData.length,
                successfulSales: 0,
                unsuccessfulSales: 0,
                conversionRate: 0,
                topSellers: {},
                popularItems: {},
                discountUsage: { used: 0, notUsed: 0 },
                scenarioStats: {},
                storeStats: {},
                dailyStats: {},
                totalSessionTime: 0,
                sessionsWithTime: 0,
                averageSessionTime: 0
            };
            
            // Počítej základní statistiky
            salesData.forEach(session => {
                // Úspěšnost prodeje
                if (session.result === 'sold') {
                    stats.successfulSales++;
                    
                    // Populární položky
                    if (session.soldItems) {
                        session.soldItems.forEach(item => {
                            stats.popularItems[item] = (stats.popularItems[item] || 0) + 1;
                        });
                    }
                    
                    // Používání slevy
                    if (session.discountUsed === true) {
                        stats.discountUsage.used++;
                    } else if (session.discountUsed === false) {
                        stats.discountUsage.notUsed++;
                    }
                } else {
                    stats.unsuccessfulSales++;
                }
                
                // Časové statistiky
                if (session.sessionDurationMinutes && session.sessionDurationMinutes > 0) {
                    stats.totalSessionTime += session.sessionDurationMinutes;
                    stats.sessionsWithTime++;
                }
                
                // Top prodejci - normalizace jména
                let seller = session.seller || session.sellerId || 'Unknown';
                
                // Normalizace jmen - mapování celých jmen na usernames
                const nameMapping = {
                    'Tomáš Valenta': 'tvalenta',
                    'Admin Administrátor': 'admin',
                    'Šimon Gabriel': 'sgabriel',
                    // Přidej další mapování podle potřeby
                };
                
                // Pokud je seller celé jméno, převeď na username
                if (nameMapping[seller]) {
                    seller = nameMapping[seller];
                }
                
                // Načti custom jména z localStorage
                const customDisplayNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
                
                // Výchozí zobrazovací jména (fallback)
                const defaultDisplayNames = {
                    'tvalenta': 'Tomáš Valenta',
                    'admin': 'Admin Administrátor', 
                    'sgabriel': 'Šimon Gabriel',
                    'malek': 'Pavel Malek',  // Předpokládaná hodnota - změnit přes "👤 Správa jmen"
                };
                
                if (!stats.topSellers[seller]) {
                    // Vytvoř lepší zobrazovací jméno
                    let displayName = customDisplayNames[seller] || defaultDisplayNames[seller];
                    
                    if (!displayName) {
                        // Automatické generování lepšího zobrazení pro neznámé usernames
                        if (seller.length > 1) {
                            // Kapitalizuj první písmeno
                            displayName = seller.charAt(0).toUpperCase() + seller.slice(1);
                        } else {
                            displayName = seller;
                        }
                    }
                    
                    stats.topSellers[seller] = { 
                        total: 0, 
                        sold: 0, 
                        notSold: 0, 
                        totalTime: 0, 
                        avgTime: 0,
                        displayName: displayName,
                        username: seller  // Ulož i původní username
                    };
                }
                stats.topSellers[seller].total++;
                if (session.result === 'sold') {
                    stats.topSellers[seller].sold++;
                } else {
                    stats.topSellers[seller].notSold++;
                }
                
                // Čas pro prodejce
                if (session.sessionDurationMinutes && session.sessionDurationMinutes > 0) {
                    stats.topSellers[seller].totalTime += session.sessionDurationMinutes;
                }
                
                // Statistiky scénářů
                const scenario = session.scenario || 'unknown';
                if (!stats.scenarioStats[scenario]) {
                    stats.scenarioStats[scenario] = { total: 0, sold: 0, notSold: 0 };
                }
                stats.scenarioStats[scenario].total++;
                if (session.result === 'sold') {
                    stats.scenarioStats[scenario].sold++;
                } else {
                    stats.scenarioStats[scenario].notSold++;
                }
                
                // Statistiky prodejen
                const store = session.store || 'Unknown';
                if (!stats.storeStats[store]) {
                    stats.storeStats[store] = { total: 0, sold: 0, notSold: 0 };
                }
                stats.storeStats[store].total++;
                if (session.result === 'sold') {
                    stats.storeStats[store].sold++;
                } else {
                    stats.storeStats[store].notSold++;
                }
            });
            
            // Spočítej conversion rate
            if (stats.totalSessions > 0) {
                stats.conversionRate = ((stats.successfulSales / stats.totalSessions) * 100).toFixed(1);
            }
            
            // Spočítej průměrný čas session
            if (stats.sessionsWithTime > 0) {
                stats.averageSessionTime = (stats.totalSessionTime / stats.sessionsWithTime).toFixed(1);
            }
            
            // Spočítej průměrný čas pro každého prodejce
            Object.keys(stats.topSellers).forEach(seller => {
                if (stats.topSellers[seller].total > 0) {
                    stats.topSellers[seller].avgTime = (stats.topSellers[seller].totalTime / stats.topSellers[seller].total).toFixed(1);
                }
            });
            
            console.log('🏭 Statistiky vygenerovány:', {
                totalSessions: stats.totalSessions,
                successfulSales: stats.successfulSales,
                unsuccessfulSales: stats.unsuccessfulSales,
                conversionRate: stats.conversionRate,
                sellersCount: Object.keys(stats.topSellers).length,
                scenariosCount: Object.keys(stats.scenarioStats).length,
                storesCount: Object.keys(stats.storeStats).length,
                stats: stats
            });
            
            return stats;
        }

        // Renderování analytiky
        function renderAnalytics(stats) {
            console.log('🎨 Renderuji analytiku s daty:', stats);
            
            const contentDiv = document.getElementById('analyticsContent');
            if (!contentDiv) {
                console.error('❌ Element analyticsContent nenalezen!');
                return;
            }
            
            if (!stats) {
                console.error('❌ Žádná data pro renderování!');
                contentDiv.innerHTML = `
                    <div class="no-data">
                        <span class="no-data-emoji">⚠️</span>
                        <h3>Chyba při renderování</h3>
                        <p>Statistiky nebyly předány funkci renderAnalytics.</p>
                    </div>
                `;
                return;
            }
            
            if (stats.totalSessions === 0) {
                contentDiv.innerHTML = `
                    <div class="no-data">
                        <span class="no-data-emoji">📈</span>
                        <h3>Zatím žádná data</h3>
                        <p>Jakmile prodejci začnou používat prodejní asistent, zde se zobrazí analytické údaje.</p>
                    </div>
                `;
                return;
            }
            
            contentDiv.innerHTML = `
                <!-- Základní statistiky -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-emoji">📋</span>
                        <div class="stat-value">${stats.totalSessions}</div>
                        <div class="stat-label">Celkem rozhovorů</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">✅</span>
                        <div class="stat-value">${stats.successfulSales}</div>
                        <div class="stat-label">Úspěšných prodejů</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">❌</span>
                        <div class="stat-value">${stats.unsuccessfulSales}</div>
                        <div class="stat-label">Neúspěšných pokusů</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">📊</span>
                        <div class="stat-value">${stats.conversionRate}%</div>
                        <div class="stat-label">Úspěšnost prodeje</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">⏱️</span>
                        <div class="stat-value">${stats.averageSessionTime || '0'} min</div>
                        <div class="stat-label">Průměrný čas session</div>
                    </div>
                </div>

                <!-- Top prodejci -->
                <h2 class="section-title">🏆 Výkonnost prodejců</h2>
                <div class="chart-container">
                    ${renderSellersTable(stats.topSellers)}
                </div>

                <!-- Statistiky scénářů -->
                <h2 class="section-title">📱 Statistiky scénářů</h2>
                <div class="chart-container">
                    ${renderScenariosTable(stats.scenarioStats)}
                </div>

                <!-- Populární položky -->
                ${stats.popularItems && Object.keys(stats.popularItems).length > 0 ? `
                <h2 class="section-title">🛍️ Nejprodávanější položky</h2>
                <div class="chart-container">
                    ${renderPopularItems(stats.popularItems)}
                </div>
                ` : ''}

                <!-- Statistiky prodejen -->
                ${stats.storeStats && Object.keys(stats.storeStats).length > 0 ? `
                <h2 class="section-title">🏪 Výkonnost prodejen</h2>
                <div class="chart-container">
                    ${renderStoresTable(stats.storeStats)}
                </div>
                ` : ''}

                <!-- Používání slevy -->
                ${stats.discountUsage.used > 0 || stats.discountUsage.notUsed > 0 ? `
                <h2 class="section-title">💰 Používání slev</h2>
                <div class="chart-container">
                    ${renderDiscountUsage(stats.discountUsage)}
                </div>
                ` : ''}
            `;
            
            console.log('🎨 Renderování analytiky dokončeno úspěšně');
        }

        // Tabulka prodejců
        function renderSellersTable(topSellers) {
            if (!topSellers || Object.keys(topSellers).length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">Žádní prodejci zatím nezaznamenali data.</p>';
            }
            
            const sellers = Object.entries(topSellers)
                .map(([username, stats]) => ({
                    username,
                    displayName: stats.displayName || username,
                    ...stats,
                    successRate: stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.sold - a.sold);
            
            return `
                <table class="seller-table">
                    <thead>
                        <tr>
                            <th>Prodejce</th>
                            <th>Celkem</th>
                            <th>Prodáno</th>
                            <th>Neprodáno</th>
                            <th>Úspěšnost</th>
                            <th>Ø Čas</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sellers.map(seller => `
                            <tr>
                                <td><strong>${seller.displayName}</strong></td>
                                <td>${seller.total}</td>
                                <td style="color: #2ed573;">${seller.sold}</td>
                                <td style="color: #ff4757;">${seller.notSold}</td>
                                <td>
                                    ${seller.successRate}%
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${seller.successRate}%"></div>
                                    </div>
                                </td>
                                <td style="color: var(--text-secondary);">${seller.avgTime || '0'} min</td>
                                <td>
                                    <button onclick="showSellerDetails('${seller.username}')" style="
                                        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                                        color: white; border: none; padding: 0.4rem 0.8rem; 
                                        border-radius: 6px; cursor: pointer; font-size: 0.8rem;
                                        font-weight: 500; transition: all 0.3s ease; white-space: nowrap;
                                    " onmouseover="this.style.transform='translateY(-1px)'" 
                                       onmouseout="this.style.transform='translateY(0px)'">
                                        👤 Detaily
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Tabulka prodejen
        function renderStoresTable(storeStats) {
            if (!storeStats || Object.keys(storeStats).length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">Žádné prodejny zatím nezaznamenaly data.</p>';
            }
            
            const stores = Object.entries(storeStats)
                .map(([name, stats]) => ({
                    name,
                    ...stats,
                    successRate: stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.total - a.total);
            
            return `
                <table class="scenario-table">
                    <thead>
                        <tr>
                            <th>Prodejna</th>
                            <th>Celkem</th>
                            <th>Prodáno</th>
                            <th>Neprodáno</th>
                            <th>Úspěšnost</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stores.map(store => `
                            <tr>
                                <td><strong>🏪 ${store.name}</strong></td>
                                <td>${store.total}</td>
                                <td style="color: #2ed573;">${store.sold}</td>
                                <td style="color: #ff4757;">${store.notSold}</td>
                                <td>
                                    ${store.successRate}%
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${store.successRate}%"></div>
                                    </div>
                                </td>
                                <td>
                                    <button onclick="showStoreDetails('${store.name}')" style="
                                        background: linear-gradient(135deg, #2ed573 0%, #20bf6b 100%);
                                        color: white; border: none; padding: 0.4rem 0.8rem; 
                                        border-radius: 6px; cursor: pointer; font-size: 0.8rem;
                                        font-weight: 500; transition: all 0.3s ease; white-space: nowrap;
                                    " onmouseover="this.style.transform='translateY(-1px)'" 
                                       onmouseout="this.style.transform='translateY(0px)'">
                                        🏪 Detaily
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Tabulka scénářů
        function renderScenariosTable(scenarioStats) {
            if (!scenarioStats || Object.keys(scenarioStats).length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">Žádné scénáře zatím nebyly použity.</p>';
            }
            
            const scenarios = Object.entries(scenarioStats)
                .map(([name, stats]) => ({
                    name,
                    ...stats,
                    successRate: stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.total - a.total);
            
            const scenarioNames = {
                'zasilkovna': '📦 Zásilkovna',
                'prislusenstvi': '🔌 Příslušenství',
                'novy-telefon': '📱 Nový telefon',
                'vykup': '💰 Výkup',
                'jen-se-kouka': '👀 Jen se kouká',
                'konzultace': '💬 Konzultace',
                'servis': '🔧 Servis'
            };
            
            return `
                <table class="scenario-table">
                    <thead>
                        <tr>
                            <th>Scénář</th>
                            <th>Celkem</th>
                            <th>Prodáno</th>
                            <th>Neprodáno</th>
                            <th>Úspěšnost</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scenarios.map(scenario => `
                            <tr>
                                <td><strong>${scenarioNames[scenario.name] || scenario.name}</strong></td>
                                <td>${scenario.total}</td>
                                <td style="color: #2ed573;">${scenario.sold}</td>
                                <td style="color: #ff4757;">${scenario.notSold}</td>
                                <td>
                                    ${scenario.successRate}%
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${scenario.successRate}%"></div>
                                    </div>
                                </td>
                                <td>
                                    <button onclick="showScenarioDetails('${scenario.name}')" style="
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        color: white; border: none; padding: 0.4rem 0.8rem; 
                                        border-radius: 6px; cursor: pointer; font-size: 0.8rem;
                                        font-weight: 500; transition: all 0.3s ease; white-space: nowrap;
                                    " onmouseover="this.style.transform='translateY(-1px)'" 
                                       onmouseout="this.style.transform='translateY(0px)'">
                                        🔍 Detaily
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Populární položky
        function renderPopularItems(popularItems) {
            const items = Object.entries(popularItems)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            const total = Object.values(popularItems).reduce((sum, count) => sum + count, 0);
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    ${items.map(([item, count]) => {
                        const percentage = ((count / total) * 100).toFixed(1);
                        return `
                            <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 10px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary-color);">${count}</div>
                                <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 0.5rem;">${item}</div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">${percentage}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Používání slev
        function renderDiscountUsage(discountUsage) {
            const total = discountUsage.used + discountUsage.notUsed;
            const usedPercentage = total > 0 ? ((discountUsage.used / total) * 100).toFixed(1) : 0;
            const notUsedPercentage = total > 0 ? ((discountUsage.notUsed / total) * 100).toFixed(1) : 0;
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                    <div style="text-align: center; padding: 2rem; background: rgba(46, 213, 115, 0.1); border-radius: 15px;">
                        <div style="font-size: 3rem; color: #2ed573; margin-bottom: 1rem;">${discountUsage.used}</div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Sleva použita</div>
                        <div style="color: var(--text-secondary);">${usedPercentage}% případů</div>
                    </div>
                    
                    <div style="text-align: center; padding: 2rem; background: rgba(255, 71, 87, 0.1); border-radius: 15px;">
                        <div style="font-size: 3rem; color: #ff4757; margin-bottom: 1rem;">${discountUsage.notUsed}</div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Sleva nepoužita</div>
                        <div style="color: var(--text-secondary);">${notUsedPercentage}% případů</div>
                    </div>
                </div>
            `;
        }

        // Debug funkce
        function debugLoadData() {
            console.log('🔍 DEBUG: Kontroluji localStorage...');
            console.log('🔍 Aktuální filtry:', {
                časový: currentTimeFilter,
                prodejna: currentStoreFilter
            });
            
            const localData = localStorage.getItem('sales_sessions');
            console.log('🔍 Raw localStorage data:', localData);
            
            try {
                const parsed = JSON.parse(localData || '[]');
                console.log('🔍 Parsed data:', parsed);
                console.log('🔍 Počet sessions:', parsed.length);
                
                if (parsed.length > 0) {
                    console.log('🔍 První session:', parsed[0]);
                    console.log('🔍 Poslední session:', parsed[parsed.length - 1]);
                    
                    // Analýza prodejců
                    const sellers = new Set();
                    parsed.forEach(session => {
                        const seller = session.seller || session.sellerId || 'Unknown';
                        sellers.add(seller);
                    });
                    console.log('🔍 Unikátní prodejci v datech:', Array.from(sellers));
                    
                    // Zkontroluj duplicity
                    const sellerCounts = {};
                    parsed.forEach(session => {
                        const seller = session.seller || session.sellerId || 'Unknown';
                        sellerCounts[seller] = (sellerCounts[seller] || 0) + 1;
                    });
                    console.log('🔍 Počty sessions podle prodejců:', sellerCounts);
                    
                    // Detekce možných duplicit
                    const possibleDuplicates = [];
                    const checkPairs = [
                        ['Tomáš Valenta', 'tvalenta'],
                        ['Admin Administrátor', 'admin'],
                        ['Šimon Gabriel', 'sgabriel']
                    ];
                    
                    checkPairs.forEach(([fullName, username]) => {
                        if (sellerCounts[fullName] && sellerCounts[username]) {
                            possibleDuplicates.push({
                                fullName,
                                username,
                                fullNameCount: sellerCounts[fullName],
                                usernameCount: sellerCounts[username],
                                total: sellerCounts[fullName] + sellerCounts[username]
                            });
                        }
                    });
                    
                    if (possibleDuplicates.length > 0) {
                        console.warn('⚠️ NALEZENY DUPLICITNÍ PRODEJCI:');
                        possibleDuplicates.forEach(dup => {
                            console.warn(`   👤 ${dup.fullName} (${dup.fullNameCount}) + ${dup.username} (${dup.usernameCount}) = ${dup.total} sessions`);
                        });
                        console.warn('💡 Použijte tlačítko "🔧 Opravit duplicity" pro sloučení');
                    } else {
                        console.log('✅ Žádné duplicitní prodejci nenalezeni');
                    }
                }
            } catch (e) {
                console.error('🔍 Chyba při parsování:', e);
            }
            
            // Načti prodejny znovu a vynutí načtení
            loadAvailableStores();
            loadAnalytics();
        }

        // Správa jmen prodejců
        function showSellerNameManager() {
            // Načti aktuální prodejce z dat
            const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
            const sellers = new Set();
            
            localData.forEach(session => {
                const seller = session.seller || session.sellerId || 'Unknown';
                if (seller && seller !== 'Unknown') {
                    sellers.add(seller);
                }
            });
            
            const sellerList = Array.from(sellers).sort();
            console.log('👤 Nalezení prodejci:', sellerList);
            
            // Načti aktuální mapování jmen z localStorage
            const customDisplayNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #ffffff); border-radius: 15px; padding: 2rem; 
                    max-width: 600px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 80vh; overflow-y: auto;
                ">
                    <h3 style="color: var(--text-primary, #333); margin: 0 0 1.5rem 0; text-align: center;">
                        👤 Správa jmen prodejců
                    </h3>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(108, 92, 231, 0.1); border-radius: 8px; border-left: 4px solid #6c5ce7;">
                        <h4 style="color: #6c5ce7; margin: 0 0 0.5rem 0; font-size: 0.9rem;">ℹ️ Jak to funguje</h4>
                        <p style="margin: 0; color: var(--text-primary); font-size: 0.85rem; line-height: 1.4;">
                            Zde můžete nastavit zobrazovací jména pro prodejce. Změny se projeví okamžitě v analytice.
                        </p>
                    </div>
                    
                    <div id="seller-name-list" style="margin-bottom: 2rem;">
                        ${sellerList.map(seller => {
                            const currentDisplayName = customDisplayNames[seller] || getDefaultDisplayName(seller);
                            return `
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <div style="flex: 1;">
                                        <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Username:</div>
                                        <div style="color: var(--text-primary); font-weight: 500; font-family: monospace;">${seller}</div>
                                    </div>
                                    <div style="flex: 2;">
                                        <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Zobrazované jméno:</div>
                                        <input type="text" 
                                               value="${currentDisplayName}" 
                                               data-seller="${seller}"
                                               style="width: 100%; padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; background: rgba(255,255,255,0.1); color: var(--text-primary);"
                                               placeholder="Zadejte celé jméno">
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="closeSellerNameManager()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary, #333); 
                            border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; 
                            border-radius: 8px; cursor: pointer; font-weight: 500;
                        ">Zrušit</button>
                        
                        <button onclick="saveSellerNames()" style="
                            background: #6c5ce7; color: white; border: none; 
                            padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;
                        ">💾 Uložit změny</button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            modal.id = 'seller-name-modal';
            document.body.appendChild(modal);
            
            // Zavření na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Získání výchozího zobrazovacího jména
        function getDefaultDisplayName(seller) {
            // Načti custom jména nejdříve
            const customDisplayNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
            if (customDisplayNames[seller]) {
                return customDisplayNames[seller];
            }
            
                         // Fallback na výchozí jména
            const defaultDisplayNames = {
                'tvalenta': 'Tomáš Valenta',
                'admin': 'Admin Administrátor', 
                'sgabriel': 'Šimon Gabriel',
                'malek': 'Pavel Malek',  // Předpokládaná hodnota - změnit přes "👤 Správa jmen"
            };
            
            return defaultDisplayNames[seller] || (seller.charAt(0).toUpperCase() + seller.slice(1));
        }

        // Zavření správce jmen
        function closeSellerNameManager() {
            const modal = document.getElementById('seller-name-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Uložení jmen prodejců
        function saveSellerNames() {
            const inputs = document.querySelectorAll('#seller-name-list input[data-seller]');
            const customDisplayNames = {};
            
            inputs.forEach(input => {
                const seller = input.dataset.seller;
                const displayName = input.value.trim();
                if (displayName && displayName !== getDefaultDisplayName(seller)) {
                    customDisplayNames[seller] = displayName;
                }
            });
            
            // Ulož do localStorage
            localStorage.setItem('seller_display_names', JSON.stringify(customDisplayNames));
            
            console.log('👤 Uložená jména prodejců:', customDisplayNames);
            
            // Zavři modal
            closeSellerNameManager();
            
            // Refresh analytiky
            loadAnalytics();
            
            alert(`✅ Jména prodejců byla uložena!\n\nChanges saved: ${Object.keys(customDisplayNames).length} custom names`);
        }

        // Force delete všech dat
        function forceDeleteAllData() {
            if (!confirm('💥 VYMAZAT VŠECHNA DATA\n\nToto OKAMŽITĚ smaže:\n• Všechna localStorage data\n• Custom jména prodejců\n• Aktivuje Local Mode (ignoruje server)\n\nTato akce je NEVRATNÁ!\n\nOpravdu pokračovat?')) {
                return;
            }
            
            if (!confirm('🔴 FINÁLNÍ POTVRZENÍ\n\nPo kliknutí na OK budou VŠECHNA LOKÁLNÍ DATA SMAZÁNA a server bude IGNOROVÁN!\n\nJste si 100% jisti?')) {
                return;
            }
            
            console.log('💥 Force delete všech dat...');
            
            // Smaž kompletně localStorage
            localStorage.setItem('sales_sessions', '[]');
            localStorage.removeItem('seller_display_names');
            
            // Aktivuj Local Mode
            localStorage.setItem('force_local_mode', 'true');
            localStorage.setItem('local_mode_reason', 'Manuálně vymazáno uživatelem - ignoruji server data');
            
            console.log('💥 Všechna data smazána, Local Mode aktivován');
            
            // Refresh celé stránky
            alert('✅ VŠECHNA DATA BYLA SMAZÁNA!\n\nAktivován Local Mode - server se ignoruje.\nStránka se obnoví s prázdnými daty.');
            
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // Deaktivace Local Mode
        function deactivateLocalMode() {
            if (confirm('Opravdu chcete deaktivovat Local Mode?\n\nAnalytika se přepne zpět na server data.')) {
                localStorage.removeItem('force_local_mode');
                localStorage.removeItem('local_mode_reason');
                console.log('🌐 Local Mode deaktivován');
                
                // Refresh analytiky
                loadAnalytics();
                
                alert('✅ Local Mode deaktivován\n\nAnalytika nyní používá server data.');
            }
        }

        // Toggle pokročilých nástrojů
        function toggleAdminTools() {
            const content = document.getElementById('admin-tools-content');
            const arrow = document.getElementById('admin-tools-arrow');
            const toggle = document.getElementById('admin-tools-toggle');
            
            if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
                // Otevři
                content.style.maxHeight = '200px';
                arrow.style.transform = 'rotate(180deg)';
                toggle.style.background = 'rgba(255,255,255,0.15)';
                toggle.style.color = 'var(--text-primary)';
            } else {
                // Zavři
                content.style.maxHeight = '0px';
                arrow.style.transform = 'rotate(0deg)';
                toggle.style.background = 'rgba(255,255,255,0.1)';
                toggle.style.color = 'var(--text-secondary)';
            }
        }

        // Reset všech filtrů
        function resetAllFilters() {
            console.log('🔄 Resetuji všechny filtry...');
            
            // Reset filtrů
            currentTimeFilter = 'all';
            currentStoreFilter = 'all';
            
            // Aktivuj správná tlačítka
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.store-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Aktivuj "Všechna data"
            const allTimeBtn = Array.from(document.querySelectorAll('.time-filter')).find(btn => 
                btn.textContent.includes('Všechna data')
            );
            if (allTimeBtn) allTimeBtn.classList.add('active');
            
            // Aktivuj "Všechny prodejny"
            const allStoreBtn = Array.from(document.querySelectorAll('.store-filter')).find(btn => 
                btn.textContent.includes('Všechny prodejny')
            );
            if (allStoreBtn) allStoreBtn.classList.add('active');
            
            // Načti data
            loadAnalytics();
        }

        // Nová funkce pro normalizaci existujících dat
        function cleanDuplicateSellerData() {
            if (!confirm('Opravdu chcete normalizovat jména prodejců v existujících datech?\n\nToto sloučí duplicitní záznamy pro stejné prodejce.')) {
                return;
            }
            
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                
                // Mapování pro normalizaci jmen
                const nameMapping = {
                    'Tomáš Valenta': 'tvalenta',
                    'Admin Administrátor': 'admin',
                    'Šimon Gabriel': 'sgabriel',
                };
                
                let changedCount = 0;
                
                // Projdi všechny sessions a normalizuj jména
                localData.forEach(session => {
                    const originalSeller = session.seller || session.sellerId;
                    
                    if (nameMapping[originalSeller]) {
                        // Aktualizuj seller i sellerId
                        session.seller = nameMapping[originalSeller];
                        session.sellerId = nameMapping[originalSeller];
                        changedCount++;
                        console.log(`✅ Normalizováno: "${originalSeller}" → "${nameMapping[originalSeller]}"`);
                    }
                });
                
                // Ulož opravená data
                localStorage.setItem('sales_sessions', JSON.stringify(localData));
                
                console.log(`🔧 Normalizace dokončena! Změněno ${changedCount} záznamů.`);
                
                if (changedCount > 0) {
                    alert(`✅ Normalizace dokončena!\n\nZměněno ${changedCount} záznamů.\n\nDuplicité prodejci (např. "Tomáš Valenta" + "tvalenta") jsou nyní sloučeni pod jednotným jménem.\n\nAnalytika se automaticky obnoví.`);
                } else {
                    alert('ℹ️ Žádné duplicity k opravě nebyly nalezeny.\n\nData jsou již v pořádku.');
                }
                
                // Aktualizuj seznam prodejen a refresh analytiky
                loadAvailableStores();
                loadAnalytics();
                
            } catch (error) {
                console.error('❌ Chyba při normalizaci dat:', error);
                alert('❌ Chyba při normalizaci dat!');
            }
        }

        // Test serveru
        async function testServerConnection() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '⏳ Testuji...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/sales-data?type=stats');
                
                if (response.ok) {
                    btn.textContent = '✅ Server OK';
                    btn.style.background = '#2ed573';
                    console.log('✅ Server je dostupný');
                    
                    const data = await response.json();
                    console.log('📊 Server data:', data);
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
            } catch (error) {
                btn.textContent = '❌ Server nedostupný';
                btn.style.background = '#ff4757';
                console.error('❌ Server test failed:', error);
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '#2ed573';
            }, 3000);
        }

        // Reset server dat
        async function resetServerData() {
            if (!confirm('⚠️ POZOR: Reset serveru\n\nToto KOMPLETNĚ SMAŽE všechna data na serveru!\n\nTato akce je NEVRATNÁ!\n\nOpravdu chcete pokračovat?')) {
                return;
            }
            
            if (!confirm('🔴 FINÁLNÍ POTVRZENÍ\n\nPo kliknutí na OK budou VŠECHNA DATA NA SERVERU SMAZÁNA!\n\nTuto akci NELZE vzít zpět!\n\nJste si jisti?')) {
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '🔥 Mažu server...';
            btn.disabled = true;
            btn.style.background = '#e74c3c';
            
            try {
                console.log('🌐 Resetuji server data...');
                
                // Nejdřív načti všechna data ze serveru
                const response = await fetch('/api/sales-data');
                
                if (!response.ok) {
                    throw new Error(`Nelze načíst data ze serveru: ${response.status}`);
                }
                
                const serverData = await response.json();
                
                if (!serverData.success || !serverData.salesData) {
                    throw new Error('Server nevrátil validní data');
                }
                
                const allSessions = serverData.salesData;
                console.log(`🗑️ Mažu ${allSessions.length} sessions ze serveru...`);
                
                let deletedCount = 0;
                let errorCount = 0;
                
                // Smaž všechny sessions jedna po druhé
                for (const session of allSessions) {
                    try {
                        const sessionId = session.id || session.timestamp;
                        const deleteResponse = await fetch(`/api/sales-data?id=${encodeURIComponent(sessionId)}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        if (deleteResponse.ok) {
                            deletedCount++;
                            btn.textContent = `🔥 Mažu server (${deletedCount}/${allSessions.length})`;
                        } else {
                            errorCount++;
                            console.warn(`⚠️ Nepodařilo se smazat session ${sessionId}`);
                        }
                    } catch (deleteError) {
                        errorCount++;
                        console.warn('⚠️ Chyba při mazání session:', deleteError);
                    }
                }
                
                console.log(`✅ Server reset dokončen: ${deletedCount} smazáno, ${errorCount} chyb`);
                
                // Kompletně smaž všechny lokální data
                localStorage.setItem('sales_sessions', '[]');
                localStorage.removeItem('seller_display_names');
                console.log('✅ localStorage kompletně vymazán');
                
                if (errorCount === 0) {
                    btn.textContent = '✅ Kompletní reset';
                    btn.style.background = '#2ed573';
                    
                    setTimeout(() => {
                        alert(`✅ Server i localStorage byly kompletně resetovány!\n\nSmazáno ${deletedCount} sessions.\n\nStránka se obnoví.`);
                        location.reload();
                    }, 1000);
                } else {
                    btn.textContent = `⚠️ Reset s ${errorCount} chybami`;
                    btn.style.background = '#ff9500';
                    
                    setTimeout(() => {
                        alert(`⚠️ Reset dokončen s chybami!\n\nSmazáno: ${deletedCount}/${allSessions.length} sessions\nChyby: ${errorCount}\n\nStránka se obnoví.`);
                        location.reload();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('❌ Reset server failed:', error);
                btn.textContent = '❌ Reset selhal';
                btn.style.background = '#ff4757';
                
                const forceLocal = confirm('❌ Nepodařilo se resetovat server!\n\nServer může být offline nebo nepodporuje reset endpoint.\n\nChcete smazat pouze lokální data a aktivovat Local Mode?');
                
                if (forceLocal) {
                    // Smaž lokální data
                    localStorage.setItem('sales_sessions', '[]');
                    localStorage.removeItem('seller_display_names');
                    
                    // Aktivuj Local Mode
                    localStorage.setItem('force_local_mode', 'true');
                    localStorage.setItem('local_mode_reason', 'Server nepodporuje reset - pracuji pouze lokálně');
                    
                    btn.textContent = '✅ Local reset';
                    btn.style.background = '#ff9500';
                    
                    // Refresh analytiky
                    loadAvailableStores();
                    loadAnalytics();
                    
                    alert('✅ Lokální data byla smazána!\n\nAktivován Local Mode - analytika používá pouze localStorage.');
                }
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '#e74c3c';
            }, 5000);
        }

        // Synchronizace se serverem
        async function syncWithServer() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '⏳ Synchronizuji...';
            btn.disabled = true;
            
            try {
                // Načti data ze serveru
                const response = await fetch('/api/sales-data');
                
                if (response.ok) {
                    const serverData = await response.json();
                    
                    if (serverData.success && serverData.salesData) {
                        // Ulož server data do localStorage
                        localStorage.setItem('sales_sessions', JSON.stringify(serverData.salesData));
                        console.log('✅ Data synchronizována ze serveru:', serverData.salesData.length, 'sessions');
                        
                        btn.textContent = '✅ Synchronizováno';
                        btn.style.background = '#2ed573';
                        
                        // Deaktivuj Local Mode pokud je aktivní
                        if (localStorage.getItem('force_local_mode') === 'true') {
                            localStorage.removeItem('force_local_mode');
                            localStorage.removeItem('local_mode_reason');
                            console.log('🌐 Local Mode automaticky deaktivován po úspěšné synchronizaci');
                        }
                        
                        // Aktualizuj seznam prodejen a refresh analytiky
                        loadAvailableStores();
                        loadAnalytics();
                    } else {
                        throw new Error('Server nevrátil validní data');
                    }
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
            } catch (error) {
                console.error('❌ Sync failed:', error);
                
                // Zkus poslat lokální data na server
                try {
                    const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                    if (localData.length > 0) {
                        console.log('📤 Posílám lokální data na server...');
                        
                        for (const session of localData) {
                            await fetch('/api/sales-data', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(session)
                            });
                        }
                        
                        btn.textContent = '✅ Lokální → Server';
                        btn.style.background = '#2ed573';
                    } else {
                        throw error;
                    }
                } catch (uploadError) {
                    btn.textContent = '❌ Sync selhal';
                    btn.style.background = '#ff4757';
                }
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '#ff9500';
            }, 3000);
        }

        // Modal pro smazání dat
        function showDeleteDataModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 1rem;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #ffffff); border-radius: 15px; padding: 2rem; 
                    max-width: 500px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                ">
                    <h3 style="color: var(--text-primary, #333); margin: 0 0 1.5rem 0; text-align: center;">
                        🗑️ Smazat prodejní data
                    </h3>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-color, #ff1493); margin-bottom: 1rem;">Vyberte období:</h4>
                        
                        <div style="display: block;">
                            <div class="radio-option" data-value="today" style="
                                display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
                                padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; 
                                margin-bottom: 0.75rem; border: 2px solid transparent; transition: all 0.3s ease;
                            ">
                                <div class="radio-circle" style="
                                    width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
                                    position: relative; background: white;
                                ">
                                    <div class="radio-dot" style="
                                        width: 8px; height: 8px; background: #ff1493; border-radius: 50%; 
                                        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                        opacity: 0; transition: opacity 0.3s ease;
                                    "></div>
                                </div>
                                <span style="color: var(--text-primary, #333); font-weight: 500;">Pouze dnešní data</span>
                            </div>
                            
                            <div class="radio-option" data-value="week" style="
                                display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
                                padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; 
                                margin-bottom: 0.75rem; border: 2px solid transparent; transition: all 0.3s ease;
                            ">
                                <div class="radio-circle" style="
                                    width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
                                    position: relative; background: white;
                                ">
                                    <div class="radio-dot" style="
                                        width: 8px; height: 8px; background: #ff1493; border-radius: 50%; 
                                        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                        opacity: 0; transition: opacity 0.3s ease;
                                    "></div>
                                </div>
                                <span style="color: var(--text-primary, #333); font-weight: 500;">Tento týden</span>
                            </div>
                            
                            <div class="radio-option" data-value="month" style="
                                display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
                                padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; 
                                margin-bottom: 0.75rem; border: 2px solid transparent; transition: all 0.3s ease;
                            ">
                                <div class="radio-circle" style="
                                    width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
                                    position: relative; background: white;
                                ">
                                    <div class="radio-dot" style="
                                        width: 8px; height: 8px; background: #ff1493; border-radius: 50%; 
                                        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                        opacity: 0; transition: opacity 0.3s ease;
                                    "></div>
                                </div>
                                <span style="color: var(--text-primary, #333); font-weight: 500;">Tento měsíc</span>
                            </div>
                            
                            <div class="radio-option" data-value="all" style="
                                display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
                                padding: 1rem; background: rgba(255,71,87,0.1); border-radius: 8px; 
                                border: 2px solid rgba(255,71,87,0.3); transition: all 0.3s ease;
                            ">
                                <div class="radio-circle" style="
                                    width: 18px; height: 18px; border: 2px solid #ff4757; border-radius: 50%; 
                                    position: relative; background: white;
                                ">
                                    <div class="radio-dot" style="
                                        width: 8px; height: 8px; background: #ff4757; border-radius: 50%; 
                                        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                        opacity: 0; transition: opacity 0.3s ease;
                                    "></div>
                                </div>
                                <span style="color: #ff4757; font-weight: 600;">⚠️ Všechna data (POZOR!)</span>
                            </div>
                        </div>
                        
                        <div id="selected-info" style="
                            margin-top: 1rem; padding: 0.75rem; background: rgba(33, 150, 243, 0.1); 
                            border-radius: 8px; border-left: 4px solid #2196F3; display: none;
                        ">
                            <span style="color: #2196F3; font-weight: 500;">📋 Vybráno: </span>
                            <span id="selected-text" style="color: var(--text-primary, #333);"></span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="closeDeleteModal()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary, #333); 
                            border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; 
                            border-radius: 8px; cursor: pointer; font-weight: 500;
                        ">Zrušit</button>
                        
                        <button id="confirm-delete-btn" onclick="confirmDeleteData(this)" style="
                            background: #cccccc; color: #666666; border: none; 
                            padding: 0.75rem 1.5rem; border-radius: 8px; cursor: not-allowed; font-weight: 600;
                        " disabled>🗑️ Smazat</button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            modal.id = 'delete-modal';
            document.body.appendChild(modal);
            
            // Přidej event listenery pro radio buttony
            const radioOptions = modal.querySelectorAll('.radio-option');
            let selectedValue = null;
            
                         radioOptions.forEach(option => {
                 // Hover efekt
                 option.addEventListener('mouseenter', function() {
                     if (selectedValue !== this.dataset.value) {
                         this.style.background = this.dataset.value === 'all' 
                             ? 'rgba(255,71,87,0.15)' 
                             : 'rgba(255,255,255,0.1)';
                     }
                 });
                 
                 option.addEventListener('mouseleave', function() {
                     if (selectedValue !== this.dataset.value) {
                         this.style.background = this.dataset.value === 'all' 
                             ? 'rgba(255,71,87,0.1)' 
                             : 'rgba(255,255,255,0.05)';
                     }
                 });
                 
                 option.addEventListener('click', function() {
                    // Odznač všechny ostatní
                    radioOptions.forEach(opt => {
                        opt.style.borderColor = 'transparent';
                        opt.style.background = opt.dataset.value === 'all' 
                            ? 'rgba(255,71,87,0.1)' 
                            : 'rgba(255,255,255,0.05)';
                        const dot = opt.querySelector('.radio-dot');
                        if (dot) dot.style.opacity = '0';
                    });
                    
                    // Označ aktuální
                    this.style.borderColor = this.dataset.value === 'all' ? '#ff4757' : '#2196F3';
                    this.style.background = this.dataset.value === 'all' 
                        ? 'rgba(255,71,87,0.2)' 
                        : 'rgba(33, 150, 243, 0.1)';
                    const dot = this.querySelector('.radio-dot');
                    if (dot) dot.style.opacity = '1';
                    
                    selectedValue = this.dataset.value;
                    
                    // Aktualizuj info a tlačítko
                    const infoDiv = modal.querySelector('#selected-info');
                    const textSpan = modal.querySelector('#selected-text');
                    const deleteBtn = modal.querySelector('#confirm-delete-btn');
                    
                    const optionTexts = {
                        today: 'Pouze dnešní data',
                        week: 'Tento týden',
                        month: 'Tento měsíc',
                        all: 'VŠECHNA DATA (POZOR!)'
                    };
                    
                    if (infoDiv && textSpan && deleteBtn) {
                        infoDiv.style.display = 'block';
                        textSpan.textContent = optionTexts[selectedValue];
                        
                        deleteBtn.disabled = false;
                        deleteBtn.style.cursor = 'pointer';
                        deleteBtn.style.background = '#ff4757';
                        deleteBtn.style.color = 'white';
                    }
                    
                    console.log('🎯 Vybráno:', selectedValue);
                });
            });
            
            // Zavření na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            // Ulož selected value pro pozdější použití
            modal.selectedValue = null;
            modal.getSelectedValue = () => selectedValue;
        }

        // Zavření delete modalu
        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Potvrzení smazání dat
        async function confirmDeleteData(btn) {
            const modal = document.getElementById('delete-modal');
            const selectedValue = modal ? modal.getSelectedValue() : null;
            
            console.log('🗑️ Attempting delete with selection:', selectedValue);
            
            if (!selectedValue) {
                alert('Prosím vyberte období pro smazání.');
                return;
            }
            
            const period = selectedValue;
            const periodNames = {
                today: 'dnešní data',
                week: 'data z tohoto týdne',
                month: 'data z tohoto měsíce',
                all: 'VŠECHNA DATA'
            };
            
            if (!confirm(`Opravdu chcete smazat ${periodNames[period]}?\n\nTato akce je nevratná!`)) {
                return;
            }
            
            btn.textContent = '⏳ Mazání...';
            btn.disabled = true;
            
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                let filteredData = [...localData];
                const now = new Date();
                
                // Filtruj podle období
                if (period !== 'all') {
                    filteredData = localData.filter(session => {
                        const sessionDate = new Date(session.timestamp);
                        
                        switch(period) {
                            case 'today':
                                return sessionDate.toDateString() !== now.toDateString();
                            case 'week':
                                const weekAgo = new Date(now);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                return sessionDate < weekAgo;
                            case 'month':
                                const monthAgo = new Date(now);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                return sessionDate < monthAgo;
                            default:
                                return true;
                        }
                    });
                } else {
                    filteredData = [];
                }
                
                const deletedCount = localData.length - filteredData.length;
                
                // 1. Ulož filtrovaná data lokálně
                localStorage.setItem('sales_sessions', JSON.stringify(filteredData));
                
                // Pokud mažeme všechna data, vymaž i další lokální věci
                if (period === 'all' && filteredData.length === 0) {
                    localStorage.removeItem('seller_display_names');
                    console.log('🗑️ Smazána i custom jména prodejců');
                }
                
                console.log(`🗑️ Lokálně smazáno: ${deletedCount} sessions`);
                console.log(`📊 Lokálně zůstává: ${filteredData.length} sessions`);
                
                // 2. Synchronizuj se serverem - skutečné mazání přes server API
                btn.textContent = '🌐 Sync se serverem...';
                
                try {
                    console.log('🌐 Mažu data na serveru pomocí správného API...');
                    
                    // Najdi sessions k smazání (ty co nejsou ve filteredData)
                    const sessionsToDelete = localData.filter(session => {
                        return !filteredData.some(kept => 
                            kept.id === session.id || 
                            (kept.timestamp === session.timestamp && kept.seller === session.seller)
                        );
                    });
                    
                    console.log('🗑️ Mažu', sessionsToDelete.length, 'sessions na serveru');
                    
                    let serverDeletedCount = 0;
                    let serverErrors = 0;
                    
                    // Maž sessions pomocí správného server API
                    for (const session of sessionsToDelete) {
                        try {
                            // Použij ID session nebo timestamp jako fallback
                            const sessionId = session.id || session.timestamp;
                            
                            const deleteResponse = await fetch(`/api/sales-data?id=${encodeURIComponent(sessionId)}`, {
                                method: 'DELETE',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            
                            if (deleteResponse.ok) {
                                serverDeletedCount++;
                                console.log(`✅ Smazána session ${sessionId}`);
                            } else {
                                serverErrors++;
                                console.warn(`⚠️ Nepodařilo se smazat session ${sessionId}:`, deleteResponse.status);
                            }
                        } catch (deleteError) {
                            serverErrors++;
                            console.warn('⚠️ Chyba při mazání session:', deleteError);
                        }
                    }
                    
                    // Zobraz výsledek mazání
                    if (serverDeletedCount === sessionsToDelete.length) {
                        btn.textContent = '✅ Smazáno + Server OK';
                        btn.style.background = '#2ed573';
                        console.log(`✅ Všechny sessions úspěšně smazány na serveru (${serverDeletedCount})`);
                    } else if (serverDeletedCount > 0) {
                        btn.textContent = `⚠️ Částečně smazáno (${serverDeletedCount}/${sessionsToDelete.length})`;
                        btn.style.background = '#ff9500';
                        console.log(`⚠️ Částečně úspěšné mazání: ${serverDeletedCount} úspěšných, ${serverErrors} chyb`);
                    } else {
                        btn.textContent = '❌ Server mazání selhalo';
                        btn.style.background = '#ff4757';
                        console.log(`❌ Mazání na serveru selhalo: ${serverErrors} chyb`);
                    }
                    
                } catch (serverError) {
                    console.error('❌ Server sync error:', serverError);
                    btn.textContent = '⚠️ Server error - data smazána lokálně';
                    btn.style.background = '#ff9500';
                    
                    // Pokus o obnovu synchronizace
                    setTimeout(() => {
                        const retry = confirm(`⚠️ PROBLÉM S MAZÁNÍM NA SERVERU\n\nData byla smazána lokálně, ale server má problém.\n\nMožnosti:\n✅ OK = Zkusit znovu načíst ze serveru (může obnovu data)\n❌ Cancel = Ponechat lokální změny\n\nChcete obnovit data ze serveru?`);
                        
                        if (retry) {
                            // Obnov data ze serveru
                            console.log('🔄 Obnovuji data ze serveru...');
                            loadAnalytics();
                        } else {
                            console.log('📱 Ponechávám lokální změny');
                            alert('ℹ️ Data zůstávají smazána lokálně.\n\nPokud chcete synchronizovat se serverem, použijte "🔄 Sync se serverem".');
                        }
                    }, 1000);
                }
                
                // 3. Aktualizuj UI
                loadAvailableStores();
                loadAnalytics();
                
                // Zavři modal
                closeDeleteModal();
                
                // Zobraz výsledek
                setTimeout(() => {
                    alert(`✅ Úspěšně smazáno ${deletedCount} záznamů!\n\n${filteredData.length} záznamů zůstává.`);
                }, 500);
                
            } catch (error) {
                console.error('❌ Chyba při mazání:', error);
                btn.textContent = '❌ Chyba při mazání';
                btn.style.background = '#ff4757';
                alert('❌ Chyba při mazání dat!');
            }
        }

        // Zobrazení statusu ukládání dat
        function showDataStatus() {
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                const customNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
                const statusDiv = document.getElementById('storage-info');
                
                if (statusDiv) {
                    const statusHTML = `
                        <div style="display: grid; gap: 0.5rem;">
                            <div>💾 <strong>Lokální úložiště:</strong> ${localData.length} sessions + ${Object.keys(customNames).length} custom jmen</div>
                            <div>🌐 <strong>Server:</strong> <span id="server-status">Testuji...</span></div>
                            <div>📊 <strong>Zdroj dat:</strong> <span id="data-source">Zjišťuji...</span></div>
                            <div>🔄 <strong>Synchronizace:</strong> <span id="sync-status">Automatická při uložení</span></div>
                            <div style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--text-secondary);">
                                ✅ Data jsou primárně načítána ze serveru, localStorage slouží jako záloha
                            </div>
                        </div>
                    `;
                    statusDiv.innerHTML = statusHTML;
                    
                    // Test server status a zjisti zdroj dat
                    checkDataSource();
                }
            } catch (error) {
                console.error('Chyba při zobrazování statusu dat:', error);
            }
        }

        // Zjištění zdroje dat
        async function checkDataSource() {
            const dataSourceElement = document.getElementById('data-source');
            const serverStatusElement = document.getElementById('server-status');
            
            // Kontrola Local Mode
            const forceLocalMode = localStorage.getItem('force_local_mode') === 'true';
            const localModeReason = localStorage.getItem('local_mode_reason') || 'Neznámý důvod';
            
            if (forceLocalMode) {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                
                if (serverStatusElement) {
                    serverStatusElement.innerHTML = '<span style="color: #ff9500;">📱 Ignorováno (Local Mode)</span>';
                }
                if (dataSourceElement) {
                    dataSourceElement.innerHTML = `<span style="color: #ff9500;">📱 Local Mode (${localData.length} sessions)</span>`;
                }
                return;
            }
            
            try {
                const response = await fetch('/api/sales-data', { 
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    const serverData = await response.json();
                    const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                    
                    if (serverStatusElement) {
                        serverStatusElement.innerHTML = '<span style="color: #2ed573;">✅ Připojen a funkční</span>';
                    }
                    
                    if (dataSourceElement) {
                        if (serverData.success && serverData.salesData) {
                            const serverCount = serverData.salesData.length;
                            const localCount = localData.length;
                            
                            if (serverCount === 0 && localCount === 0) {
                                dataSourceElement.innerHTML = '<span style="color: #ff9500;">🔍 Žádná data (server ani local)</span>';
                            } else if (serverCount > 0) {
                                dataSourceElement.innerHTML = `<span style="color: #2ed573;">🌐 Server (${serverCount} sessions)</span>`;
                            } else {
                                dataSourceElement.innerHTML = `<span style="color: #ff9500;">💾 Local fallback (${localCount} sessions)</span>`;
                            }
                        } else {
                            dataSourceElement.innerHTML = '<span style="color: #ff4757;">❌ Server nevrátil validní data</span>';
                        }
                    }
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                if (serverStatusElement) {
                    serverStatusElement.innerHTML = '<span style="color: #ff9500;">⚠️ Offline (data v localStorage)</span>';
                }
                if (dataSourceElement) {
                    const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                    dataSourceElement.innerHTML = `<span style="color: #ff9500;">💾 Local fallback (${localData.length} sessions)</span>`;
                }
            }
        }



        // Funkce pro kontrolu duplicit při startu
        function checkForDuplicates() {
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                if (localData.length === 0) return;
                
                const sellerCounts = {};
                localData.forEach(session => {
                    const seller = session.seller || session.sellerId || 'Unknown';
                    sellerCounts[seller] = (sellerCounts[seller] || 0) + 1;
                });
                
                const checkPairs = [
                    ['Tomáš Valenta', 'tvalenta'],
                    ['Admin Administrátor', 'admin'],
                    ['Šimon Gabriel', 'sgabriel']
                ];
                
                const duplicates = [];
                checkPairs.forEach(([fullName, username]) => {
                    if (sellerCounts[fullName] && sellerCounts[username]) {
                        duplicates.push({ fullName, username });
                    }
                });
                
                if (duplicates.length > 0) {
                    // Zobraz upozornění o duplicitách
                    const analyticsContainer = document.querySelector('.analytics-container');
                    if (analyticsContainer) {
                        const warningDiv = document.createElement('div');
                        warningDiv.innerHTML = `
                            <div style="
                                background: rgba(255, 152, 0, 0.1); border: 1px solid #ff9800; 
                                border-radius: 10px; padding: 1rem; margin-bottom: 2rem; 
                                border-left: 4px solid #ff9800;
                            ">
                                <h4 style="color: #ff9800; margin: 0 0 0.5rem 0; font-size: 1rem;">
                                    ⚠️ Nalezeny duplicitní prodejci
                                </h4>
                                <p style="color: var(--text-primary); margin: 0 0 1rem 0; font-size: 0.9rem;">
                                    V datech se našli duplicitní záznamy pro stejné prodejce. To způsobuje rozdělení statistik.
                                </p>
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                    <button onclick="cleanDuplicateSellerData()" style="
                                        background: #8e44ad; color: white; border: none; 
                                        padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; 
                                        font-size: 0.9rem; font-weight: 500;
                                    ">🔧 Opravit automaticky</button>
                                    <button onclick="this.closest('div').style.display='none'" style="
                                        background: rgba(255,255,255,0.1); color: var(--text-primary); 
                                        border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; 
                                        border-radius: 6px; cursor: pointer; font-size: 0.9rem;
                                    ">Zavřít upozornění</button>
                                </div>
                            </div>
                        `;
                        
                        const filterSection = document.querySelector('.filter-section');
                        if (filterSection) {
                            analyticsContainer.insertBefore(warningDiv, filterSection);
                        }
                    }
                    
                    console.warn('⚠️ Nalezeny duplicitní prodejci při startu aplikace');
                }
            } catch (error) {
                console.error('Chyba při kontrole duplicit:', error);
            }
        }

        // Zobrazení detailů scénáře
        function showScenarioDetails(scenarioName) {
            console.log('🔍 Zobrazuji detaily pro scénář:', scenarioName);
            
            try {
                // Načti všechna sales data (stejná logika jako v loadAnalytics)
                const localSalesData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                
                // Filtruj data podle aktuálních filtrů + scenarioName
                const filteredData = localSalesData.filter(session => {
                    // Filtr scénáře
                    const sessionScenario = session.scenario || 'unknown';
                    if (sessionScenario !== scenarioName) return false;
                    
                    // Časový filtr
                    if (currentTimeFilter !== 'all') {
                        const sessionDate = new Date(session.timestamp);
                        const now = new Date();
                        
                        if (!session.timestamp) return false;
                        
                        switch(currentTimeFilter) {
                            case 'today':
                                if (sessionDate.toDateString() !== now.toDateString()) return false;
                                break;
                            case 'week':
                                const weekAgo = new Date(now);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                if (sessionDate < weekAgo) return false;
                                break;
                            case 'month':
                                const monthAgo = new Date(now);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                if (sessionDate < monthAgo) return false;
                                break;
                        }
                    }
                    
                    // Filtr prodejny
                    if (currentStoreFilter !== 'all') {
                        const sessionStore = session.store || session.prodejna || 'Neznámá prodejna';
                        if (sessionStore !== currentStoreFilter) return false;
                    }
                    
                    return true;
                });
                
                console.log(`🔍 Nalezeno ${filteredData.length} sessions pro scénář ${scenarioName}`);
                
                if (filteredData.length === 0) {
                    alert(`Žádné sessions pro scénář "${scenarioName}" nebyly nalezeny s aktuálními filtry.`);
                    return;
                }
                
                // Seřaď sessions podle času (nejnovější první)
                filteredData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Vytvoř modal
                showScenarioModal(scenarioName, filteredData);
                
            } catch (error) {
                console.error('❌ Chyba při načítání detailů scénáře:', error);
                alert('Chyba při načítání detailů scénáře!');
            }
        }

        // Modal s detaily scénáře  
        function showScenarioModal(scenarioName, sessions) {
            const scenarioNames = {
                'zasilkovna': '📦 Zásilkovna',
                'prislusenstvi': '🔌 Příslušenství',
                'novy-telefon': '📱 Nový telefon',
                'vykup': '💰 Výkup',
                'jen-se-kouka': '👀 Jen se kouká',
                'konzultace': '💬 Konzultace',
                'servis': '🔧 Servis'
            };
            
            const displayName = scenarioNames[scenarioName] || scenarioName;
            
            // Statistiky
            const soldSessions = sessions.filter(s => s.result === 'sold');
            const notSoldSessions = sessions.filter(s => s.result !== 'sold');
            const successRate = sessions.length > 0 ? ((soldSessions.length / sessions.length) * 100).toFixed(1) : 0;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.85); z-index: 10000; display: flex; 
                align-items: flex-start; justify-content: center; padding: 2rem 1rem; 
                overflow-y: auto; padding-top: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #ffffff); border-radius: 15px; padding: 2rem; 
                    max-width: 1200px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 20px 60px rgba(0,0,0,0.7); max-height: 90vh; overflow-y: auto;
                    position: relative;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--text-primary, #333); margin: 0; font-size: 1.8rem;">
                            ${displayName} - Detailní přehled
                        </h2>
                        <button onclick="closeScenarioModal()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary); 
                            border: 1px solid rgba(255,255,255,0.2); width: 40px; height: 40px;
                            border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold;
                            display: flex; align-items: center; justify-content: center;
                        ">✕</button>
                    </div>
                    
                    <!-- Rychlé statistiky -->
                    <div style="
                        display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                        gap: 1rem; margin-bottom: 2rem; padding: 1.5rem; 
                        background: rgba(255,255,255,0.03); border-radius: 12px;
                        border: 1px solid rgba(255,255,255,0.1);
                    ">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color, #ff1493);">${sessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Celkem sessions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #2ed573;">${soldSessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Úspěšných</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #ff4757;">${notSoldSessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Neúspěšných</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary, #333);">${successRate}%</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Úspěšnost</div>
                        </div>
                    </div>
                    
                    <!-- Filtry pro zobrazení -->
                    <div style="margin-bottom: 2rem; text-align: center;">
                        <div style="display: inline-flex; gap: 0.5rem; background: rgba(255,255,255,0.05); 
                                    border-radius: 25px; padding: 0.3rem; border: 1px solid rgba(255,255,255,0.1);">
                            <button id="show-all-sessions" onclick="filterSessionView('all')" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
                                border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">📋 Všechny (${sessions.length})</button>
                            <button id="show-sold-sessions" onclick="filterSessionView('sold')" style="
                                background: transparent; color: var(--text-primary); border: none; 
                                padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">✅ Úspěšné (${soldSessions.length})</button>
                            <button id="show-failed-sessions" onclick="filterSessionView('failed')" style="
                                background: transparent; color: var(--text-primary); border: none; 
                                padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">❌ Neúspěšné (${notSoldSessions.length})</button>
                        </div>
                    </div>
                    
                    <!-- Sessions seznam -->
                    <div id="sessions-container">
                        ${renderSessionsList(sessions, 'all')}
                    </div>
                </div>
            `;
            
            modal.className = 'scenario-modal';
            modal.id = 'scenario-detail-modal';
            document.body.appendChild(modal);
            
            // Uložit sessions data pro filtrování
            window.currentModalSessions = sessions;
            
            // Zavření na ESC
            document.addEventListener('keydown', handleModalKeydown);
            
            // Zavření na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeScenarioModal();
            });
        }

        // Renderování seznamu sessions
        function renderSessionsList(sessions, filter) {
            let filteredSessions = sessions;
            
            if (filter === 'sold') {
                filteredSessions = sessions.filter(s => s.result === 'sold');
            } else if (filter === 'failed') {
                filteredSessions = sessions.filter(s => s.result !== 'sold');
            }
            
            if (filteredSessions.length === 0) {
                return `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">📭</div>
                        <h3>Žádné sessions</h3>
                        <p>Pro aktuální filtr nebyly nalezeny žádné sessions.</p>
                    </div>
                `;
            }
            
            return `
                <div style="display: grid; gap: 1rem;">
                    ${filteredSessions.map(session => renderSessionCard(session)).join('')}
                </div>
            `;
        }

        // Renderování karty jedné session
        function renderSessionCard(session) {
            const isSuccess = session.result === 'sold';
            const seller = session.seller || session.sellerId || 'Neznámý';
            const displayName = getSellerDisplayName(seller);
            const timestamp = new Date(session.timestamp).toLocaleString('cs-CZ');
            const store = session.store || session.prodejna || 'Neznámá prodejna';
            
            // Získej důvod neúspěchu z různých možných fieldů
            const reason = getSessionReason(session);
            const lastStep = getSessionLastStep(session);
            const soldItems = session.soldItems || [];
            const discountUsed = session.discountUsed;
            
            return `
                <div style="
                    background: ${isSuccess ? 'rgba(46, 213, 115, 0.1)' : 'rgba(255, 71, 87, 0.1)'}; 
                    border: 1px solid ${isSuccess ? 'rgba(46, 213, 115, 0.3)' : 'rgba(255, 71, 87, 0.3)'};
                    border-left: 4px solid ${isSuccess ? '#2ed573' : '#ff4757'};
                    border-radius: 10px; padding: 1.5rem; position: relative;
                ">
                    <!-- Header s výsledkem -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <div style="
                                display: inline-flex; align-items: center; gap: 0.5rem; 
                                background: ${isSuccess ? '#2ed573' : '#ff4757'}; 
                                color: white; padding: 0.3rem 0.8rem; border-radius: 15px; 
                                font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem;
                            ">
                                ${isSuccess ? '✅ PRODÁNO' : '❌ NEPRODÁNO'}
                            </div>
                            <div style="color: var(--text-primary); font-weight: 600; font-size: 1rem;">
                                👤 ${displayName}
                            </div>
                        </div>
                        <div style="text-align: right; color: var(--text-secondary); font-size: 0.8rem;">
                            <div>🕒 ${timestamp}</div>
                            <div>🏪 ${store}</div>
                        </div>
                    </div>
                    
                    <!-- Detaily session -->
                    <div style="display: grid; gap: 1rem;">
                        ${lastStep ? `
                            <div style="
                                background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;
                                border-left: 3px solid var(--primary-color, #ff1493);
                            ">
                                <div style="color: var(--primary-color, #ff1493); font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    📍 POSLEDNÍ KROK
                                </div>
                                <div style="color: var(--text-primary); font-size: 0.95rem;">
                                    ${lastStep}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${reason ? `
                            <div style="
                                background: rgba(255, 152, 0, 0.1); padding: 1rem; border-radius: 8px;
                                border-left: 3px solid #ff9800;
                            ">
                                <div style="color: #ff9800; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    💭 DŮVOD / POZNÁMKA
                                </div>
                                <div style="color: var(--text-primary); font-style: italic; font-size: 0.95rem;">
                                    "${reason}"
                                </div>
                            </div>
                        ` : ''}
                        
                        ${isSuccess && soldItems.length > 0 ? `
                            <div style="
                                background: rgba(46, 213, 115, 0.1); padding: 1rem; border-radius: 8px;
                                border-left: 3px solid #2ed573;
                            ">
                                <div style="color: #2ed573; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    🛍️ PRODANÉ POLOŽKY
                                </div>
                                <div style="color: var(--text-primary); font-size: 0.95rem;">
                                    ${soldItems.map(item => `• ${item}`).join('<br>')}
                                </div>
                                ${discountUsed !== undefined ? `
                                    <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                                        💰 Sleva: ${discountUsed ? '✅ Použita' : '❌ Nepoužita'}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- Debug info (skládací) -->
                        <div style="margin-top: 0.5rem;">
                            <button onclick="toggleSessionDebug('${session.timestamp}')" style="
                                background: rgba(255,255,255,0.05); color: var(--text-secondary); 
                                border: 1px solid rgba(255,255,255,0.1); padding: 0.3rem 0.6rem; 
                                border-radius: 15px; cursor: pointer; font-size: 0.75rem;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                               onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                                🔧 Technical details
                            </button>
                            <div id="debug-${session.timestamp}" style="
                                display: none; margin-top: 0.5rem; padding: 0.75rem; 
                                background: rgba(0,0,0,0.2); border-radius: 6px; 
                                font-family: monospace; font-size: 0.7rem; 
                                color: var(--text-secondary); max-height: 150px; overflow-y: auto;
                            ">
                                ${JSON.stringify(session, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Získání důvodu z session (z různých možných fieldů)
        function getSessionReason(session) {
            // Zkus různé možné fieldy pro důvod
            const possibleReasons = [
                session.reason,
                session.noDoprodejReason,
                session.zakaznikNechceReason,
                session.nevhodnyReason,
                session.nedostatekCasuReason,
                session.jizyReason,
                session.pocitReason,
                session.cenaReason,
                session.customReason
            ].filter(reason => reason && reason.trim() !== '');
            
            return possibleReasons.length > 0 ? possibleReasons[0] : null;
        }

        // Získání posledního kroku session
        function getSessionLastStep(session) {
            // Zkus různé možné fieldy pro krok
            if (session.lastStep) return session.lastStep;
            if (session.currentStep) return session.currentStep;
            if (session.step) return session.step;
            
            // Dedukuj z dalších fielů
            if (session.phoneOnlyWithReason) return 'Pouze telefon prodán (bez příslušenství)';
            if (session.zakaznikNechce) return 'Zákazník nakonec nechce';
            if (session.scenario) return `Scénář: ${session.scenario}`;
            
            return null;
        }

        // Získání zobrazovacího jména prodejce
        function getSellerDisplayName(seller) {
            const customDisplayNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
            if (customDisplayNames[seller]) return customDisplayNames[seller];
            
            const defaultDisplayNames = {
                'tvalenta': 'Tomáš Valenta',
                'admin': 'Admin Administrátor', 
                'sgabriel': 'Šimon Gabriel',
                'malek': 'Pavel Malek',
            };
            
            return defaultDisplayNames[seller] || (seller.charAt(0).toUpperCase() + seller.slice(1));
        }

        // Toggle debug informace pro session
        function toggleSessionDebug(timestamp) {
            const debugDiv = document.getElementById(`debug-${timestamp}`);
            if (debugDiv) {
                debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Filtrování view v modalu
        function filterSessionView(filter) {
            const container = document.getElementById('sessions-container');
            const sessions = window.currentModalSessions;
            
            if (container && sessions) {
                container.innerHTML = renderSessionsList(sessions, filter);
                
                // Aktualizuj aktivní tlačítko
                document.querySelectorAll('#scenario-detail-modal button[onclick^="filterSessionView"]').forEach(btn => {
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-primary)';
                });
                
                const activeButton = document.getElementById(
                    filter === 'all' ? 'show-all-sessions' : 
                    filter === 'sold' ? 'show-sold-sessions' : 'show-failed-sessions'
                );
                
                if (activeButton) {
                    activeButton.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    activeButton.style.color = 'white';
                }
            }
        }

        // Zavření modal s detaily scénáře
        function closeScenarioModal() {
            const modal = document.getElementById('scenario-detail-modal');
            if (modal) {
                modal.remove();
                delete window.currentModalSessions;
                document.removeEventListener('keydown', handleModalKeydown);
            }
        }

        // Obsluha ESC klávesy pro zavření modalu
        function handleModalKeydown(e) {
            if (e.key === 'Escape') {
                closeScenarioModal();
                closeSellerModal();
                closeStoreModal();
            }
        }

        // Zobrazení detailů prodejce
        function showSellerDetails(sellerUsername) {
            console.log('👤 Zobrazuji detaily pro prodejce:', sellerUsername);
            
            try {
                const localSalesData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                
                // Filtruj data podle aktuálních filtrů + prodejce
                const filteredData = localSalesData.filter(session => {
                    // Filtr prodejce
                    const sessionSeller = session.seller || session.sellerId || 'Unknown';
                    if (sessionSeller !== sellerUsername) return false;
                    
                    // Časový filtr
                    if (currentTimeFilter !== 'all') {
                        const sessionDate = new Date(session.timestamp);
                        const now = new Date();
                        
                        if (!session.timestamp) return false;
                        
                        switch(currentTimeFilter) {
                            case 'today':
                                if (sessionDate.toDateString() !== now.toDateString()) return false;
                                break;
                            case 'week':
                                const weekAgo = new Date(now);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                if (sessionDate < weekAgo) return false;
                                break;
                            case 'month':
                                const monthAgo = new Date(now);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                if (sessionDate < monthAgo) return false;
                                break;
                        }
                    }
                    
                    // Filtr prodejny
                    if (currentStoreFilter !== 'all') {
                        const sessionStore = session.store || session.prodejna || 'Neznámá prodejna';
                        if (sessionStore !== currentStoreFilter) return false;
                    }
                    
                    return true;
                });
                
                console.log(`👤 Nalezeno ${filteredData.length} sessions pro prodejce ${sellerUsername}`);
                
                if (filteredData.length === 0) {
                    alert(`Žádné sessions pro prodejce "${sellerUsername}" nebyly nalezeny s aktuálními filtry.`);
                    return;
                }
                
                // Seřaď sessions podle času (nejnovější první)
                filteredData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Vytvoř modal
                showSellerModal(sellerUsername, filteredData);
                
            } catch (error) {
                console.error('❌ Chyba při načítání detailů prodejce:', error);
                alert('Chyba při načítání detailů prodejce!');
            }
        }

        // Modal s detaily prodejce
        function showSellerModal(sellerUsername, sessions) {
            const displayName = getSellerDisplayName(sellerUsername);
            
            // Statistiky
            const soldSessions = sessions.filter(s => s.result === 'sold');
            const notSoldSessions = sessions.filter(s => s.result !== 'sold');
            const successRate = sessions.length > 0 ? ((soldSessions.length / sessions.length) * 100).toFixed(1) : 0;
            
            // Statistiky podle scénářů
            const scenarioStats = {};
            sessions.forEach(session => {
                const scenario = session.scenario || 'unknown';
                if (!scenarioStats[scenario]) {
                    scenarioStats[scenario] = { total: 0, sold: 0, notSold: 0 };
                }
                scenarioStats[scenario].total++;
                if (session.result === 'sold') {
                    scenarioStats[scenario].sold++;
                } else {
                    scenarioStats[scenario].notSold++;
                }
            });
            
            // Statistiky podle prodejen
            const storeStats = {};
            sessions.forEach(session => {
                const store = session.store || session.prodejna || 'Neznámá prodejna';
                if (!storeStats[store]) {
                    storeStats[store] = { total: 0, sold: 0, notSold: 0 };
                }
                storeStats[store].total++;
                if (session.result === 'sold') {
                    storeStats[store].sold++;
                } else {
                    storeStats[store].notSold++;
                }
            });
            
            // Průměrný čas session
            const sessionsWithTime = sessions.filter(s => s.sessionDurationMinutes && s.sessionDurationMinutes > 0);
            const avgTime = sessionsWithTime.length > 0 
                ? (sessionsWithTime.reduce((sum, s) => sum + s.sessionDurationMinutes, 0) / sessionsWithTime.length).toFixed(1)
                : 0;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.85); z-index: 10000; display: flex; 
                align-items: flex-start; justify-content: center; padding: 2rem 1rem; 
                overflow-y: auto; padding-top: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #ffffff); border-radius: 15px; padding: 2rem; 
                    max-width: 1200px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 20px 60px rgba(0,0,0,0.7); max-height: 90vh; overflow-y: auto;
                    position: relative;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--text-primary, #333); margin: 0; font-size: 1.8rem;">
                            👤 ${displayName} - Detailní přehled
                        </h2>
                        <button onclick="closeSellerModal()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary); 
                            border: 1px solid rgba(255,255,255,0.2); width: 40px; height: 40px;
                            border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold;
                            display: flex; align-items: center; justify-content: center;
                        ">✕</button>
                    </div>
                    
                    <!-- Rychlé statistiky -->
                    <div style="
                        display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
                        gap: 1rem; margin-bottom: 2rem; padding: 1.5rem; 
                        background: rgba(255,255,255,0.03); border-radius: 12px;
                        border: 1px solid rgba(255,255,255,0.1);
                    ">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color, #ff1493);">${sessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Celkem sessions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #2ed573;">${soldSessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Úspěšných</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #ff4757;">${notSoldSessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Neúspěšných</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary, #333);">${successRate}%</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Úspěšnost</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #ff9500;">${avgTime}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Ø Čas (min)</div>
                        </div>
                    </div>
                    
                    <!-- Statistiky podle scénářů a prodejen -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                            <h4 style="color: var(--primary-color, #ff1493); margin: 0 0 1rem 0;">📱 Podle scénářů</h4>
                            ${Object.entries(scenarioStats).map(([scenario, stats]) => {
                                const scenarioNames = {
                                    'zasilkovna': '📦 Zásilkovna',
                                    'prislusenstvi': '🔌 Příslušenství',
                                    'novy-telefon': '📱 Nový telefon',
                                    'vykup': '💰 Výkup',
                                    'jen-se-kouka': '👀 Jen se kouká',
                                    'konzultace': '💬 Konzultace',
                                    'servis': '🔧 Servis'
                                };
                                const displayName = scenarioNames[scenario] || scenario;
                                const rate = stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(0) : 0;
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                        <span style="color: var(--text-primary); font-size: 0.9rem;">${displayName}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.8rem;">${stats.sold}/${stats.total} (${rate}%)</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                            <h4 style="color: var(--primary-color, #ff1493); margin: 0 0 1rem 0;">🏪 Podle prodejen</h4>
                            ${Object.entries(storeStats).map(([store, stats]) => {
                                const rate = stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(0) : 0;
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                        <span style="color: var(--text-primary); font-size: 0.9rem;">🏪 ${store}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.8rem;">${stats.sold}/${stats.total} (${rate}%)</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Filtry pro zobrazení -->
                    <div style="margin-bottom: 2rem; text-align: center;">
                        <div style="display: inline-flex; gap: 0.5rem; background: rgba(255,255,255,0.05); 
                                    border-radius: 25px; padding: 0.3rem; border: 1px solid rgba(255,255,255,0.1);">
                            <button id="show-all-seller-sessions" onclick="filterSellerSessionView('all')" style="
                                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; 
                                border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">📋 Všechny (${sessions.length})</button>
                            <button id="show-sold-seller-sessions" onclick="filterSellerSessionView('sold')" style="
                                background: transparent; color: var(--text-primary); border: none; 
                                padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">✅ Úspěšné (${soldSessions.length})</button>
                            <button id="show-failed-seller-sessions" onclick="filterSellerSessionView('failed')" style="
                                background: transparent; color: var(--text-primary); border: none; 
                                padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">❌ Neúspěšné (${notSoldSessions.length})</button>
                        </div>
                    </div>
                    
                    <!-- Sessions seznam -->
                    <div id="seller-sessions-container">
                        ${renderSessionsList(sessions, 'all')}
                    </div>
                </div>
            `;
            
            modal.className = 'seller-modal';
            modal.id = 'seller-detail-modal';
            document.body.appendChild(modal);
            
            // Uložit sessions data pro filtrování
            window.currentSellerModalSessions = sessions;
            
            // Zavření na ESC
            document.addEventListener('keydown', handleModalKeydown);
            
            // Zavření na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeSellerModal();
            });
        }

        // Filtrování view v seller modalu
        function filterSellerSessionView(filter) {
            const container = document.getElementById('seller-sessions-container');
            const sessions = window.currentSellerModalSessions;
            
            if (container && sessions) {
                container.innerHTML = renderSessionsList(sessions, filter);
                
                // Aktualizuj aktivní tlačítko
                document.querySelectorAll('#seller-detail-modal button[onclick^="filterSellerSessionView"]').forEach(btn => {
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-primary)';
                });
                
                const activeButton = document.getElementById(
                    filter === 'all' ? 'show-all-seller-sessions' : 
                    filter === 'sold' ? 'show-sold-seller-sessions' : 'show-failed-seller-sessions'
                );
                
                if (activeButton) {
                    activeButton.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
                    activeButton.style.color = 'white';
                }
            }
        }

        // Zavření modal s detaily prodejce
        function closeSellerModal() {
            const modal = document.getElementById('seller-detail-modal');
            if (modal) {
                modal.remove();
                delete window.currentSellerModalSessions;
                document.removeEventListener('keydown', handleModalKeydown);
            }
        }

        // Zobrazení detailů prodejny
        function showStoreDetails(storeName) {
            console.log('🏪 Zobrazuji detaily pro prodejnu:', storeName);
            
            try {
                const localSalesData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                
                // Filtruj data podle aktuálních filtrů + prodejny
                const filteredData = localSalesData.filter(session => {
                    // Filtr prodejny
                    const sessionStore = session.store || session.prodejna || 'Neznámá prodejna';
                    if (sessionStore !== storeName) return false;
                    
                    // Časový filtr
                    if (currentTimeFilter !== 'all') {
                        const sessionDate = new Date(session.timestamp);
                        const now = new Date();
                        
                        if (!session.timestamp) return false;
                        
                        switch(currentTimeFilter) {
                            case 'today':
                                if (sessionDate.toDateString() !== now.toDateString()) return false;
                                break;
                            case 'week':
                                const weekAgo = new Date(now);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                if (sessionDate < weekAgo) return false;
                                break;
                            case 'month':
                                const monthAgo = new Date(now);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                if (sessionDate < monthAgo) return false;
                                break;
                        }
                    }
                    
                    return true;
                });
                
                console.log(`🏪 Nalezeno ${filteredData.length} sessions pro prodejnu ${storeName}`);
                
                if (filteredData.length === 0) {
                    alert(`Žádné sessions pro prodejnu "${storeName}" nebyly nalezeny s aktuálními filtry.`);
                    return;
                }
                
                // Seřaď sessions podle času (nejnovější první)
                filteredData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Vytvoř modal
                showStoreModal(storeName, filteredData);
                
            } catch (error) {
                console.error('❌ Chyba při načítání detailů prodejny:', error);
                alert('Chyba při načítání detailů prodejny!');
            }
        }

        // Modal s detaily prodejny
        function showStoreModal(storeName, sessions) {
            // Statistiky
            const soldSessions = sessions.filter(s => s.result === 'sold');
            const notSoldSessions = sessions.filter(s => s.result !== 'sold');
            const successRate = sessions.length > 0 ? ((soldSessions.length / sessions.length) * 100).toFixed(1) : 0;
            
            // Statistiky podle prodejců
            const sellerStats = {};
            sessions.forEach(session => {
                const seller = session.seller || session.sellerId || 'Unknown';
                if (!sellerStats[seller]) {
                    sellerStats[seller] = { total: 0, sold: 0, notSold: 0 };
                }
                sellerStats[seller].total++;
                if (session.result === 'sold') {
                    sellerStats[seller].sold++;
                } else {
                    sellerStats[seller].notSold++;
                }
            });
            
            // Statistiky podle scénářů
            const scenarioStats = {};
            sessions.forEach(session => {
                const scenario = session.scenario || 'unknown';
                if (!scenarioStats[scenario]) {
                    scenarioStats[scenario] = { total: 0, sold: 0, notSold: 0 };
                }
                scenarioStats[scenario].total++;
                if (session.result === 'sold') {
                    scenarioStats[scenario].sold++;
                } else {
                    scenarioStats[scenario].notSold++;
                }
            });
            
            // Průměrný čas session
            const sessionsWithTime = sessions.filter(s => s.sessionDurationMinutes && s.sessionDurationMinutes > 0);
            const avgTime = sessionsWithTime.length > 0 
                ? (sessionsWithTime.reduce((sum, s) => sum + s.sessionDurationMinutes, 0) / sessionsWithTime.length).toFixed(1)
                : 0;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.85); z-index: 10000; display: flex; 
                align-items: flex-start; justify-content: center; padding: 2rem 1rem; 
                overflow-y: auto; padding-top: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #ffffff); border-radius: 15px; padding: 2rem; 
                    max-width: 1200px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 20px 60px rgba(0,0,0,0.7); max-height: 90vh; overflow-y: auto;
                    position: relative;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--text-primary, #333); margin: 0; font-size: 1.8rem;">
                            🏪 ${storeName} - Detailní přehled
                        </h2>
                        <button onclick="closeStoreModal()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary); 
                            border: 1px solid rgba(255,255,255,0.2); width: 40px; height: 40px;
                            border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold;
                            display: flex; align-items: center; justify-content: center;
                        ">✕</button>
                    </div>
                    
                    <!-- Rychlé statistiky -->
                    <div style="
                        display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
                        gap: 1rem; margin-bottom: 2rem; padding: 1.5rem; 
                        background: rgba(255,255,255,0.03); border-radius: 12px;
                        border: 1px solid rgba(255,255,255,0.1);
                    ">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color, #ff1493);">${sessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Celkem sessions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #2ed573;">${soldSessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Úspěšných</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #ff4757;">${notSoldSessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Neúspěšných</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary, #333);">${successRate}%</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Úspěšnost</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #ff9500;">${avgTime}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Ø Čas (min)</div>
                        </div>
                    </div>
                    
                    <!-- Statistiky podle prodejců a scénářů -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                            <h4 style="color: var(--primary-color, #ff1493); margin: 0 0 1rem 0;">👤 Podle prodejců</h4>
                            ${Object.entries(sellerStats).map(([seller, stats]) => {
                                const displayName = getSellerDisplayName(seller);
                                const rate = stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(0) : 0;
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                        <span style="color: var(--text-primary); font-size: 0.9rem;">${displayName}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.8rem;">${stats.sold}/${stats.total} (${rate}%)</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                            <h4 style="color: var(--primary-color, #ff1493); margin: 0 0 1rem 0;">📱 Podle scénářů</h4>
                            ${Object.entries(scenarioStats).map(([scenario, stats]) => {
                                const scenarioNames = {
                                    'zasilkovna': '📦 Zásilkovna',
                                    'prislusenstvi': '🔌 Příslušenství',
                                    'novy-telefon': '📱 Nový telefon',
                                    'vykup': '💰 Výkup',
                                    'jen-se-kouka': '👀 Jen se kouká',
                                    'konzultace': '💬 Konzultace',
                                    'servis': '🔧 Servis'
                                };
                                const displayName = scenarioNames[scenario] || scenario;
                                const rate = stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(0) : 0;
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                        <span style="color: var(--text-primary); font-size: 0.9rem;">${displayName}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.8rem;">${stats.sold}/${stats.total} (${rate}%)</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Filtry pro zobrazení -->
                    <div style="margin-bottom: 2rem; text-align: center;">
                        <div style="display: inline-flex; gap: 0.5rem; background: rgba(255,255,255,0.05); 
                                    border-radius: 25px; padding: 0.3rem; border: 1px solid rgba(255,255,255,0.1);">
                            <button id="show-all-store-sessions" onclick="filterStoreSessionView('all')" style="
                                background: linear-gradient(135deg, #2ed573 0%, #20bf6b 100%); color: white; 
                                border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">📋 Všechny (${sessions.length})</button>
                            <button id="show-sold-store-sessions" onclick="filterStoreSessionView('sold')" style="
                                background: transparent; color: var(--text-primary); border: none; 
                                padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">✅ Úspěšné (${soldSessions.length})</button>
                            <button id="show-failed-store-sessions" onclick="filterStoreSessionView('failed')" style="
                                background: transparent; color: var(--text-primary); border: none; 
                                padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">❌ Neúspěšné (${notSoldSessions.length})</button>
                        </div>
                    </div>
                    
                    <!-- Sessions seznam -->
                    <div id="store-sessions-container">
                        ${renderSessionsList(sessions, 'all')}
                    </div>
                </div>
            `;
            
            modal.className = 'store-modal';
            modal.id = 'store-detail-modal';
            document.body.appendChild(modal);
            
            // Uložit sessions data pro filtrování
            window.currentStoreModalSessions = sessions;
            
            // Zavření na ESC
            document.addEventListener('keydown', handleModalKeydown);
            
            // Zavření na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeStoreModal();
            });
        }

        // Filtrování view v store modalu
        function filterStoreSessionView(filter) {
            const container = document.getElementById('store-sessions-container');
            const sessions = window.currentStoreModalSessions;
            
            if (container && sessions) {
                container.innerHTML = renderSessionsList(sessions, filter);
                
                // Aktualizuj aktivní tlačítko
                document.querySelectorAll('#store-detail-modal button[onclick^="filterStoreSessionView"]').forEach(btn => {
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-primary)';
                });
                
                const activeButton = document.getElementById(
                    filter === 'all' ? 'show-all-store-sessions' : 
                    filter === 'sold' ? 'show-sold-store-sessions' : 'show-failed-store-sessions'
                );
                
                if (activeButton) {
                    activeButton.style.background = 'linear-gradient(135deg, #2ed573 0%, #20bf6b 100%)';
                    activeButton.style.color = 'white';
                }
            }
        }

        // Zavření modal s detaily prodejny
        function closeStoreModal() {
            const modal = document.getElementById('store-detail-modal');
            if (modal) {
                modal.remove();
                delete window.currentStoreModalSessions;
                document.removeEventListener('keydown', handleModalKeydown);
            }
        }

        // Inicializace při načtení stránky
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Analytika se inicializuje...');
            
            // Přidej status section před analytiky
            const analyticsContainer = document.querySelector('.analytics-container');
            const filterSection = document.querySelector('.filter-section');
            
            if (analyticsContainer && filterSection) {
                const statusSection = document.createElement('div');
                statusSection.innerHTML = `
                    <div style="
                        background: rgba(255,255,255,0.05); border-radius: 10px; padding: 1rem; 
                        margin-bottom: 2rem; border-left: 4px solid var(--primary-color);
                    ">
                        <h4 style="color: var(--primary-color); margin: 0 0 0.5rem 0; font-size: 0.9rem;">
                            📊 Status ukládání dat
                        </h4>
                        <div id="storage-info" style="color: var(--text-secondary); font-size: 0.85rem;">
                            <div>🔍 Kontroluji stav úložiště...</div>
                        </div>
                    </div>
                `;
                
                analyticsContainer.insertBefore(statusSection, filterSection.nextSibling);
                
                // Zobraz status dat
                setTimeout(showDataStatus, 200);
            }
            
            // Debug info při startu
            const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
            console.log('🚀 Inicializace analytiky:');
            console.log('📱 localStorage sessions:', localData.length);
            console.log('🌐 Načítám ze serveru...');
            
            // Zkontroluj duplicity
            setTimeout(checkForDuplicates, 300);
            
            // Načti dostupné prodejny
            setTimeout(loadAvailableStores, 150);
            
            // Aktualizuj status
            setTimeout(showDataStatus, 100);
            
            // Malé zpoždění aby se všechno načetlo
            setTimeout(() => {
                loadAnalytics();
            }, 500);
        });
    </script>
</body>
</html> 