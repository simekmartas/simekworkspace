<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prodejn√≠ analytika - Mobil Maj√°k</title>
    <!-- Legacy Browser Support First -->
    <script src="legacy-browser-support.js"></script>
    <link rel="stylesheet" href="legacy-browser-styles.css">
    <link rel="stylesheet" href="css-compatibility-patches.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="progressive-enhancement.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#ff1493">
    <meta name="description" content="Prodejn√≠ analytika - Mobil Maj√°k">
    
    <style>
        .analytics-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            margin-top: 100px;
        }
        
        .analytics-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .analytics-header h1 {
            color: var(--text-primary);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .analytics-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff1493, #2196F3);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 20, 147, 0.15);
        }
        
        .stat-emoji {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .section-title {
            color: var(--text-primary);
            font-size: 1.8rem;
            font-weight: 600;
            margin: 3rem 0 1.5rem 0;
            text-align: center;
        }
        
        .chart-container {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .seller-table, .scenario-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .seller-table th, .seller-table td,
        .scenario-table th, .scenario-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .seller-table th, .scenario-table th {
            color: var(--primary-color);
            font-weight: 600;
            background: rgba(255, 20, 147, 0.05);
        }
        
        .seller-table td, .scenario-table td {
            color: var(--text-primary);
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ed573, #20bf6b);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .filter-section {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 3rem;
        }
        
        .filter-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #ff1493, #e91e63);
            color: white;
            border-color: var(--primary-color);
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .no-data-emoji {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        /* Admin n√°stroje styly */
        #admin-tools-toggle:hover {
            background: rgba(255,255,255,0.2) !important;
            color: var(--text-primary) !important;
            transform: translateY(-1px);
        }
        
        .admin-btn {
            transition: all 0.2s ease !important;
        }
        
        .admin-btn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15) !important;
        }
        
        #admin-tools-content {
            transition: max-height 0.3s ease-out;
        }

        @media (max-width: 768px) {
            .analytics-container {
                padding: 1rem;
                margin-top: 80px;
            }
            
            .analytics-header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1.5rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .filter-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .filter-btn {
                width: 100%;
                min-width: auto;
                font-size: 0.85rem;
            }
            
            /* Zmen≈°i text v tlaƒç√≠tk√°ch prodejen na mobilu */
            .store-filter {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
            }
            
            /* Na mobilech zobraz m√©nƒõ tlaƒç√≠tek v ≈ô√°dku pro prodejny */
            #store-filters {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            #store-filters .filter-btn {
                text-align: center;
                justify-content: center;
            }
            
            /* Admin n√°stroje na mobilu */
            #admin-tools-content div {
                grid-template-columns: repeat(2, 1fr) !important;
            }
            
            .admin-btn {
                font-size: 0.75rem !important;
                padding: 0.5rem !important;
            }
            
            /* Scenario modal na mobilu */
            .scenario-modal .modal-content {
                max-height: 95vh !important;
                padding: 1rem !important;
            }
            
            .scenario-modal h2 {
                font-size: 1.3rem !important;
            }
            
            .scenario-modal .stats-grid {
                grid-template-columns: repeat(2, 1fr) !important;
                gap: 0.5rem !important;
            }
            
            .scenario-modal .filter-buttons {
                flex-direction: column !important;
                gap: 0.5rem !important;
            }
            
            .scenario-modal .session-card {
                padding: 1rem !important;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">Mobil Maj√°k</a>
            <nav>
                <ul>
                    <!-- Navigace bude dynamicky naƒçtena pomoc√≠ JavaScriptu -->
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="analytics-container">
            <div class="analytics-header">
                <h1>üìä Prodejn√≠ analytika</h1>
                <p>Komplexn√≠ p≈ôehled v√Ωkonnosti prodejn√≠ch t√Ωm≈Ø</p>
            </div>

            <div class="filter-section">
                <!-- Hlavn√≠ filtry - v≈ædy viditeln√© -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--primary-color, #ff1493); margin-bottom: 1rem; text-align: center; font-size: 1rem;">üìÖ ƒåasov√© obdob√≠</h4>
                    <div class="filter-controls">
                        <button class="filter-btn time-filter active" onclick="setTimeFilter('all')">V≈°echna data</button>
                        <button class="filter-btn time-filter" onclick="setTimeFilter('today')">Dnes</button>
                        <button class="filter-btn time-filter" onclick="setTimeFilter('week')">Tento t√Ωden</button>
                        <button class="filter-btn time-filter" onclick="setTimeFilter('month')">Tento mƒõs√≠c</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="color: var(--primary-color, #ff1493); margin-bottom: 1rem; text-align: center; font-size: 1rem;">üè™ Prodejna</h4>
                    <div class="filter-controls" id="store-filters">
                        <button class="filter-btn store-filter active" onclick="setStoreFilter('all')">V≈°echny prodejny</button>
                        <!-- Dynamicky naƒçten√© prodejny -->
                    </div>
                </div>
                
                <!-- Jednoduch√© akce -->
                <div style="margin-bottom: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                        <button class="filter-btn" onclick="debugLoadData()" style="background: #2196F3; border-color: #2196F3; font-weight: 600;">
                            üîÑ Obnovit data
                        </button>
                        <button class="filter-btn" onclick="resetAllFilters()" style="background: #ff9500; border-color: #ff9500; font-weight: 600;">
                            ‚Ü©Ô∏è Reset filtr≈Ø
                        </button>
                        <button class="filter-btn" onclick="showDeleteDataModal()" style="background: #ff4757; border-color: #ff4757; font-weight: 600;">
                            üóëÔ∏è Smazat data
                        </button>
                    </div>
                </div>
                
                <!-- Pokroƒçil√© n√°stroje - skl√°dac√≠ -->
                <div style="text-align: center;">
                    <button id="admin-tools-toggle" onclick="toggleAdminTools()" style="
                        background: rgba(255,255,255,0.1); color: var(--text-secondary); 
                        border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; 
                        border-radius: 20px; cursor: pointer; font-size: 0.85rem; 
                        transition: all 0.3s ease; font-weight: 500;
                    ">
                        ‚öôÔ∏è Pokroƒçil√© n√°stroje 
                        <span id="admin-tools-arrow" style="margin-left: 0.5rem; transition: transform 0.3s ease;">‚ñº</span>
                    </button>
                    
                    <div id="admin-tools-content" style="
                        max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
                        margin-top: 0;
                    ">
                        <div style="
                            margin-top: 1rem; padding: 1rem; 
                            background: rgba(255,255,255,0.03); border-radius: 10px;
                            border: 1px solid rgba(255,255,255,0.1);
                        ">
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 0.75rem;">
                                <button class="filter-btn admin-btn" onclick="syncWithServer()" style="background: #ff9500; border-color: #ff9500; font-size: 0.8rem; padding: 0.6rem;">
                                    üîÑ Sync server
                                </button>
                                <button class="filter-btn admin-btn" onclick="testServerConnection()" style="background: #2ed573; border-color: #2ed573; font-size: 0.8rem; padding: 0.6rem;">
                                    üåê Test server
                                </button>
                                <button class="filter-btn admin-btn" onclick="cleanDuplicateSellerData()" style="background: #8e44ad; border-color: #8e44ad; font-size: 0.8rem; padding: 0.6rem;">
                                    üîß Fix duplicity
                                </button>
                                <button class="filter-btn admin-btn" onclick="showSellerNameManager()" style="background: #6c5ce7; border-color: #6c5ce7; font-size: 0.8rem; padding: 0.6rem;">
                                    üë§ Spr√°va jmen
                                </button>
                                <button class="filter-btn admin-btn" onclick="resetServerData()" style="background: #e74c3c; border-color: #e74c3c; font-size: 0.8rem; padding: 0.6rem;">
                                    üåê Reset serveru
                                </button>
                            </div>
                            
                            <div style="text-align: center; margin-top: 0.75rem; font-size: 0.75rem; color: var(--text-secondary);">
                                ‚ö†Ô∏è N√°stroje pro spr√°vce syst√©mu
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="analyticsContent">
                <div class="loading">
                    <div class="loading-spinner">‚è≥</div>
                    <p>Naƒç√≠t√°m analytick√© data...</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Mobil Maj√°k. V≈°echna pr√°va vyhrazena.</p>
        </div>
    </footer>

    <script src="theme-toggle.js"></script>
    <script src="sales-assistant.js"></script>
    <script src="navigation.js"></script>
    <script src="access-control.js"></script>
    
    <script>
        let currentTimeFilter = 'all';
        let currentStoreFilter = 'all';
        let analyticsData = null;
        let availableStores = [];

        // Kontrola p≈ô√≠stupu - pouze pro administr√°tory
        function checkAdminAccess() {
            const userRole = localStorage.getItem('role');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            
            if (!isLoggedIn || (userRole !== 'Administrator' && userRole !== 'Administr√°tor')) {
                alert('Nem√°te opr√°vnƒõn√≠ k p≈ô√≠stupu k t√©to str√°nce.');
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // Naƒçten√≠ dostupn√Ωch prodejen z dat
        function loadAvailableStores() {
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                console.log('üè™ Naƒç√≠t√°m prodejny ze', localData.length, 'sessions');
                
                const stores = new Set();
                const storeDebug = {};
                
                localData.forEach((session, index) => {
                    const store = session.store || session.prodejna || 'Nezn√°m√° prodejna';
                    if (store && store !== 'undefined' && store !== '') {
                        stores.add(store);
                        storeDebug[store] = (storeDebug[store] || 0) + 1;
                    }
                    
                    // Debug prvn√≠ 3 sessions
                    if (index < 3) {
                        console.log(`üè™ Session ${index}:`, {
                            store: session.store,
                            prodejna: session.prodejna,
                            keys: Object.keys(session)
                        });
                    }
                });
                
                availableStores = Array.from(stores).sort();
                console.log('üè™ Dostupn√© prodejny:', availableStores);
                console.log('üè™ Poƒçty podle prodejen:', storeDebug);
                
                // Aktualizuj UI filtr≈Ø prodejen
                updateStoreFilters();
                
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ prodejen:', error);
            }
        }

        // Aktualizace UI filtr≈Ø prodejen
        function updateStoreFilters() {
            const storeFiltersContainer = document.getElementById('store-filters');
            if (!storeFiltersContainer) return;
            
            // Zachovej tlaƒç√≠tko "V≈°echny prodejny"
            const allButton = storeFiltersContainer.querySelector('.store-filter[onclick*="all"]');
            storeFiltersContainer.innerHTML = '';
            if (allButton) {
                storeFiltersContainer.appendChild(allButton);
            } else {
                storeFiltersContainer.innerHTML = '<button class="filter-btn store-filter active" onclick="setStoreFilter(\'all\')">V≈°echny prodejny</button>';
            }
            
            // P≈ôidej tlaƒç√≠tka pro jednotliv√© prodejny
            availableStores.forEach(store => {
                const button = document.createElement('button');
                button.className = 'filter-btn store-filter';
                button.textContent = `üè™ ${store}`;
                button.onclick = () => setStoreFilter(store);
                storeFiltersContainer.appendChild(button);
            });
        }

        // Nastaven√≠ ƒçasov√©ho filtru
        function setTimeFilter(filter) {
            currentTimeFilter = filter;
            
            // Aktualizuj aktivn√≠ tlaƒç√≠tko
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Najdi a aktivuj spr√°vn√© tlaƒç√≠tko
            const targetBtn = Array.from(document.querySelectorAll('.time-filter')).find(btn => 
                btn.onclick.toString().includes(filter)
            );
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            console.log('üìÖ Nastaven ƒçasov√Ω filtr:', filter);
            loadAnalytics();
        }

        // Nastaven√≠ filtru prodejny
        function setStoreFilter(store) {
            currentStoreFilter = store;
            
            // Aktualizuj aktivn√≠ tlaƒç√≠tko
            document.querySelectorAll('.store-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Najdi a aktivuj spr√°vn√© tlaƒç√≠tko
            if (store === 'all') {
                const allBtn = document.querySelector('.store-filter[onclick*="all"]');
                if (allBtn) allBtn.classList.add('active');
            } else {
                const targetBtn = Array.from(document.querySelectorAll('.store-filter')).find(btn => 
                    btn.textContent.includes(store)
                );
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
            }
            
            console.log('üè™ Nastaven filtr prodejny:', store);
            loadAnalytics();
        }

        // Naƒçten√≠ analytick√Ωch dat
        async function loadAnalytics() {
            if (!checkAdminAccess()) return;
            
            const contentDiv = document.getElementById('analyticsContent');
            contentDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner">‚è≥</div>
                    <p>Naƒç√≠t√°m analytick√© data...</p>
                </div>
            `;
            
            console.log(`üìä Naƒç√≠t√°m data s filtry: ƒças="${currentTimeFilter}", prodejna="${currentStoreFilter}"`);
            
            try {
                // Zkus naƒç√≠st ze serveru - PRIM√ÅRN√ç zdroj dat
                console.log('üåê Naƒç√≠t√°m data ze serveru...');
                const response = await fetch('/api/sales-data');
                
                if (response.ok) {
                    const serverData = await response.json();
                    console.log('üåê Server response:', serverData);
                    
                    if (serverData.success && serverData.salesData && Array.isArray(serverData.salesData)) {
                        console.log(`üåê Server vr√°til ${serverData.salesData.length} sessions`);
                        console.log('üåê Sample server data:', serverData.salesData.slice(0, 2));
                        
                        // Synchronizuj server data do localStorage pro konzistenci
                        localStorage.setItem('sales_sessions', JSON.stringify(serverData.salesData));
                        
                        // Filtruj server data podle filtr≈Ø
                        const filteredData = filterSalesData(serverData.salesData);
                        console.log(`üåê Po filtrov√°n√≠: ${filteredData.length} sessions`);
                        
                        if (filteredData.length === 0) {
                            console.warn('‚ö†Ô∏è Server data po filtrov√°n√≠ pr√°zdn√°');
                            // Zkus bez filtr≈Ø
                            const unfilteredStats = generateLocalStats(serverData.salesData);
                            if (unfilteredStats) {
                                // Reset filtr≈Ø a zobraz warning
                                currentTimeFilter = 'all';
                                currentStoreFilter = 'all';
                                updateFilterButtons();
                                
                                contentDiv.innerHTML = `
                                    <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid #ff9800; border-radius: 10px; padding: 1rem; margin-bottom: 2rem;">
                                        <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">‚ö†Ô∏è Filtry resetov√°ny</h4>
                                        <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">
                                            Aktivn√≠ filtry nevr√°tily ≈æ√°dn√° data ze serveru. Zobrazuji v≈°echna data.
                                        </p>
                                    </div>
                                `;
                                
                                renderAnalytics(unfilteredStats);
                                return;
                            }
                        }
                        
                        const stats = generateLocalStats(filteredData);
                        if (stats) {
                            analyticsData = stats;
                            renderAnalytics(analyticsData);
                            
                            // Aktualizuj info o filtrov√°n√≠
                            updateFilterInfo(serverData.salesData.length, filteredData.length);
                            return;
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Server nevr√°til validn√≠ data:', serverData);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Server error:', response.status, response.statusText);
                }
                
                // Fallback na localStorage data
                console.log('üì± Fallback na localStorage...');
                throw new Error('Server nedostupn√Ω');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Server nedostupn√Ω, naƒç√≠t√°m data z localStorage:', error.message);
                
                // Naƒçti data z localStorage jako fallback
                try {
                    const localSalesData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                    console.log('üì± localStorage fallback:', localSalesData.length, 'sessions');
                    
                    if (localSalesData.length === 0) {
                        contentDiv.innerHTML = `
                            <div class="no-data">
                                <span class="no-data-emoji">üìà</span>
                                <h3>Zat√≠m ≈æ√°dn√° data</h3>
                                <p>Server nen√≠ dostupn√Ω a v localStorage nejsou ≈æ√°dn√° data.</p>
                                <p>Jakmile prodejci zaƒçnou pou≈æ√≠vat prodejn√≠ asistent, zde se zobraz√≠ analytick√© √∫daje.</p>
                                <div style="margin-top: 1rem;">
                                    <button class="filter-btn" onclick="loadAnalytics()">üîÑ Zkusit znovu</button>
                                    <button class="filter-btn" onclick="syncWithServer()">üåê Sync se serverem</button>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Zpracuj localStorage data stejnƒõ jako server data
                    const filteredData = filterSalesData(localSalesData);
                    console.log(`üì± Po filtrov√°n√≠ localStorage: ${filteredData.length} sessions`);
                    
                    if (filteredData.length === 0) {
                        console.warn('‚ö†Ô∏è localStorage data po filtrov√°n√≠ pr√°zdn√°');
                        // Zobraz v≈°echna data bez filtr≈Ø
                        const unfilteredStats = generateLocalStats(localSalesData);
                        if (unfilteredStats) {
                            // Reset filtr≈Ø
                            currentTimeFilter = 'all';
                            currentStoreFilter = 'all';
                            updateFilterButtons();
                            
                            contentDiv.innerHTML = `
                                <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid #ff9800; border-radius: 10px; padding: 1rem; margin-bottom: 2rem;">
                                    <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">‚ö†Ô∏è Filtry resetov√°ny (Offline)</h4>
                                    <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">
                                        Server nen√≠ dostupn√Ω. Zobrazuji v≈°echna localStorage data bez filtr≈Ø.
                                    </p>
                                </div>
                            `;
                            
                            renderAnalytics(unfilteredStats);
                            return;
                        }
                    }
                    
                    const stats = generateLocalStats(filteredData);
                    if (stats) {
                        analyticsData = stats;
                        
                        // P≈ôidej info o offline re≈æimu
                        contentDiv.innerHTML = `
                            <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid #ff9800; border-radius: 10px; padding: 1rem; margin-bottom: 2rem;">
                                <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">üì± Offline re≈æim</h4>
                                <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">
                                    Server nen√≠ dostupn√Ω. Zobrazuji data z localStorage.
                                </p>
                            </div>
                        `;
                        
                        renderAnalytics(analyticsData);
                        updateFilterInfo(localSalesData.length, filteredData.length);
                    } else {
                        contentDiv.innerHTML = `
                            <div class="no-data">
                                <span class="no-data-emoji">‚ö†Ô∏è</span>
                                <h3>Chyba p≈ôi zpracov√°n√≠ dat</h3>
                                <p>Data jsou dostupn√° (${localSalesData.length} sessions), ale nelze je zpracovat.</p>
                                <div style="margin-top: 1rem;">
                                    <button class="filter-btn" onclick="debugLoadData()">üîç Debug info</button>
                                    <button class="filter-btn" onclick="resetAllFilters()">üîÑ Reset filtr≈Ø</button>
                                </div>
                            </div>
                        `;
                    }
                    
                } catch (localError) {
                    console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ localStorage:', localError);
                    contentDiv.innerHTML = `
                        <div class="no-data">
                            <span class="no-data-emoji">üí•</span>
                            <h3>Kritick√° chyba</h3>
                            <p>Server nen√≠ dostupn√Ω a nelze naƒç√≠st ani localStorage data.</p>
                            <button class="filter-btn" onclick="location.reload()">üîÑ Obnovit str√°nku</button>
                        </div>
                    `;
                }
            }
        }

        // Filtrov√°n√≠ dat podle ƒçasu a prodejny
        function filterSalesData(salesData) {
            console.log('üîç Filtrov√°n√≠ dat:', {
                inputData: salesData.length,
                timeFilter: currentTimeFilter,
                storeFilter: currentStoreFilter
            });
            
            const filtered = salesData.filter(session => {
                // Debug pro prvn√≠ session
                if (salesData.indexOf(session) === 0) {
                    console.log('üîç Sample session struktura:', {
                        timestamp: session.timestamp,
                        store: session.store,
                        prodejna: session.prodejna,
                        seller: session.seller,
                        keys: Object.keys(session)
                    });
                }
                
                // ƒåasov√Ω filtr
                if (currentTimeFilter !== 'all') {
                    const sessionDate = new Date(session.timestamp);
                    const now = new Date();
                    
                    if (!session.timestamp) {
                        console.warn('‚ö†Ô∏è Session bez timestamp:', session);
                        return false;
                    }
                    
                    switch(currentTimeFilter) {
                        case 'today':
                            if (sessionDate.toDateString() !== now.toDateString()) {
                                return false;
                            }
                            break;
                        case 'week':
                            const weekAgo = new Date(now);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            if (sessionDate < weekAgo) {
                                return false;
                            }
                            break;
                        case 'month':
                            const monthAgo = new Date(now);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            if (sessionDate < monthAgo) {
                                return false;
                            }
                            break;
                    }
                }
                
                // Filtr prodejny
                if (currentStoreFilter !== 'all') {
                    const sessionStore = session.store || session.prodejna || 'Nezn√°m√° prodejna';
                    if (sessionStore !== currentStoreFilter) {
                        return false;
                    }
                }
                
                return true;
            });
            
            console.log(`üîç V√Ωsledek filtrov√°n√≠: ${filtered.length} z ${salesData.length} sessions`);
            return filtered;
        }

        // Aktualizace informac√≠ o filtrov√°n√≠
        function updateFilterInfo(totalSessions, filteredSessions) {
            const filterInfo = document.getElementById('filter-info');
            if (filterInfo) {
                filterInfo.remove();
            }
            
            // Pouze pokud jsou nƒõjak√© filtry aktivn√≠
            if (currentTimeFilter !== 'all' || currentStoreFilter !== 'all') {
                const analyticsContainer = document.querySelector('.analytics-container');
                const contentDiv = document.getElementById('analyticsContent');
                
                if (analyticsContainer && contentDiv) {
                    const infoDiv = document.createElement('div');
                    infoDiv.id = 'filter-info';
                    infoDiv.innerHTML = `
                        <div style="
                            background: rgba(33, 150, 243, 0.1); border: 1px solid #2196F3; 
                            border-radius: 10px; padding: 1rem; margin-bottom: 2rem; 
                            border-left: 4px solid #2196F3; text-align: center;
                        ">
                            <div style="color: #2196F3; font-weight: 600; margin-bottom: 0.5rem;">
                                üìä Aktivn√≠ filtry
                            </div>
                            <div style="color: var(--text-primary, #333); font-size: 0.9rem;">
                                üìÖ <strong>Obdob√≠:</strong> ${getTimeFilterName()} | 
                                üè™ <strong>Prodejna:</strong> ${currentStoreFilter === 'all' ? 'V≈°echny' : currentStoreFilter}
                            </div>
                            <div style="color: var(--text-secondary, #666); font-size: 0.8rem; margin-top: 0.5rem;">
                                Zobrazuji ${filteredSessions} z ${totalSessions} celkov√Ωch sessions
                            </div>
                        </div>
                    `;
                    
                    analyticsContainer.insertBefore(infoDiv, contentDiv);
                }
            }
        }

        // N√°zev ƒçasov√©ho filtru pro zobrazen√≠
        function getTimeFilterName() {
            switch(currentTimeFilter) {
                case 'all': return 'V≈°echna data';
                case 'today': return 'Dnes';
                case 'week': return 'Tento t√Ωden';
                case 'month': return 'Tento mƒõs√≠c';
                default: return currentTimeFilter;
            }
        }

        // Aktualizace stavu tlaƒç√≠tek filtr≈Ø
        function updateFilterButtons() {
            // Aktualizuj ƒçasov√© filtry
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.store-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Aktivuj spr√°vn√° tlaƒç√≠tka
            const allTimeBtn = Array.from(document.querySelectorAll('.time-filter')).find(btn => 
                btn.textContent.includes('V≈°echna data')
            );
            if (allTimeBtn) allTimeBtn.classList.add('active');
            
            const allStoreBtn = Array.from(document.querySelectorAll('.store-filter')).find(btn => 
                btn.textContent.includes('V≈°echny prodejny')
            );
            if (allStoreBtn) allStoreBtn.classList.add('active');
        }
        
        // Generov√°n√≠ statistik z lok√°ln√≠ch dat
        function generateLocalStats(salesData) {
            console.log('üè≠ Generuji statistiky z dat:', {
                inputLength: salesData.length,
                sampleData: salesData.slice(0, 2)
            });
            
            if (!salesData || salesData.length === 0) {
                console.warn('‚ö†Ô∏è ≈Ω√°dn√° data pro generov√°n√≠ statistik!');
                return null;
            }
            
            const stats = {
                totalSessions: salesData.length,
                successfulSales: 0,
                unsuccessfulSales: 0,
                conversionRate: 0,
                topSellers: {},
                popularItems: {},
                discountUsage: { used: 0, notUsed: 0 },
                scenarioStats: {},
                storeStats: {},
                dailyStats: {},
                totalSessionTime: 0,
                sessionsWithTime: 0,
                averageSessionTime: 0
            };
            
            // Poƒç√≠tej z√°kladn√≠ statistiky
            salesData.forEach(session => {
                // √öspƒõ≈°nost prodeje
                if (session.result === 'sold') {
                    stats.successfulSales++;
                    
                    // Popul√°rn√≠ polo≈æky
                    if (session.soldItems) {
                        session.soldItems.forEach(item => {
                            stats.popularItems[item] = (stats.popularItems[item] || 0) + 1;
                        });
                    }
                    
                    // Pou≈æ√≠v√°n√≠ slevy
                    if (session.discountUsed === true) {
                        stats.discountUsage.used++;
                    } else if (session.discountUsed === false) {
                        stats.discountUsage.notUsed++;
                    }
                } else {
                    stats.unsuccessfulSales++;
                }
                
                // ƒåasov√© statistiky
                if (session.sessionDurationMinutes && session.sessionDurationMinutes > 0) {
                    stats.totalSessionTime += session.sessionDurationMinutes;
                    stats.sessionsWithTime++;
                }
                
                // Top prodejci - normalizace jm√©na
                let seller = session.seller || session.sellerId || 'Unknown';
                
                // Normalizace jmen - mapov√°n√≠ cel√Ωch jmen na usernames
                const nameMapping = {
                    'Tom√°≈° Valenta': 'tvalenta',
                    'Admin Administr√°tor': 'admin',
                    '≈†imon Gabriel': 'sgabriel',
                    // P≈ôidej dal≈°√≠ mapov√°n√≠ podle pot≈ôeby
                };
                
                // Pokud je seller cel√© jm√©no, p≈ôeveƒè na username
                if (nameMapping[seller]) {
                    seller = nameMapping[seller];
                }
                
                // Naƒçti custom jm√©na z localStorage
                const customDisplayNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
                
                // V√Ωchoz√≠ zobrazovac√≠ jm√©na (fallback)
                const defaultDisplayNames = {
                    'tvalenta': 'Tom√°≈° Valenta',
                    'admin': 'Admin Administr√°tor', 
                    'sgabriel': '≈†imon Gabriel',
                    'malek': 'Pavel Malek',  // P≈ôedpokl√°dan√° hodnota - zmƒõnit p≈ôes "üë§ Spr√°va jmen"
                };
                
                if (!stats.topSellers[seller]) {
                    // Vytvo≈ô lep≈°√≠ zobrazovac√≠ jm√©no
                    let displayName = customDisplayNames[seller] || defaultDisplayNames[seller];
                    
                    if (!displayName) {
                        // Automatick√© generov√°n√≠ lep≈°√≠ho zobrazen√≠ pro nezn√°m√© usernames
                        if (seller.length > 1) {
                            // Kapitalizuj prvn√≠ p√≠smeno
                            displayName = seller.charAt(0).toUpperCase() + seller.slice(1);
                        } else {
                            displayName = seller;
                        }
                    }
                    
                    stats.topSellers[seller] = { 
                        total: 0, 
                        sold: 0, 
                        notSold: 0, 
                        totalTime: 0, 
                        avgTime: 0,
                        displayName: displayName,
                        username: seller  // Ulo≈æ i p≈Øvodn√≠ username
                    };
                }
                stats.topSellers[seller].total++;
                if (session.result === 'sold') {
                    stats.topSellers[seller].sold++;
                } else {
                    stats.topSellers[seller].notSold++;
                }
                
                // ƒåas pro prodejce
                if (session.sessionDurationMinutes && session.sessionDurationMinutes > 0) {
                    stats.topSellers[seller].totalTime += session.sessionDurationMinutes;
                }
                
                // Statistiky sc√©n√°≈ô≈Ø
                const scenario = session.scenario || 'unknown';
                if (!stats.scenarioStats[scenario]) {
                    stats.scenarioStats[scenario] = { total: 0, sold: 0, notSold: 0 };
                }
                stats.scenarioStats[scenario].total++;
                if (session.result === 'sold') {
                    stats.scenarioStats[scenario].sold++;
                } else {
                    stats.scenarioStats[scenario].notSold++;
                }
                
                // Statistiky prodejen
                const store = session.store || 'Unknown';
                if (!stats.storeStats[store]) {
                    stats.storeStats[store] = { total: 0, sold: 0, notSold: 0 };
                }
                stats.storeStats[store].total++;
                if (session.result === 'sold') {
                    stats.storeStats[store].sold++;
                } else {
                    stats.storeStats[store].notSold++;
                }
            });
            
            // Spoƒç√≠tej conversion rate
            if (stats.totalSessions > 0) {
                stats.conversionRate = ((stats.successfulSales / stats.totalSessions) * 100).toFixed(1);
            }
            
            // Spoƒç√≠tej pr≈Ømƒõrn√Ω ƒças session
            if (stats.sessionsWithTime > 0) {
                stats.averageSessionTime = (stats.totalSessionTime / stats.sessionsWithTime).toFixed(1);
            }
            
            // Spoƒç√≠tej pr≈Ømƒõrn√Ω ƒças pro ka≈æd√©ho prodejce
            Object.keys(stats.topSellers).forEach(seller => {
                if (stats.topSellers[seller].total > 0) {
                    stats.topSellers[seller].avgTime = (stats.topSellers[seller].totalTime / stats.topSellers[seller].total).toFixed(1);
                }
            });
            
            console.log('üè≠ Statistiky vygenerov√°ny:', {
                totalSessions: stats.totalSessions,
                successfulSales: stats.successfulSales,
                unsuccessfulSales: stats.unsuccessfulSales,
                conversionRate: stats.conversionRate,
                sellersCount: Object.keys(stats.topSellers).length,
                scenariosCount: Object.keys(stats.scenarioStats).length,
                storesCount: Object.keys(stats.storeStats).length,
                stats: stats
            });
            
            return stats;
        }

        // Renderov√°n√≠ analytiky
        function renderAnalytics(stats) {
            console.log('üé® Renderuji analytiku s daty:', stats);
            
            const contentDiv = document.getElementById('analyticsContent');
            if (!contentDiv) {
                console.error('‚ùå Element analyticsContent nenalezen!');
                return;
            }
            
            if (!stats) {
                console.error('‚ùå ≈Ω√°dn√° data pro renderov√°n√≠!');
                contentDiv.innerHTML = `
                    <div class="no-data">
                        <span class="no-data-emoji">‚ö†Ô∏è</span>
                        <h3>Chyba p≈ôi renderov√°n√≠</h3>
                        <p>Statistiky nebyly p≈ôed√°ny funkci renderAnalytics.</p>
                    </div>
                `;
                return;
            }
            
            if (stats.totalSessions === 0) {
                contentDiv.innerHTML = `
                    <div class="no-data">
                        <span class="no-data-emoji">üìà</span>
                        <h3>Zat√≠m ≈æ√°dn√° data</h3>
                        <p>Jakmile prodejci zaƒçnou pou≈æ√≠vat prodejn√≠ asistent, zde se zobraz√≠ analytick√© √∫daje.</p>
                    </div>
                `;
                return;
            }
            
            contentDiv.innerHTML = `
                <!-- Z√°kladn√≠ statistiky -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-emoji">üìã</span>
                        <div class="stat-value">${stats.totalSessions}</div>
                        <div class="stat-label">Celkem rozhovor≈Ø</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">‚úÖ</span>
                        <div class="stat-value">${stats.successfulSales}</div>
                        <div class="stat-label">√öspƒõ≈°n√Ωch prodej≈Ø</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">‚ùå</span>
                        <div class="stat-value">${stats.unsuccessfulSales}</div>
                        <div class="stat-label">Ne√∫spƒõ≈°n√Ωch pokus≈Ø</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">üìä</span>
                        <div class="stat-value">${stats.conversionRate}%</div>
                        <div class="stat-label">√öspƒõ≈°nost prodeje</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">‚è±Ô∏è</span>
                        <div class="stat-value">${stats.averageSessionTime || '0'} min</div>
                        <div class="stat-label">Pr≈Ømƒõrn√Ω ƒças session</div>
                    </div>
                </div>

                <!-- Top prodejci -->
                <h2 class="section-title">üèÜ V√Ωkonnost prodejc≈Ø</h2>
                <div class="chart-container">
                    ${renderSellersTable(stats.topSellers)}
                </div>

                <!-- Statistiky sc√©n√°≈ô≈Ø -->
                <h2 class="section-title">üì± Statistiky sc√©n√°≈ô≈Ø</h2>
                <div class="chart-container">
                    ${renderScenariosTable(stats.scenarioStats)}
                </div>

                <!-- Popul√°rn√≠ polo≈æky -->
                ${stats.popularItems && Object.keys(stats.popularItems).length > 0 ? `
                <h2 class="section-title">üõçÔ∏è Nejprod√°vanƒõj≈°√≠ polo≈æky</h2>
                <div class="chart-container">
                    ${renderPopularItems(stats.popularItems)}
                </div>
                ` : ''}

                <!-- Statistiky prodejen -->
                ${stats.storeStats && Object.keys(stats.storeStats).length > 0 ? `
                <h2 class="section-title">üè™ V√Ωkonnost prodejen</h2>
                <div class="chart-container">
                    ${renderStoresTable(stats.storeStats)}
                </div>
                ` : ''}

                <!-- Pou≈æ√≠v√°n√≠ slevy -->
                ${stats.discountUsage.used > 0 || stats.discountUsage.notUsed > 0 ? `
                <h2 class="section-title">üí∞ Pou≈æ√≠v√°n√≠ slev</h2>
                <div class="chart-container">
                    ${renderDiscountUsage(stats.discountUsage)}
                </div>
                ` : ''}
            `;
            
            console.log('üé® Renderov√°n√≠ analytiky dokonƒçeno √∫spƒõ≈°nƒõ');
        }

        // Tabulka prodejc≈Ø
        function renderSellersTable(topSellers) {
            if (!topSellers || Object.keys(topSellers).length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">≈Ω√°dn√≠ prodejci zat√≠m nezaznamenali data.</p>';
            }
            
            const sellers = Object.entries(topSellers)
                .map(([username, stats]) => ({
                    username,
                    displayName: stats.displayName || username,
                    ...stats,
                    successRate: stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.sold - a.sold);
            
            return `
                <table class="seller-table">
                    <thead>
                        <tr>
                            <th>Prodejce</th>
                            <th>Celkem</th>
                            <th>Prod√°no</th>
                            <th>Neprod√°no</th>
                            <th>√öspƒõ≈°nost</th>
                            <th>√ò ƒåas</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sellers.map(seller => `
                            <tr>
                                <td><strong>${seller.displayName}</strong></td>
                                <td>${seller.total}</td>
                                <td style="color: #2ed573;">${seller.sold}</td>
                                <td style="color: #ff4757;">${seller.notSold}</td>
                                <td>
                                    ${seller.successRate}%
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${seller.successRate}%"></div>
                                    </div>
                                </td>
                                <td style="color: var(--text-secondary);">${seller.avgTime || '0'} min</td>
                                <td>
                                    <button onclick="showSellerDetails('${seller.username}')" style="
                                        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
                                        color: white; border: none; padding: 0.4rem 0.8rem; 
                                        border-radius: 6px; cursor: pointer; font-size: 0.8rem;
                                        font-weight: 500; transition: all 0.3s ease; white-space: nowrap;
                                    " onmouseover="this.style.transform='translateY(-1px)'" 
                                       onmouseout="this.style.transform='translateY(0px)'">
                                        üë§ Detaily
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Tabulka prodejen
        function renderStoresTable(storeStats) {
            if (!storeStats || Object.keys(storeStats).length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">≈Ω√°dn√© prodejny zat√≠m nezaznamenaly data.</p>';
            }
            
            const stores = Object.entries(storeStats)
                .map(([name, stats]) => ({
                    name,
                    ...stats,
                    successRate: stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.total - a.total);
            
            return `
                <table class="scenario-table">
                    <thead>
                        <tr>
                            <th>Prodejna</th>
                            <th>Celkem</th>
                            <th>Prod√°no</th>
                            <th>Neprod√°no</th>
                            <th>√öspƒõ≈°nost</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${stores.map(store => `
                            <tr>
                                <td><strong>üè™ ${store.name}</strong></td>
                                <td>${store.total}</td>
                                <td style="color: #2ed573;">${store.sold}</td>
                                <td style="color: #ff4757;">${store.notSold}</td>
                                <td>
                                    ${store.successRate}%
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${store.successRate}%"></div>
                                    </div>
                                </td>
                                <td>
                                    <button onclick="showStoreDetails('${store.name}')" style="
                                        background: linear-gradient(135deg, #2ed573 0%, #20bf6b 100%);
                                        color: white; border: none; padding: 0.4rem 0.8rem; 
                                        border-radius: 6px; cursor: pointer; font-size: 0.8rem;
                                        font-weight: 500; transition: all 0.3s ease; white-space: nowrap;
                                    " onmouseover="this.style.transform='translateY(-1px)'" 
                                       onmouseout="this.style.transform='translateY(0px)'">
                                        üè™ Detaily
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Tabulka sc√©n√°≈ô≈Ø
        function renderScenariosTable(scenarioStats) {
            if (!scenarioStats || Object.keys(scenarioStats).length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">≈Ω√°dn√© sc√©n√°≈ôe zat√≠m nebyly pou≈æity.</p>';
            }
            
            const scenarios = Object.entries(scenarioStats)
                .map(([name, stats]) => ({
                    name,
                    ...stats,
                    successRate: stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.total - a.total);
            
            const scenarioNames = {
                'zasilkovna': 'üì¶ Z√°silkovna',
                'prislusenstvi': 'üîå P≈ô√≠slu≈°enstv√≠',
                'novy-telefon': 'üì± Nov√Ω telefon',
                'vykup': 'üí∞ V√Ωkup',
                'jen-se-kouka': 'üëÄ Jen se kouk√°',
                'konzultace': 'üí¨ Konzultace',
                'servis': 'üîß Servis'
            };
            
            return `
                <table class="scenario-table">
                    <thead>
                        <tr>
                            <th>Sc√©n√°≈ô</th>
                            <th>Celkem</th>
                            <th>Prod√°no</th>
                            <th>Neprod√°no</th>
                            <th>√öspƒõ≈°nost</th>
                            <th>Akce</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scenarios.map(scenario => `
                            <tr>
                                <td><strong>${scenarioNames[scenario.name] || scenario.name}</strong></td>
                                <td>${scenario.total}</td>
                                <td style="color: #2ed573;">${scenario.sold}</td>
                                <td style="color: #ff4757;">${scenario.notSold}</td>
                                <td>
                                    ${scenario.successRate}%
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${scenario.successRate}%"></div>
                                    </div>
                                </td>
                                <td>
                                    <button onclick="showScenarioDetails('${scenario.name}')" style="
                                        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                        color: white; border: none; padding: 0.4rem 0.8rem; 
                                        border-radius: 6px; cursor: pointer; font-size: 0.8rem;
                                        font-weight: 500; transition: all 0.3s ease; white-space: nowrap;
                                    " onmouseover="this.style.transform='translateY(-1px)'" 
                                       onmouseout="this.style.transform='translateY(0px)'">
                                        üîç Detaily
                                    </button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Popul√°rn√≠ polo≈æky
        function renderPopularItems(popularItems) {
            const items = Object.entries(popularItems)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            const total = Object.values(popularItems).reduce((sum, count) => sum + count, 0);
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    ${items.map(([item, count]) => {
                        const percentage = ((count / total) * 100).toFixed(1);
                        return `
                            <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 10px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary-color);">${count}</div>
                                <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 0.5rem;">${item}</div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">${percentage}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Pou≈æ√≠v√°n√≠ slev
        function renderDiscountUsage(discountUsage) {
            const total = discountUsage.used + discountUsage.notUsed;
            const usedPercentage = total > 0 ? ((discountUsage.used / total) * 100).toFixed(1) : 0;
            const notUsedPercentage = total > 0 ? ((discountUsage.notUsed / total) * 100).toFixed(1) : 0;
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                    <div style="text-align: center; padding: 2rem; background: rgba(46, 213, 115, 0.1); border-radius: 15px;">
                        <div style="font-size: 3rem; color: #2ed573; margin-bottom: 1rem;">${discountUsage.used}</div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Sleva pou≈æita</div>
                        <div style="color: var(--text-secondary);">${usedPercentage}% p≈ô√≠pad≈Ø</div>
                    </div>
                    
                    <div style="text-align: center; padding: 2rem; background: rgba(255, 71, 87, 0.1); border-radius: 15px;">
                        <div style="font-size: 3rem; color: #ff4757; margin-bottom: 1rem;">${discountUsage.notUsed}</div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Sleva nepou≈æita</div>
                        <div style="color: var(--text-secondary);">${notUsedPercentage}% p≈ô√≠pad≈Ø</div>
                    </div>
                </div>
            `;
        }

        // Debug funkce
        function debugLoadData() {
            console.log('üîç DEBUG: Kontroluji localStorage...');
            console.log('üîç Aktu√°ln√≠ filtry:', {
                ƒçasov√Ω: currentTimeFilter,
                prodejna: currentStoreFilter
            });
            
            const localData = localStorage.getItem('sales_sessions');
            console.log('üîç Raw localStorage data:', localData);
            
            try {
                const parsed = JSON.parse(localData || '[]');
                console.log('üîç Parsed data:', parsed);
                console.log('üîç Poƒçet sessions:', parsed.length);
                
                if (parsed.length > 0) {
                    console.log('üîç Prvn√≠ session:', parsed[0]);
                    console.log('üîç Posledn√≠ session:', parsed[parsed.length - 1]);
                    
                    // Anal√Ωza prodejc≈Ø
                    const sellers = new Set();
                    parsed.forEach(session => {
                        const seller = session.seller || session.sellerId || 'Unknown';
                        sellers.add(seller);
                    });
                    console.log('üîç Unik√°tn√≠ prodejci v datech:', Array.from(sellers));
                    
                    // Zkontroluj duplicity
                    const sellerCounts = {};
                    parsed.forEach(session => {
                        const seller = session.seller || session.sellerId || 'Unknown';
                        sellerCounts[seller] = (sellerCounts[seller] || 0) + 1;
                    });
                    console.log('üîç Poƒçty sessions podle prodejc≈Ø:', sellerCounts);
                    
                    // Detekce mo≈æn√Ωch duplicit
                    const possibleDuplicates = [];
                    const checkPairs = [
                        ['Tom√°≈° Valenta', 'tvalenta'],
                        ['Admin Administr√°tor', 'admin'],
                        ['≈†imon Gabriel', 'sgabriel']
                    ];
                    
                    checkPairs.forEach(([fullName, username]) => {
                        if (sellerCounts[fullName] && sellerCounts[username]) {
                            possibleDuplicates.push({
                                fullName,
                                username,
                                fullNameCount: sellerCounts[fullName],
                                usernameCount: sellerCounts[username],
                                total: sellerCounts[fullName] + sellerCounts[username]
                            });
                        }
                    });
                    
                    if (possibleDuplicates.length > 0) {
                        console.warn('‚ö†Ô∏è NALEZENY DUPLICITN√ç PRODEJCI:');
                        possibleDuplicates.forEach(dup => {
                            console.warn(`   üë§ ${dup.fullName} (${dup.fullNameCount}) + ${dup.username} (${dup.usernameCount}) = ${dup.total} sessions`);
                        });
                        console.warn('üí° Pou≈æijte tlaƒç√≠tko "üîß Opravit duplicity" pro slouƒçen√≠');
                    } else {
                        console.log('‚úÖ ≈Ω√°dn√© duplicitn√≠ prodejci nenalezeni');
                    }
                }
            } catch (e) {
                console.error('üîç Chyba p≈ôi parsov√°n√≠:', e);
            }
            
            // Naƒçti prodejny znovu a vynut√≠ naƒçten√≠
            loadAvailableStores();
            loadAnalytics();
        }

        // Spr√°va jmen prodejc≈Ø
        function showSellerNameManager() {
            // Naƒçti aktu√°ln√≠ prodejce z dat
            const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
            const sellers = new Set();
            
            localData.forEach(session => {
                const seller = session.seller || session.sellerId || 'Unknown';
                if (seller && seller !== 'Unknown') {
                    sellers.add(seller);
                }
            });
            
            const sellerList = Array.from(sellers).sort();
            console.log('üë§ Nalezen√≠ prodejci:', sellerList);
            
            // Naƒçti aktu√°ln√≠ mapov√°n√≠ jmen z localStorage
            const customDisplayNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #ffffff); border-radius: 15px; padding: 2rem; 
                    max-width: 600px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 80vh; overflow-y: auto;
                ">
                    <h3 style="color: var(--text-primary, #333); margin: 0 0 1.5rem 0; text-align: center;">
                        üë§ Spr√°va jmen prodejc≈Ø
                    </h3>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(108, 92, 231, 0.1); border-radius: 8px; border-left: 4px solid #6c5ce7;">
                        <h4 style="color: #6c5ce7; margin: 0 0 0.5rem 0; font-size: 0.9rem;">‚ÑπÔ∏è Jak to funguje</h4>
                        <p style="margin: 0; color: var(--text-primary); font-size: 0.85rem; line-height: 1.4;">
                            Zde m≈Ø≈æete nastavit zobrazovac√≠ jm√©na pro prodejce. Zmƒõny se projev√≠ okam≈æitƒõ v analytice.
                        </p>
                    </div>
                    
                    <div id="seller-name-list" style="margin-bottom: 2rem;">
                        ${sellerList.map(seller => {
                            const currentDisplayName = customDisplayNames[seller] || getDefaultDisplayName(seller);
                            return `
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <div style="flex: 1;">
                                        <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Username:</div>
                                        <div style="color: var(--text-primary); font-weight: 500; font-family: monospace;">${seller}</div>
                                    </div>
                                    <div style="flex: 2;">
                                        <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Zobrazovan√© jm√©no:</div>
                                        <input type="text" 
                                               value="${currentDisplayName}" 
                                               data-seller="${seller}"
                                               style="width: 100%; padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; background: rgba(255,255,255,0.1); color: var(--text-primary);"
                                               placeholder="Zadejte cel√© jm√©no">
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="closeSellerNameManager()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary, #333); 
                            border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; 
                            border-radius: 8px; cursor: pointer; font-weight: 500;
                        ">Zru≈°it</button>
                        
                        <button onclick="saveSellerNames()" style="
                            background: #6c5ce7; color: white; border: none; 
                            padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;
                        ">üíæ Ulo≈æit zmƒõny</button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            modal.id = 'seller-name-modal';
            document.body.appendChild(modal);
            
            // Zav≈ôen√≠ na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Z√≠sk√°n√≠ v√Ωchoz√≠ho zobrazovac√≠ho jm√©na
        function getDefaultDisplayName(seller) {
            // Naƒçti custom jm√©na nejd≈ô√≠ve
            const customDisplayNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
            if (customDisplayNames[seller]) {
                return customDisplayNames[seller];
            }
            
                         // Fallback na v√Ωchoz√≠ jm√©na
            const defaultDisplayNames = {
                'tvalenta': 'Tom√°≈° Valenta',
                'admin': 'Admin Administr√°tor', 
                'sgabriel': '≈†imon Gabriel',
                'malek': 'Pavel Malek',  // P≈ôedpokl√°dan√° hodnota - zmƒõnit p≈ôes "üë§ Spr√°va jmen"
            };
            
            return defaultDisplayNames[seller] || (seller.charAt(0).toUpperCase() + seller.slice(1));
        }

        // Zav≈ôen√≠ spr√°vce jmen
        function closeSellerNameManager() {
            const modal = document.getElementById('seller-name-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Ulo≈æen√≠ jmen prodejc≈Ø
        function saveSellerNames() {
            const inputs = document.querySelectorAll('#seller-name-list input[data-seller]');
            const customDisplayNames = {};
            
            inputs.forEach(input => {
                const seller = input.dataset.seller;
                const displayName = input.value.trim();
                if (displayName && displayName !== getDefaultDisplayName(seller)) {
                    customDisplayNames[seller] = displayName;
                }
            });
            
            // Ulo≈æ do localStorage
            localStorage.setItem('seller_display_names', JSON.stringify(customDisplayNames));
            
            console.log('üë§ Ulo≈æen√° jm√©na prodejc≈Ø:', customDisplayNames);
            
            // Zav≈ôi modal
            closeSellerNameManager();
            
            // Refresh analytiky
            loadAnalytics();
            
            alert(`‚úÖ Jm√©na prodejc≈Ø byla ulo≈æena!\n\nChanges saved: ${Object.keys(customDisplayNames).length} custom names`);
        }

        // Force delete v≈°ech dat
        function forceDeleteAllData() {
            if (!confirm('üí• VYMAZAT V≈†ECHNA DATA\n\nToto OKAM≈ΩITƒö sma≈æe:\n‚Ä¢ V≈°echna localStorage data\n‚Ä¢ Custom jm√©na prodejc≈Ø\n‚Ä¢ Aktivuje Local Mode (ignoruje server)\n\nTato akce je NEVRATN√Å!\n\nOpravdu pokraƒçovat?')) {
                return;
            }
            
            if (!confirm('üî¥ FIN√ÅLN√ç POTVRZEN√ç\n\nPo kliknut√≠ na OK budou V≈†ECHNA LOK√ÅLN√ç DATA SMAZ√ÅNA a server bude IGNOROV√ÅN!\n\nJste si 100% jisti?')) {
                return;
            }
            
            console.log('üí• Force delete v≈°ech dat...');
            
            // Sma≈æ kompletnƒõ localStorage
            localStorage.setItem('sales_sessions', '[]');
            localStorage.removeItem('seller_display_names');
            
            // Aktivuj Local Mode
            localStorage.setItem('force_local_mode', 'true');
            localStorage.setItem('local_mode_reason', 'Manu√°lnƒõ vymaz√°no u≈æivatelem - ignoruji server data');
            
            console.log('üí• V≈°echna data smaz√°na, Local Mode aktivov√°n');
            
            // Refresh cel√© str√°nky
            alert('‚úÖ V≈†ECHNA DATA BYLA SMAZ√ÅNA!\n\nAktivov√°n Local Mode - server se ignoruje.\nStr√°nka se obnov√≠ s pr√°zdn√Ωmi daty.');
            
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // Deaktivace Local Mode
        function deactivateLocalMode() {
            if (confirm('Opravdu chcete deaktivovat Local Mode?\n\nAnalytika se p≈ôepne zpƒõt na server data.')) {
                localStorage.removeItem('force_local_mode');
                localStorage.removeItem('local_mode_reason');
                console.log('üåê Local Mode deaktivov√°n');
                
                // Refresh analytiky
                loadAnalytics();
                
                alert('‚úÖ Local Mode deaktivov√°n\n\nAnalytika nyn√≠ pou≈æ√≠v√° server data.');
            }
        }

        // Toggle pokroƒçil√Ωch n√°stroj≈Ø
        function toggleAdminTools() {
            const content = document.getElementById('admin-tools-content');
            const arrow = document.getElementById('admin-tools-arrow');
            const toggle = document.getElementById('admin-tools-toggle');
            
            if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
                // Otev≈ôi
                content.style.maxHeight = '200px';
                arrow.style.transform = 'rotate(180deg)';
                toggle.style.background = 'rgba(255,255,255,0.15)';
                toggle.style.color = 'var(--text-primary)';
            } else {
                // Zav≈ôi
                content.style.maxHeight = '0px';
                arrow.style.transform = 'rotate(0deg)';
                toggle.style.background = 'rgba(255,255,255,0.1)';
                toggle.style.color = 'var(--text-secondary)';
            }
        }

        // Reset v≈°ech filtr≈Ø
        function resetAllFilters() {
            console.log('üîÑ Resetuji v≈°echny filtry...');
            
            // Reset filtr≈Ø
            currentTimeFilter = 'all';
            currentStoreFilter = 'all';
            
            // Aktivuj spr√°vn√° tlaƒç√≠tka
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.store-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Aktivuj "V≈°echna data"
            const allTimeBtn = Array.from(document.querySelectorAll('.time-filter')).find(btn => 
                btn.textContent.includes('V≈°echna data')
            );
            if (allTimeBtn) allTimeBtn.classList.add('active');
            
            // Aktivuj "V≈°echny prodejny"
            const allStoreBtn = Array.from(document.querySelectorAll('.store-filter')).find(btn => 
                btn.textContent.includes('V≈°echny prodejny')
            );
            if (allStoreBtn) allStoreBtn.classList.add('active');
            
            // Naƒçti data
            loadAnalytics();
        }

        // Nov√° funkce pro normalizaci existuj√≠c√≠ch dat
        function cleanDuplicateSellerData() {
            if (!confirm('Opravdu chcete normalizovat jm√©na prodejc≈Ø v existuj√≠c√≠ch datech?\n\nToto slouƒç√≠ duplicitn√≠ z√°znamy pro stejn√© prodejce.')) {
                return;
            }
            
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                
                // Mapov√°n√≠ pro normalizaci jmen
                const nameMapping = {
                    'Tom√°≈° Valenta': 'tvalenta',
                    'Admin Administr√°tor': 'admin',
                    '≈†imon Gabriel': 'sgabriel',
                };
                
                let changedCount = 0;
                
                // Projdi v≈°echny sessions a normalizuj jm√©na
                localData.forEach(session => {
                    const originalSeller = session.seller || session.sellerId;
                    
                    if (nameMapping[originalSeller]) {
                        // Aktualizuj seller i sellerId
                        session.seller = nameMapping[originalSeller];
                        session.sellerId = nameMapping[originalSeller];
                        changedCount++;
                        console.log(`‚úÖ Normalizov√°no: "${originalSeller}" ‚Üí "${nameMapping[originalSeller]}"`);
                    }
                });
                
                // Ulo≈æ opraven√° data
                localStorage.setItem('sales_sessions', JSON.stringify(localData));
                
                console.log(`üîß Normalizace dokonƒçena! Zmƒõnƒõno ${changedCount} z√°znam≈Ø.`);
                
                if (changedCount > 0) {
                    alert(`‚úÖ Normalizace dokonƒçena!\n\nZmƒõnƒõno ${changedCount} z√°znam≈Ø.\n\nDuplicit√© prodejci (nap≈ô. "Tom√°≈° Valenta" + "tvalenta") jsou nyn√≠ slouƒçeni pod jednotn√Ωm jm√©nem.\n\nAnalytika se automaticky obnov√≠.`);
                } else {
                    alert('‚ÑπÔ∏è ≈Ω√°dn√© duplicity k opravƒõ nebyly nalezeny.\n\nData jsou ji≈æ v po≈ô√°dku.');
                }
                
                // Aktualizuj seznam prodejen a refresh analytiky
                loadAvailableStores();
                loadAnalytics();
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi normalizaci dat:', error);
                alert('‚ùå Chyba p≈ôi normalizaci dat!');
            }
        }

        // Test serveru
        async function testServerConnection() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Testuji...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/sales-data?type=stats');
                
                if (response.ok) {
                    btn.textContent = '‚úÖ Server OK';
                    btn.style.background = '#2ed573';
                    console.log('‚úÖ Server je dostupn√Ω');
                    
                    const data = await response.json();
                    console.log('üìä Server data:', data);
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
            } catch (error) {
                btn.textContent = '‚ùå Server nedostupn√Ω';
                btn.style.background = '#ff4757';
                console.error('‚ùå Server test failed:', error);
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '#2ed573';
            }, 3000);
        }

        // Reset server dat
        async function resetServerData() {
            if (!confirm('‚ö†Ô∏è POZOR: Reset serveru\n\nToto KOMPLETNƒö SMA≈ΩE v≈°echna data na serveru!\n\nTato akce je NEVRATN√Å!\n\nOpravdu chcete pokraƒçovat?')) {
                return;
            }
            
            if (!confirm('üî¥ FIN√ÅLN√ç POTVRZEN√ç\n\nPo kliknut√≠ na OK budou V≈†ECHNA DATA NA SERVERU SMAZ√ÅNA!\n\nTuto akci NELZE vz√≠t zpƒõt!\n\nJste si jisti?')) {
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'üî• Ma≈æu server...';
            btn.disabled = true;
            btn.style.background = '#e74c3c';
            
            try {
                console.log('üåê Resetuji server data...');
                
                // Nejd≈ô√≠v naƒçti v≈°echna data ze serveru
                const response = await fetch('/api/sales-data');
                
                if (!response.ok) {
                    throw new Error(`Nelze naƒç√≠st data ze serveru: ${response.status}`);
                }
                
                const serverData = await response.json();
                
                if (!serverData.success || !serverData.salesData) {
                    throw new Error('Server nevr√°til validn√≠ data');
                }
                
                const allSessions = serverData.salesData;
                console.log(`üóëÔ∏è Ma≈æu ${allSessions.length} sessions ze serveru...`);
                
                let deletedCount = 0;
                let errorCount = 0;
                
                // Sma≈æ v≈°echny sessions jedna po druh√©
                for (const session of allSessions) {
                    try {
                        const sessionId = session.id || session.timestamp;
                        const deleteResponse = await fetch(`/api/sales-data?id=${encodeURIComponent(sessionId)}`, {
                            method: 'DELETE',
                            headers: { 'Content-Type': 'application/json' }
                        });
                        
                        if (deleteResponse.ok) {
                            deletedCount++;
                            btn.textContent = `üî• Ma≈æu server (${deletedCount}/${allSessions.length})`;
                        } else {
                            errorCount++;
                            console.warn(`‚ö†Ô∏è Nepoda≈ôilo se smazat session ${sessionId}`);
                        }
                    } catch (deleteError) {
                        errorCount++;
                        console.warn('‚ö†Ô∏è Chyba p≈ôi maz√°n√≠ session:', deleteError);
                    }
                }
                
                console.log(`‚úÖ Server reset dokonƒçen: ${deletedCount} smaz√°no, ${errorCount} chyb`);
                
                // Kompletnƒõ sma≈æ v≈°echny lok√°ln√≠ data
                localStorage.setItem('sales_sessions', '[]');
                localStorage.removeItem('seller_display_names');
                console.log('‚úÖ localStorage kompletnƒõ vymaz√°n');
                
                if (errorCount === 0) {
                    btn.textContent = '‚úÖ Kompletn√≠ reset';
                    btn.style.background = '#2ed573';
                    
                    setTimeout(() => {
                        alert(`‚úÖ Server i localStorage byly kompletnƒõ resetov√°ny!\n\nSmaz√°no ${deletedCount} sessions.\n\nStr√°nka se obnov√≠.`);
                        location.reload();
                    }, 1000);
                } else {
                    btn.textContent = `‚ö†Ô∏è Reset s ${errorCount} chybami`;
                    btn.style.background = '#ff9500';
                    
                    setTimeout(() => {
                        alert(`‚ö†Ô∏è Reset dokonƒçen s chybami!\n\nSmaz√°no: ${deletedCount}/${allSessions.length} sessions\nChyby: ${errorCount}\n\nStr√°nka se obnov√≠.`);
                        location.reload();
                    }, 1000);
                }
                
            } catch (error) {
                console.error('‚ùå Reset server failed:', error);
                btn.textContent = '‚ùå Reset selhal';
                btn.style.background = '#ff4757';
                
                const forceLocal = confirm('‚ùå Nepoda≈ôilo se resetovat server!\n\nServer m≈Ø≈æe b√Ωt offline nebo nepodporuje reset endpoint.\n\nChcete smazat pouze lok√°ln√≠ data a aktivovat Local Mode?');
                
                if (forceLocal) {
                    // Sma≈æ lok√°ln√≠ data
                    localStorage.setItem('sales_sessions', '[]');
                    localStorage.removeItem('seller_display_names');
                    
                    // Aktivuj Local Mode
                    localStorage.setItem('force_local_mode', 'true');
                    localStorage.setItem('local_mode_reason', 'Server nepodporuje reset - pracuji pouze lok√°lnƒõ');
                    
                    btn.textContent = '‚úÖ Local reset';
                    btn.style.background = '#ff9500';
                    
                    // Refresh analytiky
                    loadAvailableStores();
                    loadAnalytics();
                    
                    alert('‚úÖ Lok√°ln√≠ data byla smaz√°na!\n\nAktivov√°n Local Mode - analytika pou≈æ√≠v√° pouze localStorage.');
                }
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '#e74c3c';
            }, 5000);
        }

        // Synchronizace se serverem
        async function syncWithServer() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Synchronizuji...';
            btn.disabled = true;
            
            try {
                // Naƒçti data ze serveru
                const response = await fetch('/api/sales-data');
                
                if (response.ok) {
                    const serverData = await response.json();
                    
                    if (serverData.success && serverData.salesData) {
                        // Ulo≈æ server data do localStorage
                        localStorage.setItem('sales_sessions', JSON.stringify(serverData.salesData));
                        console.log('‚úÖ Data synchronizov√°na ze serveru:', serverData.salesData.length, 'sessions');
                        
                        btn.textContent = '‚úÖ Synchronizov√°no';
                        btn.style.background = '#2ed573';
                        
                        // Deaktivuj Local Mode pokud je aktivn√≠
                        if (localStorage.getItem('force_local_mode') === 'true') {
                            localStorage.removeItem('force_local_mode');
                            localStorage.removeItem('local_mode_reason');
                            console.log('üåê Local Mode automaticky deaktivov√°n po √∫spƒõ≈°n√© synchronizaci');
                        }
                        
                        // Aktualizuj seznam prodejen a refresh analytiky
                        loadAvailableStores();
                        loadAnalytics();
                    } else {
                        throw new Error('Server nevr√°til validn√≠ data');
                    }
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
                
                // Zkus poslat lok√°ln√≠ data na server
                try {
                    const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                    if (localData.length > 0) {
                        console.log('üì§ Pos√≠l√°m lok√°ln√≠ data na server...');
                        
                        for (const session of localData) {
                            await fetch('/api/sales-data', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(session)
                            });
                        }
                        
                        btn.textContent = '‚úÖ Lok√°ln√≠ ‚Üí Server';
                        btn.style.background = '#2ed573';
                    } else {
                        throw error;
                    }
                } catch (uploadError) {
                    btn.textContent = '‚ùå Sync selhal';
                    btn.style.background = '#ff4757';
                }
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '#ff9500';
            }, 3000);
        }

        // Modal pro smaz√°n√≠ dat
        function showDeleteDataModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 1rem;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #ffffff); border-radius: 15px; padding: 2rem; 
                    max-width: 500px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                ">
                    <h3 style="color: var(--text-primary, #333); margin: 0 0 1.5rem 0; text-align: center;">
                        üóëÔ∏è Smazat prodejn√≠ data
                    </h3>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-color, #ff1493); margin-bottom: 1rem;">Vyberte obdob√≠:</h4>
                        
                        <div style="display: block;">
                            <div class="radio-option" data-value="today" style="
                                display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
                                padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; 
                                margin-bottom: 0.75rem; border: 2px solid transparent; transition: all 0.3s ease;
                            ">
                                <div class="radio-circle" style="
                                    width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
                                    position: relative; background: white;
                                ">
                                    <div class="radio-dot" style="
                                        width: 8px; height: 8px; background: #ff1493; border-radius: 50%; 
                                        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                        opacity: 0; transition: opacity 0.3s ease;
                                    "></div>
                                </div>
                                <span style="color: var(--text-primary, #333); font-weight: 500;">Pouze dne≈°n√≠ data</span>
                            </div>
                            
                            <div class="radio-option" data-value="week" style="
                                display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
                                padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; 
                                margin-bottom: 0.75rem; border: 2px solid transparent; transition: all 0.3s ease;
                            ">
                                <div class="radio-circle" style="
                                    width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
                                    position: relative; background: white;
                                ">
                                    <div class="radio-dot" style="
                                        width: 8px; height: 8px; background: #ff1493; border-radius: 50%; 
                                        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                        opacity: 0; transition: opacity 0.3s ease;
                                    "></div>
                                </div>
                                <span style="color: var(--text-primary, #333); font-weight: 500;">Tento t√Ωden</span>
                            </div>
                            
                            <div class="radio-option" data-value="month" style="
                                display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
                                padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; 
                                margin-bottom: 0.75rem; border: 2px solid transparent; transition: all 0.3s ease;
                            ">
                                <div class="radio-circle" style="
                                    width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
                                    position: relative; background: white;
                                ">
                                    <div class="radio-dot" style="
                                        width: 8px; height: 8px; background: #ff1493; border-radius: 50%; 
                                        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                        opacity: 0; transition: opacity 0.3s ease;
                                    "></div>
                                </div>
                                <span style="color: var(--text-primary, #333); font-weight: 500;">Tento mƒõs√≠c</span>
                            </div>
                            
                            <div class="radio-option" data-value="all" style="
                                display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
                                padding: 1rem; background: rgba(255,71,87,0.1); border-radius: 8px; 
                                border: 2px solid rgba(255,71,87,0.3); transition: all 0.3s ease;
                            ">
                                <div class="radio-circle" style="
                                    width: 18px; height: 18px; border: 2px solid #ff4757; border-radius: 50%; 
                                    position: relative; background: white;
                                ">
                                    <div class="radio-dot" style="
                                        width: 8px; height: 8px; background: #ff4757; border-radius: 50%; 
                                        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                        opacity: 0; transition: opacity 0.3s ease;
                                    "></div>
                                </div>
                                <span style="color: #ff4757; font-weight: 600;">‚ö†Ô∏è V≈°echna data (POZOR!)</span>
                            </div>
                        </div>
                        
                        <div id="selected-info" style="
                            margin-top: 1rem; padding: 0.75rem; background: rgba(33, 150, 243, 0.1); 
                            border-radius: 8px; border-left: 4px solid #2196F3; display: none;
                        ">
                            <span style="color: #2196F3; font-weight: 500;">üìã Vybr√°no: </span>
                            <span id="selected-text" style="color: var(--text-primary, #333);"></span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="closeDeleteModal()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary, #333); 
                            border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; 
                            border-radius: 8px; cursor: pointer; font-weight: 500;
                        ">Zru≈°it</button>
                        
                        <button id="confirm-delete-btn" onclick="confirmDeleteData(this)" style="
                            background: #cccccc; color: #666666; border: none; 
                            padding: 0.75rem 1.5rem; border-radius: 8px; cursor: not-allowed; font-weight: 600;
                        " disabled>üóëÔ∏è Smazat</button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            modal.id = 'delete-modal';
            document.body.appendChild(modal);
            
            // P≈ôidej event listenery pro radio buttony
            const radioOptions = modal.querySelectorAll('.radio-option');
            let selectedValue = null;
            
                         radioOptions.forEach(option => {
                 // Hover efekt
                 option.addEventListener('mouseenter', function() {
                     if (selectedValue !== this.dataset.value) {
                         this.style.background = this.dataset.value === 'all' 
                             ? 'rgba(255,71,87,0.15)' 
                             : 'rgba(255,255,255,0.1)';
                     }
                 });
                 
                 option.addEventListener('mouseleave', function() {
                     if (selectedValue !== this.dataset.value) {
                         this.style.background = this.dataset.value === 'all' 
                             ? 'rgba(255,71,87,0.1)' 
                             : 'rgba(255,255,255,0.05)';
                     }
                 });
                 
                 option.addEventListener('click', function() {
                    // Odznaƒç v≈°echny ostatn√≠
                    radioOptions.forEach(opt => {
                        opt.style.borderColor = 'transparent';
                        opt.style.background = opt.dataset.value === 'all' 
                            ? 'rgba(255,71,87,0.1)' 
                            : 'rgba(255,255,255,0.05)';
                        const dot = opt.querySelector('.radio-dot');
                        if (dot) dot.style.opacity = '0';
                    });
                    
                    // Oznaƒç aktu√°ln√≠
                    this.style.borderColor = this.dataset.value === 'all' ? '#ff4757' : '#2196F3';
                    this.style.background = this.dataset.value === 'all' 
                        ? 'rgba(255,71,87,0.2)' 
                        : 'rgba(33, 150, 243, 0.1)';
                    const dot = this.querySelector('.radio-dot');
                    if (dot) dot.style.opacity = '1';
                    
                    selectedValue = this.dataset.value;
                    
                    // Aktualizuj info a tlaƒç√≠tko
                    const infoDiv = modal.querySelector('#selected-info');
                    const textSpan = modal.querySelector('#selected-text');
                    const deleteBtn = modal.querySelector('#confirm-delete-btn');
                    
                    const optionTexts = {
                        today: 'Pouze dne≈°n√≠ data',
                        week: 'Tento t√Ωden',
                        month: 'Tento mƒõs√≠c',
                        all: 'V≈†ECHNA DATA (POZOR!)'
                    };
                    
                    if (infoDiv && textSpan && deleteBtn) {
                        infoDiv.style.display = 'block';
                        textSpan.textContent = optionTexts[selectedValue];
                        
                        deleteBtn.disabled = false;
                        deleteBtn.style.cursor = 'pointer';
                        deleteBtn.style.background = '#ff4757';
                        deleteBtn.style.color = 'white';
                    }
                    
                    console.log('üéØ Vybr√°no:', selectedValue);
                });
            });
            
            // Zav≈ôen√≠ na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            // Ulo≈æ selected value pro pozdƒõj≈°√≠ pou≈æit√≠
            modal.selectedValue = null;
            modal.getSelectedValue = () => selectedValue;
        }

        // Zav≈ôen√≠ delete modalu
        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Potvrzen√≠ smaz√°n√≠ dat
        async function confirmDeleteData(btn) {
            const modal = document.getElementById('delete-modal');
            const selectedValue = modal ? modal.getSelectedValue() : null;
            
            console.log('üóëÔ∏è Attempting delete with selection:', selectedValue);
            
            if (!selectedValue) {
                alert('Pros√≠m vyberte obdob√≠ pro smaz√°n√≠.');
                return;
            }
            
            const period = selectedValue;
            const periodNames = {
                today: 'dne≈°n√≠ data',
                week: 'data z tohoto t√Ωdne',
                month: 'data z tohoto mƒõs√≠ce',
                all: 'V≈†ECHNA DATA'
            };
            
            if (!confirm(`Opravdu chcete smazat ${periodNames[period]}?\n\nTato akce je nevratn√°!`)) {
                return;
            }
            
            btn.textContent = '‚è≥ Maz√°n√≠...';
            btn.disabled = true;
            
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                let filteredData = [...localData];
                const now = new Date();
                
                // Filtruj podle obdob√≠
                if (period !== 'all') {
                    filteredData = localData.filter(session => {
                        const sessionDate = new Date(session.timestamp);
                        
                        switch(period) {
                            case 'today':
                                return sessionDate.toDateString() !== now.toDateString();
                            case 'week':
                                const weekAgo = new Date(now);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                return sessionDate < weekAgo;
                            case 'month':
                                const monthAgo = new Date(now);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                return sessionDate < monthAgo;
                            default:
                                return true;
                        }
                    });
                } else {
                    filteredData = [];
                }
                
                const deletedCount = localData.length - filteredData.length;
                
                // 1. Ulo≈æ filtrovan√° data lok√°lnƒõ
                localStorage.setItem('sales_sessions', JSON.stringify(filteredData));
                
                // Pokud ma≈æeme v≈°echna data, vyma≈æ i dal≈°√≠ lok√°ln√≠ vƒõci
                if (period === 'all' && filteredData.length === 0) {
                    localStorage.removeItem('seller_display_names');
                    console.log('üóëÔ∏è Smaz√°na i custom jm√©na prodejc≈Ø');
                }
                
                console.log(`üóëÔ∏è Lok√°lnƒõ smaz√°no: ${deletedCount} sessions`);
                console.log(`üìä Lok√°lnƒõ z≈Øst√°v√°: ${filteredData.length} sessions`);
                
                // 2. Synchronizuj se serverem - skuteƒçn√© maz√°n√≠ p≈ôes server API
                btn.textContent = 'üåê Sync se serverem...';
                
                try {
                    console.log('üåê Ma≈æu data na serveru pomoc√≠ spr√°vn√©ho API...');
                    
                    // Najdi sessions k smaz√°n√≠ (ty co nejsou ve filteredData)
                    const sessionsToDelete = localData.filter(session => {
                        return !filteredData.some(kept => 
                            kept.id === session.id || 
                            (kept.timestamp === session.timestamp && kept.seller === session.seller)
                        );
                    });
                    
                    console.log('üóëÔ∏è Ma≈æu', sessionsToDelete.length, 'sessions na serveru');
                    
                    let serverDeletedCount = 0;
                    let serverErrors = 0;
                    
                    // Ma≈æ sessions pomoc√≠ spr√°vn√©ho server API
                    for (const session of sessionsToDelete) {
                        try {
                            // Pou≈æij ID session nebo timestamp jako fallback
                            const sessionId = session.id || session.timestamp;
                            
                            const deleteResponse = await fetch(`/api/sales-data?id=${encodeURIComponent(sessionId)}`, {
                                method: 'DELETE',
                                headers: { 'Content-Type': 'application/json' }
                            });
                            
                            if (deleteResponse.ok) {
                                serverDeletedCount++;
                                console.log(`‚úÖ Smaz√°na session ${sessionId}`);
                            } else {
                                serverErrors++;
                                console.warn(`‚ö†Ô∏è Nepoda≈ôilo se smazat session ${sessionId}:`, deleteResponse.status);
                            }
                        } catch (deleteError) {
                            serverErrors++;
                            console.warn('‚ö†Ô∏è Chyba p≈ôi maz√°n√≠ session:', deleteError);
                        }
                    }
                    
                    // Zobraz v√Ωsledek maz√°n√≠
                    if (serverDeletedCount === sessionsToDelete.length) {
                        btn.textContent = '‚úÖ Smaz√°no + Server OK';
                        btn.style.background = '#2ed573';
                        console.log(`‚úÖ V≈°echny sessions √∫spƒõ≈°nƒõ smaz√°ny na serveru (${serverDeletedCount})`);
                    } else if (serverDeletedCount > 0) {
                        btn.textContent = `‚ö†Ô∏è ƒå√°steƒçnƒõ smaz√°no (${serverDeletedCount}/${sessionsToDelete.length})`;
                        btn.style.background = '#ff9500';
                        console.log(`‚ö†Ô∏è ƒå√°steƒçnƒõ √∫spƒõ≈°n√© maz√°n√≠: ${serverDeletedCount} √∫spƒõ≈°n√Ωch, ${serverErrors} chyb`);
                    } else {
                        btn.textContent = '‚ùå Server maz√°n√≠ selhalo';
                        btn.style.background = '#ff4757';
                        console.log(`‚ùå Maz√°n√≠ na serveru selhalo: ${serverErrors} chyb`);
                    }
                    
                } catch (serverError) {
                    console.error('‚ùå Server sync error:', serverError);
                    btn.textContent = '‚ö†Ô∏è Server error - data smaz√°na lok√°lnƒõ';
                    btn.style.background = '#ff9500';
                    
                    // Pokus o obnovu synchronizace
                    setTimeout(() => {
                        const retry = confirm(`‚ö†Ô∏è PROBL√âM S MAZ√ÅN√çM NA SERVERU\n\nData byla smaz√°na lok√°lnƒõ, ale server m√° probl√©m.\n\nMo≈ænosti:\n‚úÖ OK = Zkusit znovu naƒç√≠st ze serveru (m≈Ø≈æe obnovu data)\n‚ùå Cancel = Ponechat lok√°ln√≠ zmƒõny\n\nChcete obnovit data ze serveru?`);
                        
                        if (retry) {
                            // Obnov data ze serveru
                            console.log('üîÑ Obnovuji data ze serveru...');
                            loadAnalytics();
                        } else {
                            console.log('üì± Ponech√°v√°m lok√°ln√≠ zmƒõny');
                            alert('‚ÑπÔ∏è Data z≈Øst√°vaj√≠ smaz√°na lok√°lnƒõ.\n\nPokud chcete synchronizovat se serverem, pou≈æijte "üîÑ Sync se serverem".');
                        }
                    }, 1000);
                }
                
                // 3. Aktualizuj UI
                loadAvailableStores();
                loadAnalytics();
                
                // Zav≈ôi modal
                closeDeleteModal();
                
                // Zobraz v√Ωsledek
                setTimeout(() => {
                    alert(`‚úÖ √öspƒõ≈°nƒõ smaz√°no ${deletedCount} z√°znam≈Ø!\n\n${filteredData.length} z√°znam≈Ø z≈Øst√°v√°.`);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi maz√°n√≠:', error);
                btn.textContent = '‚ùå Chyba p≈ôi maz√°n√≠';
                btn.style.background = '#ff4757';
                alert('‚ùå Chyba p≈ôi maz√°n√≠ dat!');
            }
        }

        // Zobrazen√≠ statusu ukl√°d√°n√≠ dat
        function showDataStatus() {
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                const customNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
                const statusDiv = document.getElementById('storage-info');
                
                if (statusDiv) {
                    const statusHTML = `
                        <div style="display: grid; gap: 0.5rem;">
                            <div>üíæ <strong>Lok√°ln√≠ √∫lo≈æi≈°tƒõ:</strong> ${localData.length} sessions + ${Object.keys(customNames).length} custom jmen</div>
                            <div>üåê <strong>Server:</strong> <span id="server-status">Testuji...</span></div>
                            <div>üìä <strong>Zdroj dat:</strong> <span id="data-source">Zji≈°≈•uji...</span></div>
                            <div>üîÑ <strong>Synchronizace:</strong> <span id="sync-status">Automatick√° p≈ôi ulo≈æen√≠</span></div>
                            <div style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--text-secondary);">
                                ‚úÖ Data jsou prim√°rnƒõ naƒç√≠t√°na ze serveru, localStorage slou≈æ√≠ jako z√°loha
                            </div>
                        </div>
                    `;
                    statusDiv.innerHTML = statusHTML;
                    
                    // Test server status a zjisti zdroj dat
                    checkDataSource();
                }
            } catch (error) {
                console.error('Chyba p≈ôi zobrazov√°n√≠ statusu dat:', error);
            }
        }

        // Zji≈°tƒõn√≠ zdroje dat
        async function checkDataSource() {
            const dataSourceElement = document.getElementById('data-source');
            const serverStatusElement = document.getElementById('server-status');
            
            // Kontrola Local Mode
            const forceLocalMode = localStorage.getItem('force_local_mode') === 'true';
            const localModeReason = localStorage.getItem('local_mode_reason') || 'Nezn√°m√Ω d≈Øvod';
            
            if (forceLocalMode) {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                
                if (serverStatusElement) {
                    serverStatusElement.innerHTML = '<span style="color: #ff9500;">üì± Ignorov√°no (Local Mode)</span>';
                }
                if (dataSourceElement) {
                    dataSourceElement.innerHTML = `<span style="color: #ff9500;">üì± Local Mode (${localData.length} sessions)</span>`;
                }
                return;
            }
            
            try {
                const response = await fetch('/api/sales-data', { 
                    method: 'GET',
                    signal: AbortSignal.timeout(5000)
                });
                
                if (response.ok) {
                    const serverData = await response.json();
                    const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                    
                    if (serverStatusElement) {
                        serverStatusElement.innerHTML = '<span style="color: #2ed573;">‚úÖ P≈ôipojen a funkƒçn√≠</span>';
                    }
                    
                    if (dataSourceElement) {
                        if (serverData.success && serverData.salesData) {
                            const serverCount = serverData.salesData.length;
                            const localCount = localData.length;
                            
                            if (serverCount === 0 && localCount === 0) {
                                dataSourceElement.innerHTML = '<span style="color: #ff9500;">üîç ≈Ω√°dn√° data (server ani local)</span>';
                            } else if (serverCount > 0) {
                                dataSourceElement.innerHTML = `<span style="color: #2ed573;">üåê Server (${serverCount} sessions)</span>`;
                            } else {
                                dataSourceElement.innerHTML = `<span style="color: #ff9500;">üíæ Local fallback (${localCount} sessions)</span>`;
                            }
                        } else {
                            dataSourceElement.innerHTML = '<span style="color: #ff4757;">‚ùå Server nevr√°til validn√≠ data</span>';
                        }
                    }
                } else {
                    throw new Error('Server error');
                }
            } catch (error) {
                if (serverStatusElement) {
                    serverStatusElement.innerHTML = '<span style="color: #ff9500;">‚ö†Ô∏è Offline (data v localStorage)</span>';
                }
                if (dataSourceElement) {
                    const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                    dataSourceElement.innerHTML = `<span style="color: #ff9500;">üíæ Local fallback (${localData.length} sessions)</span>`;
                }
            }
        }



        // Funkce pro kontrolu duplicit p≈ôi startu
        function checkForDuplicates() {
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                if (localData.length === 0) return;
                
                const sellerCounts = {};
                localData.forEach(session => {
                    const seller = session.seller || session.sellerId || 'Unknown';
                    sellerCounts[seller] = (sellerCounts[seller] || 0) + 1;
                });
                
                const checkPairs = [
                    ['Tom√°≈° Valenta', 'tvalenta'],
                    ['Admin Administr√°tor', 'admin'],
                    ['≈†imon Gabriel', 'sgabriel']
                ];
                
                const duplicates = [];
                checkPairs.forEach(([fullName, username]) => {
                    if (sellerCounts[fullName] && sellerCounts[username]) {
                        duplicates.push({ fullName, username });
                    }
                });
                
                if (duplicates.length > 0) {
                    // Zobraz upozornƒõn√≠ o duplicit√°ch
                    const analyticsContainer = document.querySelector('.analytics-container');
                    if (analyticsContainer) {
                        const warningDiv = document.createElement('div');
                        warningDiv.innerHTML = `
                            <div style="
                                background: rgba(255, 152, 0, 0.1); border: 1px solid #ff9800; 
                                border-radius: 10px; padding: 1rem; margin-bottom: 2rem; 
                                border-left: 4px solid #ff9800;
                            ">
                                <h4 style="color: #ff9800; margin: 0 0 0.5rem 0; font-size: 1rem;">
                                    ‚ö†Ô∏è Nalezeny duplicitn√≠ prodejci
                                </h4>
                                <p style="color: var(--text-primary); margin: 0 0 1rem 0; font-size: 0.9rem;">
                                    V datech se na≈°li duplicitn√≠ z√°znamy pro stejn√© prodejce. To zp≈Øsobuje rozdƒõlen√≠ statistik.
                                </p>
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                    <button onclick="cleanDuplicateSellerData()" style="
                                        background: #8e44ad; color: white; border: none; 
                                        padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; 
                                        font-size: 0.9rem; font-weight: 500;
                                    ">üîß Opravit automaticky</button>
                                    <button onclick="this.closest('div').style.display='none'" style="
                                        background: rgba(255,255,255,0.1); color: var(--text-primary); 
                                        border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; 
                                        border-radius: 6px; cursor: pointer; font-size: 0.9rem;
                                    ">Zav≈ô√≠t upozornƒõn√≠</button>
                                </div>
                            </div>
                        `;
                        
                        const filterSection = document.querySelector('.filter-section');
                        if (filterSection) {
                            analyticsContainer.insertBefore(warningDiv, filterSection);
                        }
                    }
                    
                    console.warn('‚ö†Ô∏è Nalezeny duplicitn√≠ prodejci p≈ôi startu aplikace');
                }
            } catch (error) {
                console.error('Chyba p≈ôi kontrole duplicit:', error);
            }
        }

        // Zobrazen√≠ detail≈Ø sc√©n√°≈ôe
        function showScenarioDetails(scenarioName) {
            console.log('üîç Zobrazuji detaily pro sc√©n√°≈ô:', scenarioName);
            
            try {
                // Naƒçti v≈°echna sales data (stejn√° logika jako v loadAnalytics)
                const localSalesData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                
                // Filtruj data podle aktu√°ln√≠ch filtr≈Ø + scenarioName
                const filteredData = localSalesData.filter(session => {
                    // Filtr sc√©n√°≈ôe
                    const sessionScenario = session.scenario || 'unknown';
                    if (sessionScenario !== scenarioName) return false;
                    
                    // ƒåasov√Ω filtr
                    if (currentTimeFilter !== 'all') {
                        const sessionDate = new Date(session.timestamp);
                        const now = new Date();
                        
                        if (!session.timestamp) return false;
                        
                        switch(currentTimeFilter) {
                            case 'today':
                                if (sessionDate.toDateString() !== now.toDateString()) return false;
                                break;
                            case 'week':
                                const weekAgo = new Date(now);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                if (sessionDate < weekAgo) return false;
                                break;
                            case 'month':
                                const monthAgo = new Date(now);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                if (sessionDate < monthAgo) return false;
                                break;
                        }
                    }
                    
                    // Filtr prodejny
                    if (currentStoreFilter !== 'all') {
                        const sessionStore = session.store || session.prodejna || 'Nezn√°m√° prodejna';
                        if (sessionStore !== currentStoreFilter) return false;
                    }
                    
                    return true;
                });
                
                console.log(`üîç Nalezeno ${filteredData.length} sessions pro sc√©n√°≈ô ${scenarioName}`);
                
                if (filteredData.length === 0) {
                    alert(`≈Ω√°dn√© sessions pro sc√©n√°≈ô "${scenarioName}" nebyly nalezeny s aktu√°ln√≠mi filtry.`);
                    return;
                }
                
                // Se≈ôaƒè sessions podle ƒçasu (nejnovƒõj≈°√≠ prvn√≠)
                filteredData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Vytvo≈ô modal
                showScenarioModal(scenarioName, filteredData);
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ detail≈Ø sc√©n√°≈ôe:', error);
                alert('Chyba p≈ôi naƒç√≠t√°n√≠ detail≈Ø sc√©n√°≈ôe!');
            }
        }

        // Modal s detaily sc√©n√°≈ôe  
        function showScenarioModal(scenarioName, sessions) {
            const scenarioNames = {
                'zasilkovna': 'üì¶ Z√°silkovna',
                'prislusenstvi': 'üîå P≈ô√≠slu≈°enstv√≠',
                'novy-telefon': 'üì± Nov√Ω telefon',
                'vykup': 'üí∞ V√Ωkup',
                'jen-se-kouka': 'üëÄ Jen se kouk√°',
                'konzultace': 'üí¨ Konzultace',
                'servis': 'üîß Servis'
            };
            
            const displayName = scenarioNames[scenarioName] || scenarioName;
            
            // Statistiky
            const soldSessions = sessions.filter(s => s.result === 'sold');
            const notSoldSessions = sessions.filter(s => s.result !== 'sold');
            const successRate = sessions.length > 0 ? ((soldSessions.length / sessions.length) * 100).toFixed(1) : 0;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.85); z-index: 10000; display: flex; 
                align-items: flex-start; justify-content: center; padding: 2rem 1rem; 
                overflow-y: auto; padding-top: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #ffffff); border-radius: 15px; padding: 2rem; 
                    max-width: 1200px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 20px 60px rgba(0,0,0,0.7); max-height: 90vh; overflow-y: auto;
                    position: relative;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--text-primary, #333); margin: 0; font-size: 1.8rem;">
                            ${displayName} - Detailn√≠ p≈ôehled
                        </h2>
                        <button onclick="closeScenarioModal()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary); 
                            border: 1px solid rgba(255,255,255,0.2); width: 40px; height: 40px;
                            border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold;
                            display: flex; align-items: center; justify-content: center;
                        ">‚úï</button>
                    </div>
                    
                    <!-- Rychl√© statistiky -->
                    <div style="
                        display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); 
                        gap: 1rem; margin-bottom: 2rem; padding: 1.5rem; 
                        background: rgba(255,255,255,0.03); border-radius: 12px;
                        border: 1px solid rgba(255,255,255,0.1);
                    ">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color, #ff1493);">${sessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Celkem sessions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #2ed573;">${soldSessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">√öspƒõ≈°n√Ωch</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #ff4757;">${notSoldSessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Ne√∫spƒõ≈°n√Ωch</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary, #333);">${successRate}%</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">√öspƒõ≈°nost</div>
                        </div>
                    </div>
                    
                    <!-- Filtry pro zobrazen√≠ -->
                    <div style="margin-bottom: 2rem; text-align: center;">
                        <div style="display: inline-flex; gap: 0.5rem; background: rgba(255,255,255,0.05); 
                                    border-radius: 25px; padding: 0.3rem; border: 1px solid rgba(255,255,255,0.1);">
                            <button id="show-all-sessions" onclick="filterSessionView('all')" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; 
                                border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">üìã V≈°echny (${sessions.length})</button>
                            <button id="show-sold-sessions" onclick="filterSessionView('sold')" style="
                                background: transparent; color: var(--text-primary); border: none; 
                                padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">‚úÖ √öspƒõ≈°n√© (${soldSessions.length})</button>
                            <button id="show-failed-sessions" onclick="filterSessionView('failed')" style="
                                background: transparent; color: var(--text-primary); border: none; 
                                padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">‚ùå Ne√∫spƒõ≈°n√© (${notSoldSessions.length})</button>
                        </div>
                    </div>
                    
                    <!-- Sessions seznam -->
                    <div id="sessions-container">
                        ${renderSessionsList(sessions, 'all')}
                    </div>
                </div>
            `;
            
            modal.className = 'scenario-modal';
            modal.id = 'scenario-detail-modal';
            document.body.appendChild(modal);
            
            // Ulo≈æit sessions data pro filtrov√°n√≠
            window.currentModalSessions = sessions;
            
            // Zav≈ôen√≠ na ESC
            document.addEventListener('keydown', handleModalKeydown);
            
            // Zav≈ôen√≠ na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeScenarioModal();
            });
        }

        // Renderov√°n√≠ seznamu sessions
        function renderSessionsList(sessions, filter) {
            let filteredSessions = sessions;
            
            if (filter === 'sold') {
                filteredSessions = sessions.filter(s => s.result === 'sold');
            } else if (filter === 'failed') {
                filteredSessions = sessions.filter(s => s.result !== 'sold');
            }
            
            if (filteredSessions.length === 0) {
                return `
                    <div style="text-align: center; padding: 3rem; color: var(--text-secondary);">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üì≠</div>
                        <h3>≈Ω√°dn√© sessions</h3>
                        <p>Pro aktu√°ln√≠ filtr nebyly nalezeny ≈æ√°dn√© sessions.</p>
                    </div>
                `;
            }
            
            return `
                <div style="display: grid; gap: 1rem;">
                    ${filteredSessions.map(session => renderSessionCard(session)).join('')}
                </div>
            `;
        }

        // Renderov√°n√≠ karty jedn√© session
        function renderSessionCard(session) {
            const isSuccess = session.result === 'sold';
            const seller = session.seller || session.sellerId || 'Nezn√°m√Ω';
            const displayName = getSellerDisplayName(seller);
            const timestamp = new Date(session.timestamp).toLocaleString('cs-CZ');
            const store = session.store || session.prodejna || 'Nezn√°m√° prodejna';
            
            // Z√≠skej d≈Øvod ne√∫spƒõchu z r≈Øzn√Ωch mo≈æn√Ωch field≈Ø
            const reason = getSessionReason(session);
            const lastStep = getSessionLastStep(session);
            const soldItems = session.soldItems || [];
            const discountUsed = session.discountUsed;
            
            return `
                <div style="
                    background: ${isSuccess ? 'rgba(46, 213, 115, 0.1)' : 'rgba(255, 71, 87, 0.1)'}; 
                    border: 1px solid ${isSuccess ? 'rgba(46, 213, 115, 0.3)' : 'rgba(255, 71, 87, 0.3)'};
                    border-left: 4px solid ${isSuccess ? '#2ed573' : '#ff4757'};
                    border-radius: 10px; padding: 1.5rem; position: relative;
                ">
                    <!-- Header s v√Ωsledkem -->
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
                        <div>
                            <div style="
                                display: inline-flex; align-items: center; gap: 0.5rem; 
                                background: ${isSuccess ? '#2ed573' : '#ff4757'}; 
                                color: white; padding: 0.3rem 0.8rem; border-radius: 15px; 
                                font-size: 0.8rem; font-weight: 600; margin-bottom: 0.5rem;
                            ">
                                ${isSuccess ? '‚úÖ PROD√ÅNO' : '‚ùå NEPROD√ÅNO'}
                            </div>
                            <div style="color: var(--text-primary); font-weight: 600; font-size: 1rem;">
                                üë§ ${displayName}
                            </div>
                        </div>
                        <div style="text-align: right; color: var(--text-secondary); font-size: 0.8rem;">
                            <div>üïí ${timestamp}</div>
                            <div>üè™ ${store}</div>
                        </div>
                    </div>
                    
                    <!-- Detaily session -->
                    <div style="display: grid; gap: 1rem;">
                        ${lastStep ? `
                            <div style="
                                background: rgba(255,255,255,0.05); padding: 1rem; border-radius: 8px;
                                border-left: 3px solid var(--primary-color, #ff1493);
                            ">
                                <div style="color: var(--primary-color, #ff1493); font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    üìç POSLEDN√ç KROK
                                </div>
                                <div style="color: var(--text-primary); font-size: 0.95rem;">
                                    ${lastStep}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${reason ? `
                            <div style="
                                background: rgba(255, 152, 0, 0.1); padding: 1rem; border-radius: 8px;
                                border-left: 3px solid #ff9800;
                            ">
                                <div style="color: #ff9800; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    üí≠ D≈ÆVOD / POZN√ÅMKA
                                </div>
                                <div style="color: var(--text-primary); font-style: italic; font-size: 0.95rem;">
                                    "${reason}"
                                </div>
                            </div>
                        ` : ''}
                        
                        ${isSuccess && soldItems.length > 0 ? `
                            <div style="
                                background: rgba(46, 213, 115, 0.1); padding: 1rem; border-radius: 8px;
                                border-left: 3px solid #2ed573;
                            ">
                                <div style="color: #2ed573; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    üõçÔ∏è PRODAN√â POLO≈ΩKY
                                </div>
                                <div style="color: var(--text-primary); font-size: 0.95rem;">
                                    ${soldItems.map(item => `‚Ä¢ ${item}`).join('<br>')}
                                </div>
                                ${discountUsed !== undefined ? `
                                    <div style="margin-top: 0.5rem; font-size: 0.85rem; color: var(--text-secondary);">
                                        üí∞ Sleva: ${discountUsed ? '‚úÖ Pou≈æita' : '‚ùå Nepou≈æita'}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        <!-- Debug info (skl√°dac√≠) -->
                        <div style="margin-top: 0.5rem;">
                            <button onclick="toggleSessionDebug('${session.timestamp}')" style="
                                background: rgba(255,255,255,0.05); color: var(--text-secondary); 
                                border: 1px solid rgba(255,255,255,0.1); padding: 0.3rem 0.6rem; 
                                border-radius: 15px; cursor: pointer; font-size: 0.75rem;
                                transition: all 0.3s ease;
                            " onmouseover="this.style.background='rgba(255,255,255,0.1)'" 
                               onmouseout="this.style.background='rgba(255,255,255,0.05)'">
                                üîß Technical details
                            </button>
                            <div id="debug-${session.timestamp}" style="
                                display: none; margin-top: 0.5rem; padding: 0.75rem; 
                                background: rgba(0,0,0,0.2); border-radius: 6px; 
                                font-family: monospace; font-size: 0.7rem; 
                                color: var(--text-secondary); max-height: 150px; overflow-y: auto;
                            ">
                                ${JSON.stringify(session, null, 2).replace(/\n/g, '<br>').replace(/ /g, '&nbsp;')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Z√≠sk√°n√≠ d≈Øvodu z session (z r≈Øzn√Ωch mo≈æn√Ωch field≈Ø)
        function getSessionReason(session) {
            // Zkus r≈Øzn√© mo≈æn√© fieldy pro d≈Øvod
            const possibleReasons = [
                session.reason,
                session.noDoprodejReason,
                session.zakaznikNechceReason,
                session.nevhodnyReason,
                session.nedostatekCasuReason,
                session.jizyReason,
                session.pocitReason,
                session.cenaReason,
                session.customReason
            ].filter(reason => reason && reason.trim() !== '');
            
            return possibleReasons.length > 0 ? possibleReasons[0] : null;
        }

        // Z√≠sk√°n√≠ posledn√≠ho kroku session
        function getSessionLastStep(session) {
            // Zkus r≈Øzn√© mo≈æn√© fieldy pro krok
            if (session.lastStep) return session.lastStep;
            if (session.currentStep) return session.currentStep;
            if (session.step) return session.step;
            
            // Dedukuj z dal≈°√≠ch fiel≈Ø
            if (session.phoneOnlyWithReason) return 'Pouze telefon prod√°n (bez p≈ô√≠slu≈°enstv√≠)';
            if (session.zakaznikNechce) return 'Z√°kazn√≠k nakonec nechce';
            if (session.scenario) return `Sc√©n√°≈ô: ${session.scenario}`;
            
            return null;
        }

        // Z√≠sk√°n√≠ zobrazovac√≠ho jm√©na prodejce
        function getSellerDisplayName(seller) {
            const customDisplayNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
            if (customDisplayNames[seller]) return customDisplayNames[seller];
            
            const defaultDisplayNames = {
                'tvalenta': 'Tom√°≈° Valenta',
                'admin': 'Admin Administr√°tor', 
                'sgabriel': '≈†imon Gabriel',
                'malek': 'Pavel Malek',
            };
            
            return defaultDisplayNames[seller] || (seller.charAt(0).toUpperCase() + seller.slice(1));
        }

        // Toggle debug informace pro session
        function toggleSessionDebug(timestamp) {
            const debugDiv = document.getElementById(`debug-${timestamp}`);
            if (debugDiv) {
                debugDiv.style.display = debugDiv.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Filtrov√°n√≠ view v modalu
        function filterSessionView(filter) {
            const container = document.getElementById('sessions-container');
            const sessions = window.currentModalSessions;
            
            if (container && sessions) {
                container.innerHTML = renderSessionsList(sessions, filter);
                
                // Aktualizuj aktivn√≠ tlaƒç√≠tko
                document.querySelectorAll('#scenario-detail-modal button[onclick^="filterSessionView"]').forEach(btn => {
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-primary)';
                });
                
                const activeButton = document.getElementById(
                    filter === 'all' ? 'show-all-sessions' : 
                    filter === 'sold' ? 'show-sold-sessions' : 'show-failed-sessions'
                );
                
                if (activeButton) {
                    activeButton.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                    activeButton.style.color = 'white';
                }
            }
        }

        // Zav≈ôen√≠ modal s detaily sc√©n√°≈ôe
        function closeScenarioModal() {
            const modal = document.getElementById('scenario-detail-modal');
            if (modal) {
                modal.remove();
                delete window.currentModalSessions;
                document.removeEventListener('keydown', handleModalKeydown);
            }
        }

        // Obsluha ESC kl√°vesy pro zav≈ôen√≠ modalu
        function handleModalKeydown(e) {
            if (e.key === 'Escape') {
                closeScenarioModal();
                closeSellerModal();
                closeStoreModal();
            }
        }

        // Zobrazen√≠ detail≈Ø prodejce
        function showSellerDetails(sellerUsername) {
            console.log('üë§ Zobrazuji detaily pro prodejce:', sellerUsername);
            
            try {
                const localSalesData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                
                // Filtruj data podle aktu√°ln√≠ch filtr≈Ø + prodejce
                const filteredData = localSalesData.filter(session => {
                    // Filtr prodejce
                    const sessionSeller = session.seller || session.sellerId || 'Unknown';
                    if (sessionSeller !== sellerUsername) return false;
                    
                    // ƒåasov√Ω filtr
                    if (currentTimeFilter !== 'all') {
                        const sessionDate = new Date(session.timestamp);
                        const now = new Date();
                        
                        if (!session.timestamp) return false;
                        
                        switch(currentTimeFilter) {
                            case 'today':
                                if (sessionDate.toDateString() !== now.toDateString()) return false;
                                break;
                            case 'week':
                                const weekAgo = new Date(now);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                if (sessionDate < weekAgo) return false;
                                break;
                            case 'month':
                                const monthAgo = new Date(now);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                if (sessionDate < monthAgo) return false;
                                break;
                        }
                    }
                    
                    // Filtr prodejny
                    if (currentStoreFilter !== 'all') {
                        const sessionStore = session.store || session.prodejna || 'Nezn√°m√° prodejna';
                        if (sessionStore !== currentStoreFilter) return false;
                    }
                    
                    return true;
                });
                
                console.log(`üë§ Nalezeno ${filteredData.length} sessions pro prodejce ${sellerUsername}`);
                
                if (filteredData.length === 0) {
                    alert(`≈Ω√°dn√© sessions pro prodejce "${sellerUsername}" nebyly nalezeny s aktu√°ln√≠mi filtry.`);
                    return;
                }
                
                // Se≈ôaƒè sessions podle ƒçasu (nejnovƒõj≈°√≠ prvn√≠)
                filteredData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Vytvo≈ô modal
                showSellerModal(sellerUsername, filteredData);
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ detail≈Ø prodejce:', error);
                alert('Chyba p≈ôi naƒç√≠t√°n√≠ detail≈Ø prodejce!');
            }
        }

        // Modal s detaily prodejce
        function showSellerModal(sellerUsername, sessions) {
            const displayName = getSellerDisplayName(sellerUsername);
            
            // Statistiky
            const soldSessions = sessions.filter(s => s.result === 'sold');
            const notSoldSessions = sessions.filter(s => s.result !== 'sold');
            const successRate = sessions.length > 0 ? ((soldSessions.length / sessions.length) * 100).toFixed(1) : 0;
            
            // Statistiky podle sc√©n√°≈ô≈Ø
            const scenarioStats = {};
            sessions.forEach(session => {
                const scenario = session.scenario || 'unknown';
                if (!scenarioStats[scenario]) {
                    scenarioStats[scenario] = { total: 0, sold: 0, notSold: 0 };
                }
                scenarioStats[scenario].total++;
                if (session.result === 'sold') {
                    scenarioStats[scenario].sold++;
                } else {
                    scenarioStats[scenario].notSold++;
                }
            });
            
            // Statistiky podle prodejen
            const storeStats = {};
            sessions.forEach(session => {
                const store = session.store || session.prodejna || 'Nezn√°m√° prodejna';
                if (!storeStats[store]) {
                    storeStats[store] = { total: 0, sold: 0, notSold: 0 };
                }
                storeStats[store].total++;
                if (session.result === 'sold') {
                    storeStats[store].sold++;
                } else {
                    storeStats[store].notSold++;
                }
            });
            
            // Pr≈Ømƒõrn√Ω ƒças session
            const sessionsWithTime = sessions.filter(s => s.sessionDurationMinutes && s.sessionDurationMinutes > 0);
            const avgTime = sessionsWithTime.length > 0 
                ? (sessionsWithTime.reduce((sum, s) => sum + s.sessionDurationMinutes, 0) / sessionsWithTime.length).toFixed(1)
                : 0;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.85); z-index: 10000; display: flex; 
                align-items: flex-start; justify-content: center; padding: 2rem 1rem; 
                overflow-y: auto; padding-top: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #ffffff); border-radius: 15px; padding: 2rem; 
                    max-width: 1200px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 20px 60px rgba(0,0,0,0.7); max-height: 90vh; overflow-y: auto;
                    position: relative;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--text-primary, #333); margin: 0; font-size: 1.8rem;">
                            üë§ ${displayName} - Detailn√≠ p≈ôehled
                        </h2>
                        <button onclick="closeSellerModal()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary); 
                            border: 1px solid rgba(255,255,255,0.2); width: 40px; height: 40px;
                            border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold;
                            display: flex; align-items: center; justify-content: center;
                        ">‚úï</button>
                    </div>
                    
                    <!-- Rychl√© statistiky -->
                    <div style="
                        display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
                        gap: 1rem; margin-bottom: 2rem; padding: 1.5rem; 
                        background: rgba(255,255,255,0.03); border-radius: 12px;
                        border: 1px solid rgba(255,255,255,0.1);
                    ">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color, #ff1493);">${sessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Celkem sessions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #2ed573;">${soldSessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">√öspƒõ≈°n√Ωch</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #ff4757;">${notSoldSessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Ne√∫spƒõ≈°n√Ωch</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary, #333);">${successRate}%</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">√öspƒõ≈°nost</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #ff9500;">${avgTime}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">√ò ƒåas (min)</div>
                        </div>
                    </div>
                    
                    <!-- Statistiky podle sc√©n√°≈ô≈Ø a prodejen -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                            <h4 style="color: var(--primary-color, #ff1493); margin: 0 0 1rem 0;">üì± Podle sc√©n√°≈ô≈Ø</h4>
                            ${Object.entries(scenarioStats).map(([scenario, stats]) => {
                                const scenarioNames = {
                                    'zasilkovna': 'üì¶ Z√°silkovna',
                                    'prislusenstvi': 'üîå P≈ô√≠slu≈°enstv√≠',
                                    'novy-telefon': 'üì± Nov√Ω telefon',
                                    'vykup': 'üí∞ V√Ωkup',
                                    'jen-se-kouka': 'üëÄ Jen se kouk√°',
                                    'konzultace': 'üí¨ Konzultace',
                                    'servis': 'üîß Servis'
                                };
                                const displayName = scenarioNames[scenario] || scenario;
                                const rate = stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(0) : 0;
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                        <span style="color: var(--text-primary); font-size: 0.9rem;">${displayName}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.8rem;">${stats.sold}/${stats.total} (${rate}%)</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                            <h4 style="color: var(--primary-color, #ff1493); margin: 0 0 1rem 0;">üè™ Podle prodejen</h4>
                            ${Object.entries(storeStats).map(([store, stats]) => {
                                const rate = stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(0) : 0;
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                        <span style="color: var(--text-primary); font-size: 0.9rem;">üè™ ${store}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.8rem;">${stats.sold}/${stats.total} (${rate}%)</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Filtry pro zobrazen√≠ -->
                    <div style="margin-bottom: 2rem; text-align: center;">
                        <div style="display: inline-flex; gap: 0.5rem; background: rgba(255,255,255,0.05); 
                                    border-radius: 25px; padding: 0.3rem; border: 1px solid rgba(255,255,255,0.1);">
                            <button id="show-all-seller-sessions" onclick="filterSellerSessionView('all')" style="
                                background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%); color: white; 
                                border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">üìã V≈°echny (${sessions.length})</button>
                            <button id="show-sold-seller-sessions" onclick="filterSellerSessionView('sold')" style="
                                background: transparent; color: var(--text-primary); border: none; 
                                padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">‚úÖ √öspƒõ≈°n√© (${soldSessions.length})</button>
                            <button id="show-failed-seller-sessions" onclick="filterSellerSessionView('failed')" style="
                                background: transparent; color: var(--text-primary); border: none; 
                                padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">‚ùå Ne√∫spƒõ≈°n√© (${notSoldSessions.length})</button>
                        </div>
                    </div>
                    
                    <!-- Sessions seznam -->
                    <div id="seller-sessions-container">
                        ${renderSessionsList(sessions, 'all')}
                    </div>
                </div>
            `;
            
            modal.className = 'seller-modal';
            modal.id = 'seller-detail-modal';
            document.body.appendChild(modal);
            
            // Ulo≈æit sessions data pro filtrov√°n√≠
            window.currentSellerModalSessions = sessions;
            
            // Zav≈ôen√≠ na ESC
            document.addEventListener('keydown', handleModalKeydown);
            
            // Zav≈ôen√≠ na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeSellerModal();
            });
        }

        // Filtrov√°n√≠ view v seller modalu
        function filterSellerSessionView(filter) {
            const container = document.getElementById('seller-sessions-container');
            const sessions = window.currentSellerModalSessions;
            
            if (container && sessions) {
                container.innerHTML = renderSessionsList(sessions, filter);
                
                // Aktualizuj aktivn√≠ tlaƒç√≠tko
                document.querySelectorAll('#seller-detail-modal button[onclick^="filterSellerSessionView"]').forEach(btn => {
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-primary)';
                });
                
                const activeButton = document.getElementById(
                    filter === 'all' ? 'show-all-seller-sessions' : 
                    filter === 'sold' ? 'show-sold-seller-sessions' : 'show-failed-seller-sessions'
                );
                
                if (activeButton) {
                    activeButton.style.background = 'linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%)';
                    activeButton.style.color = 'white';
                }
            }
        }

        // Zav≈ôen√≠ modal s detaily prodejce
        function closeSellerModal() {
            const modal = document.getElementById('seller-detail-modal');
            if (modal) {
                modal.remove();
                delete window.currentSellerModalSessions;
                document.removeEventListener('keydown', handleModalKeydown);
            }
        }

        // Zobrazen√≠ detail≈Ø prodejny
        function showStoreDetails(storeName) {
            console.log('üè™ Zobrazuji detaily pro prodejnu:', storeName);
            
            try {
                const localSalesData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                
                // Filtruj data podle aktu√°ln√≠ch filtr≈Ø + prodejny
                const filteredData = localSalesData.filter(session => {
                    // Filtr prodejny
                    const sessionStore = session.store || session.prodejna || 'Nezn√°m√° prodejna';
                    if (sessionStore !== storeName) return false;
                    
                    // ƒåasov√Ω filtr
                    if (currentTimeFilter !== 'all') {
                        const sessionDate = new Date(session.timestamp);
                        const now = new Date();
                        
                        if (!session.timestamp) return false;
                        
                        switch(currentTimeFilter) {
                            case 'today':
                                if (sessionDate.toDateString() !== now.toDateString()) return false;
                                break;
                            case 'week':
                                const weekAgo = new Date(now);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                if (sessionDate < weekAgo) return false;
                                break;
                            case 'month':
                                const monthAgo = new Date(now);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                if (sessionDate < monthAgo) return false;
                                break;
                        }
                    }
                    
                    return true;
                });
                
                console.log(`üè™ Nalezeno ${filteredData.length} sessions pro prodejnu ${storeName}`);
                
                if (filteredData.length === 0) {
                    alert(`≈Ω√°dn√© sessions pro prodejnu "${storeName}" nebyly nalezeny s aktu√°ln√≠mi filtry.`);
                    return;
                }
                
                // Se≈ôaƒè sessions podle ƒçasu (nejnovƒõj≈°√≠ prvn√≠)
                filteredData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Vytvo≈ô modal
                showStoreModal(storeName, filteredData);
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ detail≈Ø prodejny:', error);
                alert('Chyba p≈ôi naƒç√≠t√°n√≠ detail≈Ø prodejny!');
            }
        }

        // Modal s detaily prodejny
        function showStoreModal(storeName, sessions) {
            // Statistiky
            const soldSessions = sessions.filter(s => s.result === 'sold');
            const notSoldSessions = sessions.filter(s => s.result !== 'sold');
            const successRate = sessions.length > 0 ? ((soldSessions.length / sessions.length) * 100).toFixed(1) : 0;
            
            // Statistiky podle prodejc≈Ø
            const sellerStats = {};
            sessions.forEach(session => {
                const seller = session.seller || session.sellerId || 'Unknown';
                if (!sellerStats[seller]) {
                    sellerStats[seller] = { total: 0, sold: 0, notSold: 0 };
                }
                sellerStats[seller].total++;
                if (session.result === 'sold') {
                    sellerStats[seller].sold++;
                } else {
                    sellerStats[seller].notSold++;
                }
            });
            
            // Statistiky podle sc√©n√°≈ô≈Ø
            const scenarioStats = {};
            sessions.forEach(session => {
                const scenario = session.scenario || 'unknown';
                if (!scenarioStats[scenario]) {
                    scenarioStats[scenario] = { total: 0, sold: 0, notSold: 0 };
                }
                scenarioStats[scenario].total++;
                if (session.result === 'sold') {
                    scenarioStats[scenario].sold++;
                } else {
                    scenarioStats[scenario].notSold++;
                }
            });
            
            // Pr≈Ømƒõrn√Ω ƒças session
            const sessionsWithTime = sessions.filter(s => s.sessionDurationMinutes && s.sessionDurationMinutes > 0);
            const avgTime = sessionsWithTime.length > 0 
                ? (sessionsWithTime.reduce((sum, s) => sum + s.sessionDurationMinutes, 0) / sessionsWithTime.length).toFixed(1)
                : 0;
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.85); z-index: 10000; display: flex; 
                align-items: flex-start; justify-content: center; padding: 2rem 1rem; 
                overflow-y: auto; padding-top: 2rem;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #ffffff); border-radius: 15px; padding: 2rem; 
                    max-width: 1200px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 20px 60px rgba(0,0,0,0.7); max-height: 90vh; overflow-y: auto;
                    position: relative;
                ">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                        <h2 style="color: var(--text-primary, #333); margin: 0; font-size: 1.8rem;">
                            üè™ ${storeName} - Detailn√≠ p≈ôehled
                        </h2>
                        <button onclick="closeStoreModal()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary); 
                            border: 1px solid rgba(255,255,255,0.2); width: 40px; height: 40px;
                            border-radius: 50%; cursor: pointer; font-size: 1.2rem; font-weight: bold;
                            display: flex; align-items: center; justify-content: center;
                        ">‚úï</button>
                    </div>
                    
                    <!-- Rychl√© statistiky -->
                    <div style="
                        display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); 
                        gap: 1rem; margin-bottom: 2rem; padding: 1.5rem; 
                        background: rgba(255,255,255,0.03); border-radius: 12px;
                        border: 1px solid rgba(255,255,255,0.1);
                    ">
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--primary-color, #ff1493);">${sessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Celkem sessions</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #2ed573;">${soldSessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">√öspƒõ≈°n√Ωch</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #ff4757;">${notSoldSessions.length}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">Ne√∫spƒõ≈°n√Ωch</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: var(--text-primary, #333);">${successRate}%</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">√öspƒõ≈°nost</div>
                        </div>
                        <div style="text-align: center;">
                            <div style="font-size: 2rem; font-weight: 700; color: #ff9500;">${avgTime}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">√ò ƒåas (min)</div>
                        </div>
                    </div>
                    
                    <!-- Statistiky podle prodejc≈Ø a sc√©n√°≈ô≈Ø -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                            <h4 style="color: var(--primary-color, #ff1493); margin: 0 0 1rem 0;">üë§ Podle prodejc≈Ø</h4>
                            ${Object.entries(sellerStats).map(([seller, stats]) => {
                                const displayName = getSellerDisplayName(seller);
                                const rate = stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(0) : 0;
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                        <span style="color: var(--text-primary); font-size: 0.9rem;">${displayName}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.8rem;">${stats.sold}/${stats.total} (${rate}%)</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.03); border-radius: 12px; padding: 1.5rem; border: 1px solid rgba(255,255,255,0.1);">
                            <h4 style="color: var(--primary-color, #ff1493); margin: 0 0 1rem 0;">üì± Podle sc√©n√°≈ô≈Ø</h4>
                            ${Object.entries(scenarioStats).map(([scenario, stats]) => {
                                const scenarioNames = {
                                    'zasilkovna': 'üì¶ Z√°silkovna',
                                    'prislusenstvi': 'üîå P≈ô√≠slu≈°enstv√≠',
                                    'novy-telefon': 'üì± Nov√Ω telefon',
                                    'vykup': 'üí∞ V√Ωkup',
                                    'jen-se-kouka': 'üëÄ Jen se kouk√°',
                                    'konzultace': 'üí¨ Konzultace',
                                    'servis': 'üîß Servis'
                                };
                                const displayName = scenarioNames[scenario] || scenario;
                                const rate = stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(0) : 0;
                                return `
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(255,255,255,0.05); border-radius: 6px;">
                                        <span style="color: var(--text-primary); font-size: 0.9rem;">${displayName}</span>
                                        <span style="color: var(--text-secondary); font-size: 0.8rem;">${stats.sold}/${stats.total} (${rate}%)</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Filtry pro zobrazen√≠ -->
                    <div style="margin-bottom: 2rem; text-align: center;">
                        <div style="display: inline-flex; gap: 0.5rem; background: rgba(255,255,255,0.05); 
                                    border-radius: 25px; padding: 0.3rem; border: 1px solid rgba(255,255,255,0.1);">
                            <button id="show-all-store-sessions" onclick="filterStoreSessionView('all')" style="
                                background: linear-gradient(135deg, #2ed573 0%, #20bf6b 100%); color: white; 
                                border: none; padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">üìã V≈°echny (${sessions.length})</button>
                            <button id="show-sold-store-sessions" onclick="filterStoreSessionView('sold')" style="
                                background: transparent; color: var(--text-primary); border: none; 
                                padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">‚úÖ √öspƒõ≈°n√© (${soldSessions.length})</button>
                            <button id="show-failed-store-sessions" onclick="filterStoreSessionView('failed')" style="
                                background: transparent; color: var(--text-primary); border: none; 
                                padding: 0.5rem 1rem; border-radius: 20px; cursor: pointer; 
                                font-size: 0.85rem; font-weight: 500; transition: all 0.3s ease;
                            ">‚ùå Ne√∫spƒõ≈°n√© (${notSoldSessions.length})</button>
                        </div>
                    </div>
                    
                    <!-- Sessions seznam -->
                    <div id="store-sessions-container">
                        ${renderSessionsList(sessions, 'all')}
                    </div>
                </div>
            `;
            
            modal.className = 'store-modal';
            modal.id = 'store-detail-modal';
            document.body.appendChild(modal);
            
            // Ulo≈æit sessions data pro filtrov√°n√≠
            window.currentStoreModalSessions = sessions;
            
            // Zav≈ôen√≠ na ESC
            document.addEventListener('keydown', handleModalKeydown);
            
            // Zav≈ôen√≠ na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) closeStoreModal();
            });
        }

        // Filtrov√°n√≠ view v store modalu
        function filterStoreSessionView(filter) {
            const container = document.getElementById('store-sessions-container');
            const sessions = window.currentStoreModalSessions;
            
            if (container && sessions) {
                container.innerHTML = renderSessionsList(sessions, filter);
                
                // Aktualizuj aktivn√≠ tlaƒç√≠tko
                document.querySelectorAll('#store-detail-modal button[onclick^="filterStoreSessionView"]').forEach(btn => {
                    btn.style.background = 'transparent';
                    btn.style.color = 'var(--text-primary)';
                });
                
                const activeButton = document.getElementById(
                    filter === 'all' ? 'show-all-store-sessions' : 
                    filter === 'sold' ? 'show-sold-store-sessions' : 'show-failed-store-sessions'
                );
                
                if (activeButton) {
                    activeButton.style.background = 'linear-gradient(135deg, #2ed573 0%, #20bf6b 100%)';
                    activeButton.style.color = 'white';
                }
            }
        }

        // Zav≈ôen√≠ modal s detaily prodejny
        function closeStoreModal() {
            const modal = document.getElementById('store-detail-modal');
            if (modal) {
                modal.remove();
                delete window.currentStoreModalSessions;
                document.removeEventListener('keydown', handleModalKeydown);
            }
        }

        // Inicializace p≈ôi naƒçten√≠ str√°nky
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Analytika se inicializuje...');
            
            // P≈ôidej status section p≈ôed analytiky
            const analyticsContainer = document.querySelector('.analytics-container');
            const filterSection = document.querySelector('.filter-section');
            
            if (analyticsContainer && filterSection) {
                const statusSection = document.createElement('div');
                statusSection.innerHTML = `
                    <div style="
                        background: rgba(255,255,255,0.05); border-radius: 10px; padding: 1rem; 
                        margin-bottom: 2rem; border-left: 4px solid var(--primary-color);
                    ">
                        <h4 style="color: var(--primary-color); margin: 0 0 0.5rem 0; font-size: 0.9rem;">
                            üìä Status ukl√°d√°n√≠ dat
                        </h4>
                        <div id="storage-info" style="color: var(--text-secondary); font-size: 0.85rem;">
                            <div>üîç Kontroluji stav √∫lo≈æi≈°tƒõ...</div>
                        </div>
                    </div>
                `;
                
                analyticsContainer.insertBefore(statusSection, filterSection.nextSibling);
                
                // Zobraz status dat
                setTimeout(showDataStatus, 200);
            }
            
            // Debug info p≈ôi startu
            const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
            console.log('üöÄ Inicializace analytiky:');
            console.log('üì± localStorage sessions:', localData.length);
            console.log('üåê Naƒç√≠t√°m ze serveru...');
            
            // Zkontroluj duplicity
            setTimeout(checkForDuplicates, 300);
            
            // Naƒçti dostupn√© prodejny
            setTimeout(loadAvailableStores, 150);
            
            // Aktualizuj status
            setTimeout(showDataStatus, 100);
            
            // Mal√© zpo≈ædƒõn√≠ aby se v≈°echno naƒçetlo
            setTimeout(() => {
                loadAnalytics();
            }, 500);
        });
    </script>
</body>
</html> 