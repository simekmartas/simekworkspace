<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prodejn√≠ analytika - Mobil Maj√°k</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="progressive-enhancement.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#ff1493">
    <meta name="description" content="Prodejn√≠ analytika - Mobil Maj√°k">
    
    <style>
        .analytics-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            margin-top: 100px;
        }
        
        .analytics-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .analytics-header h1 {
            color: var(--text-primary);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .analytics-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff1493, #2196F3);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 20, 147, 0.15);
        }
        
        .stat-emoji {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .section-title {
            color: var(--text-primary);
            font-size: 1.8rem;
            font-weight: 600;
            margin: 3rem 0 1.5rem 0;
            text-align: center;
        }
        
        .chart-container {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .seller-table, .scenario-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .seller-table th, .seller-table td,
        .scenario-table th, .scenario-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .seller-table th, .scenario-table th {
            color: var(--primary-color);
            font-weight: 600;
            background: rgba(255, 20, 147, 0.05);
        }
        
        .seller-table td, .scenario-table td {
            color: var(--text-primary);
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ed573, #20bf6b);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .filter-section {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 3rem;
        }
        
        .filter-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #ff1493, #e91e63);
            color: white;
            border-color: var(--primary-color);
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .no-data-emoji {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        @media (max-width: 768px) {
            .analytics-container {
                padding: 1rem;
                margin-top: 80px;
            }
            
            .analytics-header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1.5rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .filter-controls {
                flex-direction: column;
            }
            
            .filter-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">Mobil Maj√°k</a>
                    <nav>
            <ul>
                <!-- Statick√Ω fallback menu - zobraz√≠ se i bez JS -->
                <li><a href="index.html">üè† Dom≈Ø</a></li>
                <li><a href="sales-analytics.html">üìä Prodeje</a></li>
                <li><a href="celkem.html">üìà Celkem</a></li>
                <li><a href="servis.html">üîß Servis</a></li>
                <li><a href="bazar.html">üõí Bazar</a></li>
                <li><a href="leaderboards.html">üèÜ ≈Ωeb≈ô√≠ƒçky</a></li>
                <li id="static-plus-button">
                    <a href="#" onclick="if(typeof openSalesAssistant==='function'){openSalesAssistant(event)}else{alert('Obnovte str√°nku (F5)')}" 
                       style="background: linear-gradient(135deg, #ff6b6b, #ee5a24) !important; 
                              color: white !important; 
                              padding: 0.5rem 1rem !important; 
                              border-radius: 20px !important; 
                              text-decoration: none !important; 
                              font-weight: bold !important; 
                              box-shadow: 0 2px 10px rgba(255, 107, 107, 0.3) !important; 
                              transition: all 0.3s ease !important;" 
                       title="Prodejn√≠ asistent">
                        ‚ûï Nov√Ω prodej
                    </a>
                </li>
                <li><span style="color: #666; font-size: 0.9em;">üë§ Prodejce</span></li>
                <li><a href="login.html" style="color: #ff6b6b;">üö™ Odhl√°sit</a></li>
            </ul>
        </nav>
        </div>
    </header>

    <main>
        <div class="analytics-container">
            <div class="analytics-header">
                <h1>üìä Prodejn√≠ analytika</h1>
                <p>Komplexn√≠ p≈ôehled v√Ωkonnosti prodejn√≠ch t√Ωm≈Ø</p>
            </div>

            <div class="filter-section">
                <div class="filter-controls">
                    <button class="filter-btn active" onclick="loadAnalytics('all')">V≈°echna data</button>
                    <button class="filter-btn" onclick="loadAnalytics('today')">Dnes</button>
                    <button class="filter-btn" onclick="loadAnalytics('week')">Tento t√Ωden</button>
                    <button class="filter-btn" onclick="loadAnalytics('month')">Tento mƒõs√≠c</button>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                        <button class="filter-btn" onclick="debugLoadData()" style="background: #2196F3; border-color: #2196F3;">üîÑ Obnovit data</button>
                        <button class="filter-btn" onclick="testServerConnection()" style="background: #2ed573; border-color: #2ed573;">üåê Test serveru</button>
                        <button class="filter-btn" onclick="syncWithServer()" style="background: #ff9500; border-color: #ff9500;">üîÑ Sync se serverem</button>
                        <button class="filter-btn" onclick="showDeleteDataModal()" style="background: #ff4757; border-color: #ff4757;">üóëÔ∏è Smazat data</button>
                    </div>
                </div>
            </div>

            <div id="analyticsContent">
                <div class="loading">
                    <div class="loading-spinner">‚è≥</div>
                    <p>Naƒç√≠t√°m analytick√© data...</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Mobil Maj√°k. V≈°echna pr√°va vyhrazena.</p>
        </div>
    </footer>

    <script src="theme-toggle.js"></script>
    <script src="sales-assistant.js"></script>
    <script src="navigation.js"></script>
    <script src="access-control.js"></script>
    
    <script>
        let currentFilter = 'all';
        let analyticsData = null;

        // Kontrola p≈ô√≠stupu - pouze pro administr√°tory
        function checkAdminAccess() {
            const userRole = localStorage.getItem('role');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            
            if (!isLoggedIn || (userRole !== 'Administrator' && userRole !== 'Administr√°tor')) {
                alert('Nem√°te opr√°vnƒõn√≠ k p≈ô√≠stupu k t√©to str√°nce.');
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // Naƒçten√≠ analytick√Ωch dat
        async function loadAnalytics(filter = 'all') {
            if (!checkAdminAccess()) return;
            
            currentFilter = filter;
            
            // Aktualizuj aktivn√≠ tlaƒç√≠tko
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Najdi a aktivuj spr√°vn√© tlaƒç√≠tko
            if (event && event.target) {
                event.target.classList.add('active');
            } else {
                // P≈ôi automatick√©m naƒçten√≠ aktivuj tlaƒç√≠tko podle filtru
                const targetBtn = Array.from(document.querySelectorAll('.filter-btn')).find(btn => 
                    btn.textContent.toLowerCase().includes(filter === 'all' ? 'v≈°echna' : filter)
                );
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
            }
            
            const contentDiv = document.getElementById('analyticsContent');
            contentDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner">‚è≥</div>
                    <p>Naƒç√≠t√°m analytick√© data...</p>
                </div>
            `;
            
            try {
                // Zkus naƒç√≠st ze serveru
                const response = await fetch('/api/sales-data?type=stats');
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        analyticsData = data.stats;
                        renderAnalytics(analyticsData);
                        return;
                    }
                }
                
                // Fallback na localStorage data
                throw new Error('Server nedostupn√Ω');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Server nedostupn√Ω, naƒç√≠t√°m data z localStorage:', error.message);
                
                // Naƒçti data z localStorage
                try {
                    const localSalesData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                    console.log('üìä Naƒç√≠t√°m data z localStorage:', localSalesData.length, 'sessions');
                    console.log('üìä Data detail:', localSalesData);
                    
                    if (localSalesData.length > 0) {
                        const stats = generateLocalStats(localSalesData);
                        console.log('üìä Vygenerovan√© statistiky:', stats);
                        analyticsData = stats;
                        renderAnalytics(analyticsData);
                    } else {
                        console.log('üìä ≈Ω√°dn√° data v localStorage');
                        contentDiv.innerHTML = `
                            <div class="no-data">
                                <span class="no-data-emoji">üìà</span>
                                <h3>Zat√≠m ≈æ√°dn√° data</h3>
                                <p>Jakmile prodejci zaƒçnou pou≈æ√≠vat prodejn√≠ asistent, zde se zobraz√≠ analytick√© √∫daje.</p>
                                <p style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 1rem;">
                                    Debug: localStorage m√° ${localSalesData.length} sessions
                                </p>
                            </div>
                        `;
                    }
                } catch (localError) {
                    console.error('Chyba p≈ôi naƒç√≠t√°n√≠ lok√°ln√≠ch dat:', localError);
                    contentDiv.innerHTML = `
                        <div class="no-data">
                            <span class="no-data-emoji">‚ö†Ô∏è</span>
                            <h3>Chyba p≈ôi naƒç√≠t√°n√≠ dat</h3>
                            <p>Nelze naƒç√≠st ani lok√°ln√≠ data. Zkuste obnovit str√°nku.</p>
                            <button class="filter-btn" onclick="loadAnalytics('${currentFilter}')">Zkusit znovu</button>
                        </div>
                    `;
                }
            }
        }
        
        // Generov√°n√≠ statistik z lok√°ln√≠ch dat
        function generateLocalStats(salesData) {
            const stats = {
                totalSessions: salesData.length,
                successfulSales: 0,
                unsuccessfulSales: 0,
                conversionRate: 0,
                topSellers: {},
                popularItems: {},
                discountUsage: { used: 0, notUsed: 0 },
                scenarioStats: {},
                storeStats: {},
                dailyStats: {},
                totalSessionTime: 0,
                sessionsWithTime: 0,
                averageSessionTime: 0
            };
            
            // Poƒç√≠tej z√°kladn√≠ statistiky
            salesData.forEach(session => {
                // √öspƒõ≈°nost prodeje
                if (session.result === 'sold') {
                    stats.successfulSales++;
                    
                    // Popul√°rn√≠ polo≈æky
                    if (session.soldItems) {
                        session.soldItems.forEach(item => {
                            stats.popularItems[item] = (stats.popularItems[item] || 0) + 1;
                        });
                    }
                    
                    // Pou≈æ√≠v√°n√≠ slevy
                    if (session.discountUsed === true) {
                        stats.discountUsage.used++;
                    } else if (session.discountUsed === false) {
                        stats.discountUsage.notUsed++;
                    }
                } else {
                    stats.unsuccessfulSales++;
                }
                
                // ƒåasov√© statistiky
                if (session.sessionDurationMinutes && session.sessionDurationMinutes > 0) {
                    stats.totalSessionTime += session.sessionDurationMinutes;
                    stats.sessionsWithTime++;
                }
                
                // Top prodejci
                const seller = session.seller || session.sellerId || 'Unknown';
                if (!stats.topSellers[seller]) {
                    stats.topSellers[seller] = { total: 0, sold: 0, notSold: 0, totalTime: 0, avgTime: 0 };
                }
                stats.topSellers[seller].total++;
                if (session.result === 'sold') {
                    stats.topSellers[seller].sold++;
                } else {
                    stats.topSellers[seller].notSold++;
                }
                
                // ƒåas pro prodejce
                if (session.sessionDurationMinutes && session.sessionDurationMinutes > 0) {
                    stats.topSellers[seller].totalTime += session.sessionDurationMinutes;
                }
                
                // Statistiky sc√©n√°≈ô≈Ø
                const scenario = session.scenario || 'unknown';
                if (!stats.scenarioStats[scenario]) {
                    stats.scenarioStats[scenario] = { total: 0, sold: 0, notSold: 0 };
                }
                stats.scenarioStats[scenario].total++;
                if (session.result === 'sold') {
                    stats.scenarioStats[scenario].sold++;
                } else {
                    stats.scenarioStats[scenario].notSold++;
                }
                
                // Statistiky prodejen
                const store = session.store || 'Unknown';
                if (!stats.storeStats[store]) {
                    stats.storeStats[store] = { total: 0, sold: 0, notSold: 0 };
                }
                stats.storeStats[store].total++;
                if (session.result === 'sold') {
                    stats.storeStats[store].sold++;
                } else {
                    stats.storeStats[store].notSold++;
                }
            });
            
            // Spoƒç√≠tej conversion rate
            if (stats.totalSessions > 0) {
                stats.conversionRate = ((stats.successfulSales / stats.totalSessions) * 100).toFixed(1);
            }
            
            // Spoƒç√≠tej pr≈Ømƒõrn√Ω ƒças session
            if (stats.sessionsWithTime > 0) {
                stats.averageSessionTime = (stats.totalSessionTime / stats.sessionsWithTime).toFixed(1);
            }
            
            // Spoƒç√≠tej pr≈Ømƒõrn√Ω ƒças pro ka≈æd√©ho prodejce
            Object.keys(stats.topSellers).forEach(seller => {
                if (stats.topSellers[seller].total > 0) {
                    stats.topSellers[seller].avgTime = (stats.topSellers[seller].totalTime / stats.topSellers[seller].total).toFixed(1);
                }
            });
            
            return stats;
        }

        // Renderov√°n√≠ analytiky
        function renderAnalytics(stats) {
            const contentDiv = document.getElementById('analyticsContent');
            
            if (stats.totalSessions === 0) {
                contentDiv.innerHTML = `
                    <div class="no-data">
                        <span class="no-data-emoji">üìà</span>
                        <h3>Zat√≠m ≈æ√°dn√° data</h3>
                        <p>Jakmile prodejci zaƒçnou pou≈æ√≠vat prodejn√≠ asistent, zde se zobraz√≠ analytick√© √∫daje.</p>
                    </div>
                `;
                return;
            }
            
            contentDiv.innerHTML = `
                <!-- Z√°kladn√≠ statistiky -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-emoji">üìã</span>
                        <div class="stat-value">${stats.totalSessions}</div>
                        <div class="stat-label">Celkem rozhovor≈Ø</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">‚úÖ</span>
                        <div class="stat-value">${stats.successfulSales}</div>
                        <div class="stat-label">√öspƒõ≈°n√Ωch prodej≈Ø</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">‚ùå</span>
                        <div class="stat-value">${stats.unsuccessfulSales}</div>
                        <div class="stat-label">Ne√∫spƒõ≈°n√Ωch pokus≈Ø</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">üìä</span>
                        <div class="stat-value">${stats.conversionRate}%</div>
                        <div class="stat-label">√öspƒõ≈°nost prodeje</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">‚è±Ô∏è</span>
                        <div class="stat-value">${stats.averageSessionTime || '0'} min</div>
                        <div class="stat-label">Pr≈Ømƒõrn√Ω ƒças session</div>
                    </div>
                </div>

                <!-- Top prodejci -->
                <h2 class="section-title">üèÜ V√Ωkonnost prodejc≈Ø</h2>
                <div class="chart-container">
                    ${renderSellersTable(stats.topSellers)}
                </div>

                <!-- Statistiky sc√©n√°≈ô≈Ø -->
                <h2 class="section-title">üì± Statistiky sc√©n√°≈ô≈Ø</h2>
                <div class="chart-container">
                    ${renderScenariosTable(stats.scenarioStats)}
                </div>

                <!-- Popul√°rn√≠ polo≈æky -->
                ${stats.popularItems && Object.keys(stats.popularItems).length > 0 ? `
                <h2 class="section-title">üõçÔ∏è Nejprod√°vanƒõj≈°√≠ polo≈æky</h2>
                <div class="chart-container">
                    ${renderPopularItems(stats.popularItems)}
                </div>
                ` : ''}

                <!-- Pou≈æ√≠v√°n√≠ slevy -->
                ${stats.discountUsage.used > 0 || stats.discountUsage.notUsed > 0 ? `
                <h2 class="section-title">üí∞ Pou≈æ√≠v√°n√≠ slev</h2>
                <div class="chart-container">
                    ${renderDiscountUsage(stats.discountUsage)}
                </div>
                ` : ''}
            `;
        }

        // Tabulka prodejc≈Ø
        function renderSellersTable(topSellers) {
            if (!topSellers || Object.keys(topSellers).length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">≈Ω√°dn√≠ prodejci zat√≠m nezaznamenali data.</p>';
            }
            
            const sellers = Object.entries(topSellers)
                .map(([name, stats]) => ({
                    name,
                    ...stats,
                    successRate: stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.sold - a.sold);
            
            return `
                <table class="seller-table">
                    <thead>
                        <tr>
                            <th>Prodejce</th>
                            <th>Celkem</th>
                            <th>Prod√°no</th>
                            <th>Neprod√°no</th>
                            <th>√öspƒõ≈°nost</th>
                            <th>√ò ƒåas</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sellers.map(seller => `
                            <tr>
                                <td><strong>${seller.name}</strong></td>
                                <td>${seller.total}</td>
                                <td style="color: #2ed573;">${seller.sold}</td>
                                <td style="color: #ff4757;">${seller.notSold}</td>
                                <td>
                                    ${seller.successRate}%
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${seller.successRate}%"></div>
                                    </div>
                                </td>
                                <td style="color: var(--text-secondary);">${seller.avgTime || '0'} min</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Tabulka sc√©n√°≈ô≈Ø
        function renderScenariosTable(scenarioStats) {
            if (!scenarioStats || Object.keys(scenarioStats).length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">≈Ω√°dn√© sc√©n√°≈ôe zat√≠m nebyly pou≈æity.</p>';
            }
            
            const scenarios = Object.entries(scenarioStats)
                .map(([name, stats]) => ({
                    name,
                    ...stats,
                    successRate: stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.total - a.total);
            
            const scenarioNames = {
                'zasilkovna': 'üì¶ Z√°silkovna',
                'prislusenstvi': 'üîå P≈ô√≠slu≈°enstv√≠',
                'novy-telefon': 'üì± Nov√Ω telefon',
                'vykup': 'üí∞ V√Ωkup',
                'jen-se-kouka': 'üëÄ Jen se kouk√°',
                'konzultace': 'üí¨ Konzultace',
                'servis': 'üîß Servis'
            };
            
            return `
                <table class="scenario-table">
                    <thead>
                        <tr>
                            <th>Sc√©n√°≈ô</th>
                            <th>Celkem</th>
                            <th>Prod√°no</th>
                            <th>Neprod√°no</th>
                            <th>√öspƒõ≈°nost</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scenarios.map(scenario => `
                            <tr>
                                <td><strong>${scenarioNames[scenario.name] || scenario.name}</strong></td>
                                <td>${scenario.total}</td>
                                <td style="color: #2ed573;">${scenario.sold}</td>
                                <td style="color: #ff4757;">${scenario.notSold}</td>
                                <td>
                                    ${scenario.successRate}%
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${scenario.successRate}%"></div>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Popul√°rn√≠ polo≈æky
        function renderPopularItems(popularItems) {
            const items = Object.entries(popularItems)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            const total = Object.values(popularItems).reduce((sum, count) => sum + count, 0);
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    ${items.map(([item, count]) => {
                        const percentage = ((count / total) * 100).toFixed(1);
                        return `
                            <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 10px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary-color);">${count}</div>
                                <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 0.5rem;">${item}</div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">${percentage}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Pou≈æ√≠v√°n√≠ slev
        function renderDiscountUsage(discountUsage) {
            const total = discountUsage.used + discountUsage.notUsed;
            const usedPercentage = total > 0 ? ((discountUsage.used / total) * 100).toFixed(1) : 0;
            const notUsedPercentage = total > 0 ? ((discountUsage.notUsed / total) * 100).toFixed(1) : 0;
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                    <div style="text-align: center; padding: 2rem; background: rgba(46, 213, 115, 0.1); border-radius: 15px;">
                        <div style="font-size: 3rem; color: #2ed573; margin-bottom: 1rem;">${discountUsage.used}</div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Sleva pou≈æita</div>
                        <div style="color: var(--text-secondary);">${usedPercentage}% p≈ô√≠pad≈Ø</div>
                    </div>
                    
                    <div style="text-align: center; padding: 2rem; background: rgba(255, 71, 87, 0.1); border-radius: 15px;">
                        <div style="font-size: 3rem; color: #ff4757; margin-bottom: 1rem;">${discountUsage.notUsed}</div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Sleva nepou≈æita</div>
                        <div style="color: var(--text-secondary);">${notUsedPercentage}% p≈ô√≠pad≈Ø</div>
                    </div>
                </div>
            `;
        }

        // Debug funkce
        function debugLoadData() {
            console.log('üîç DEBUG: Kontroluji localStorage...');
            const localData = localStorage.getItem('sales_sessions');
            console.log('üîç Raw localStorage data:', localData);
            
            try {
                const parsed = JSON.parse(localData || '[]');
                console.log('üîç Parsed data:', parsed);
                console.log('üîç Poƒçet sessions:', parsed.length);
                
                if (parsed.length > 0) {
                    console.log('üîç Prvn√≠ session:', parsed[0]);
                    console.log('üîç Posledn√≠ session:', parsed[parsed.length - 1]);
                }
            } catch (e) {
                console.error('üîç Chyba p≈ôi parsov√°n√≠:', e);
            }
            
            // Vynut√≠ naƒçten√≠
            loadAnalytics('all');
        }

        // Test serveru
        async function testServerConnection() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Testuji...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/sales-data?type=stats');
                
                if (response.ok) {
                    btn.textContent = '‚úÖ Server OK';
                    btn.style.background = '#2ed573';
                    console.log('‚úÖ Server je dostupn√Ω');
                    
                    const data = await response.json();
                    console.log('üìä Server data:', data);
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
            } catch (error) {
                btn.textContent = '‚ùå Server nedostupn√Ω';
                btn.style.background = '#ff4757';
                console.error('‚ùå Server test failed:', error);
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '#2ed573';
            }, 3000);
        }

        // Synchronizace se serverem
        async function syncWithServer() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Synchronizuji...';
            btn.disabled = true;
            
            try {
                // Naƒçti data ze serveru
                const response = await fetch('/api/sales-data');
                
                if (response.ok) {
                    const serverData = await response.json();
                    
                    if (serverData.success && serverData.salesData) {
                        // Ulo≈æ server data do localStorage
                        localStorage.setItem('sales_sessions', JSON.stringify(serverData.salesData));
                        console.log('‚úÖ Data synchronizov√°na ze serveru:', serverData.salesData.length, 'sessions');
                        
                        btn.textContent = '‚úÖ Synchronizov√°no';
                        btn.style.background = '#2ed573';
                        
                        // Refresh analytiky
                        loadAnalytics('all');
                    } else {
                        throw new Error('Server nevr√°til validn√≠ data');
                    }
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
                
                // Zkus poslat lok√°ln√≠ data na server
                try {
                    const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                    if (localData.length > 0) {
                        console.log('üì§ Pos√≠l√°m lok√°ln√≠ data na server...');
                        
                        for (const session of localData) {
                            await fetch('/api/sales-data', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(session)
                            });
                        }
                        
                        btn.textContent = '‚úÖ Lok√°ln√≠ ‚Üí Server';
                        btn.style.background = '#2ed573';
                    } else {
                        throw error;
                    }
                } catch (uploadError) {
                    btn.textContent = '‚ùå Sync selhal';
                    btn.style.background = '#ff4757';
                }
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '#ff9500';
            }, 3000);
        }

        // Modal pro smaz√°n√≠ dat
        function showDeleteDataModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 1rem;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary); border-radius: 15px; padding: 2rem; 
                    max-width: 500px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                ">
                    <h3 style="color: var(--text-primary); margin: 0 0 1.5rem 0; text-align: center;">
                        üóëÔ∏è Smazat prodejn√≠ data
                    </h3>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-color); margin-bottom: 1rem;">Vyberte obdob√≠:</h4>
                        
                        <div style="display: grid; gap: 0.75rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <input type="radio" name="deleteOption" value="today" style="accent-color: var(--primary-color);">
                                <span style="color: var(--text-primary);">Pouze dne≈°n√≠ data</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <input type="radio" name="deleteOption" value="week" style="accent-color: var(--primary-color);">
                                <span style="color: var(--text-primary);">Tento t√Ωden</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                <input type="radio" name="deleteOption" value="month" style="accent-color: var(--primary-color);">
                                <span style="color: var(--text-primary);">Tento mƒõs√≠c</span>
                            </label>
                            
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: rgba(255,71,87,0.1); border-radius: 8px; border: 1px solid rgba(255,71,87,0.3);">
                                <input type="radio" name="deleteOption" value="all" style="accent-color: #ff4757;">
                                <span style="color: #ff4757; font-weight: 600;">‚ö†Ô∏è V≈°echna data (POZOR!)</span>
                            </label>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="this.closest('.modal').remove()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary); 
                            border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; 
                            border-radius: 8px; cursor: pointer;
                        ">Zru≈°it</button>
                        
                        <button onclick="confirmDeleteData(this)" style="
                            background: #ff4757; color: white; border: none; 
                            padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;
                        ">üóëÔ∏è Smazat</button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            document.body.appendChild(modal);
            
            // Zav≈ôen√≠ na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Potvrzen√≠ smaz√°n√≠ dat
        async function confirmDeleteData(btn) {
            const selectedOption = document.querySelector('input[name="deleteOption"]:checked');
            
            if (!selectedOption) {
                alert('Pros√≠m vyberte obdob√≠ pro smaz√°n√≠.');
                return;
            }
            
            const period = selectedOption.value;
            const periodNames = {
                today: 'dne≈°n√≠ data',
                week: 'data z tohoto t√Ωdne',
                month: 'data z tohoto mƒõs√≠ce',
                all: 'V≈†ECHNA DATA'
            };
            
            if (!confirm(`Opravdu chcete smazat ${periodNames[period]}?\n\nTato akce je nevratn√°!`)) {
                return;
            }
            
            btn.textContent = '‚è≥ Maz√°n√≠...';
            btn.disabled = true;
            
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                let filteredData = [...localData];
                const now = new Date();
                
                // Filtruj podle obdob√≠
                if (period !== 'all') {
                    filteredData = localData.filter(session => {
                        const sessionDate = new Date(session.timestamp);
                        
                        switch(period) {
                            case 'today':
                                return sessionDate.toDateString() !== now.toDateString();
                            case 'week':
                                const weekAgo = new Date(now);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                return sessionDate < weekAgo;
                            case 'month':
                                const monthAgo = new Date(now);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                return sessionDate < monthAgo;
                            default:
                                return true;
                        }
                    });
                } else {
                    filteredData = [];
                }
                
                // Ulo≈æ filtrovan√° data
                localStorage.setItem('sales_sessions', JSON.stringify(filteredData));
                
                console.log(`üóëÔ∏è Smaz√°no: ${localData.length - filteredData.length} sessions`);
                console.log(`üìä Z≈Øst√°v√°: ${filteredData.length} sessions`);
                
                // Refresh analytiky
                loadAnalytics('all');
                
                // Zav≈ôi modal
                document.querySelector('.modal').remove();
                
                alert(`‚úÖ √öspƒõ≈°nƒõ smaz√°no ${localData.length - filteredData.length} z√°znam≈Ø!`);
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi maz√°n√≠:', error);
                alert('‚ùå Chyba p≈ôi maz√°n√≠ dat!');
            }
        }

        // Zobrazen√≠ statusu ukl√°d√°n√≠ dat
        function showDataStatus() {
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                const statusDiv = document.getElementById('storage-info');
                
                if (statusDiv) {
                    const statusHTML = `
                        <div style="display: grid; gap: 0.5rem;">
                            <div>üíæ <strong>Lok√°ln√≠ √∫lo≈æi≈°tƒõ:</strong> ${localData.length} sessions ulo≈æeno</div>
                            <div>üåê <strong>Server:</strong> <span id="server-status">Testuji...</span></div>
                            <div>üîÑ <strong>Synchronizace:</strong> <span id="sync-status">Automatick√° p≈ôi ulo≈æen√≠</span></div>
                            <div style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--text-secondary);">
                                ‚úÖ Data jsou ukl√°d√°na lok√°lnƒõ i na server pro dlouhodob√© uchov√°v√°n√≠
                            </div>
                        </div>
                    `;
                    statusDiv.innerHTML = statusHTML;
                    
                    // Test server status
                    testServerStatusQuiet();
                }
            } catch (error) {
                console.error('Chyba p≈ôi zobrazov√°n√≠ statusu dat:', error);
            }
        }

        // Tich√Ω test serveru pro status
        async function testServerStatusQuiet() {
            const statusElement = document.getElementById('server-status');
            if (!statusElement) return;
            
            try {
                // Chrome kompatibiln√≠ timeout implementace
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch('/api/sales-data?type=stats', { 
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    statusElement.innerHTML = '<span style="color: #2ed573;">‚úÖ P≈ôipojen a funkƒçn√≠</span>';
                } else {
                    throw new Error('Server nedostupn√Ω');
                }
            } catch (error) {
                statusElement.innerHTML = '<span style="color: #ff9500;">‚ö†Ô∏è Offline (data v localStorage)</span>';
            }
        }

        // Inicializace p≈ôi naƒçten√≠ str√°nky
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Analytika se inicializuje...');
            
            // P≈ôidej status section p≈ôed analytiky
            const analyticsContainer = document.querySelector('.analytics-container');
            const filterSection = document.querySelector('.filter-section');
            
            if (analyticsContainer && filterSection) {
                const statusSection = document.createElement('div');
                statusSection.innerHTML = `
                    <div style="
                        background: rgba(255,255,255,0.05); border-radius: 10px; padding: 1rem; 
                        margin-bottom: 2rem; border-left: 4px solid var(--primary-color);
                    ">
                        <h4 style="color: var(--primary-color); margin: 0 0 0.5rem 0; font-size: 0.9rem;">
                            üìä Status ukl√°d√°n√≠ dat
                        </h4>
                        <div id="storage-info" style="color: var(--text-secondary); font-size: 0.85rem;">
                            <div>üîç Kontroluji stav √∫lo≈æi≈°tƒõ...</div>
                        </div>
                    </div>
                `;
                
                analyticsContainer.insertBefore(statusSection, filterSection.nextSibling);
                
                // Zobraz status dat
                setTimeout(showDataStatus, 200);
            }
            
            // Mal√© zpo≈ædƒõn√≠ aby se v≈°echno naƒçetlo
            setTimeout(() => {
                loadAnalytics('all');
            }, 100);
        });
    </script>
</body>
</html> 