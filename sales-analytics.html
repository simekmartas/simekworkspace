<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Prodejn√≠ analytika - Mobil Maj√°k</title>
    <!-- Legacy Browser Support First -->
    <script src="legacy-browser-support.js"></script>
    <link rel="stylesheet" href="legacy-browser-styles.css">
    <link rel="stylesheet" href="css-compatibility-patches.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="progressive-enhancement.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#ff1493">
    <meta name="description" content="Prodejn√≠ analytika - Mobil Maj√°k">
    
    <style>
        .analytics-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            margin-top: 100px;
        }
        
        .analytics-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .analytics-header h1 {
            color: var(--text-primary);
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }
        
        .analytics-header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }
        
        .stat-card {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: linear-gradient(90deg, #ff1493, #2196F3);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(255, 20, 147, 0.15);
        }
        
        .stat-emoji {
            font-size: 3rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .section-title {
            color: var(--text-primary);
            font-size: 1.8rem;
            font-weight: 600;
            margin: 3rem 0 1.5rem 0;
            text-align: center;
        }
        
        .chart-container {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 2rem;
        }
        
        .seller-table, .scenario-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        .seller-table th, .seller-table td,
        .scenario-table th, .scenario-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .seller-table th, .scenario-table th {
            color: var(--primary-color);
            font-weight: 600;
            background: rgba(255, 20, 147, 0.05);
        }
        
        .seller-table td, .scenario-table td {
            color: var(--text-primary);
        }
        
        .progress-bar {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            height: 8px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #2ed573, #20bf6b);
            border-radius: 10px;
            transition: width 0.3s ease;
        }
        
        .filter-section {
            background: var(--bg-primary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 2rem;
            margin-bottom: 3rem;
        }
        
        .filter-controls {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            padding: 0.75rem 1.5rem;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .filter-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }
        
        .filter-btn.active {
            background: linear-gradient(135deg, #ff1493, #e91e63);
            color: white;
            border-color: var(--primary-color);
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            font-size: 2rem;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .no-data {
            text-align: center;
            padding: 3rem;
            color: var(--text-secondary);
        }
        
        .no-data-emoji {
            font-size: 4rem;
            margin-bottom: 1rem;
            display: block;
        }
        
        @media (max-width: 768px) {
            .analytics-container {
                padding: 1rem;
                margin-top: 80px;
            }
            
            .analytics-header h1 {
                font-size: 2rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 1rem;
            }
            
            .stat-card {
                padding: 1.5rem;
            }
            
            .stat-value {
                font-size: 2rem;
            }
            
            .filter-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .filter-btn {
                width: 100%;
                min-width: auto;
                font-size: 0.85rem;
            }
            
            /* Zmen≈°i text v tlaƒç√≠tk√°ch prodejen na mobilu */
            .store-filter {
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 100%;
            }
            
            /* Na mobilech zobraz m√©nƒõ tlaƒç√≠tek v ≈ô√°dku pro prodejny */
            #store-filters {
                display: grid;
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            #store-filters .filter-btn {
                text-align: center;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <a href="index.html" class="logo">Mobil Maj√°k</a>
            <nav>
                <ul>
                    <!-- Navigace bude dynamicky naƒçtena pomoc√≠ JavaScriptu -->
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <div class="analytics-container">
            <div class="analytics-header">
                <h1>üìä Prodejn√≠ analytika</h1>
                <p>Komplexn√≠ p≈ôehled v√Ωkonnosti prodejn√≠ch t√Ωm≈Ø</p>
            </div>

            <div class="filter-section">
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--primary-color, #ff1493); margin-bottom: 1rem; text-align: center; font-size: 1rem;">üìÖ ƒåasov√© obdob√≠</h4>
                    <div class="filter-controls">
                        <button class="filter-btn time-filter active" onclick="setTimeFilter('all')">V≈°echna data</button>
                        <button class="filter-btn time-filter" onclick="setTimeFilter('today')">Dnes</button>
                        <button class="filter-btn time-filter" onclick="setTimeFilter('week')">Tento t√Ωden</button>
                        <button class="filter-btn time-filter" onclick="setTimeFilter('month')">Tento mƒõs√≠c</button>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <h4 style="color: var(--primary-color, #ff1493); margin-bottom: 1rem; text-align: center; font-size: 1rem;">üè™ Prodejna</h4>
                    <div class="filter-controls" id="store-filters">
                        <button class="filter-btn store-filter active" onclick="setStoreFilter('all')">V≈°echny prodejny</button>
                        <!-- Dynamicky naƒçten√© prodejny -->
                    </div>
                </div>
                
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1);">
                    <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                        <button class="filter-btn" onclick="debugLoadData()" style="background: #2196F3; border-color: #2196F3;">üîÑ Obnovit data</button>
                        <button class="filter-btn" onclick="testServerConnection()" style="background: #2ed573; border-color: #2ed573;">üåê Test serveru</button>
                        <button class="filter-btn" onclick="syncWithServer()" style="background: #ff9500; border-color: #ff9500;">üîÑ Sync se serverem</button>
                        <button class="filter-btn" onclick="resetServerData()" style="background: #e74c3c; border-color: #e74c3c;">üåê Reset serveru</button>
                        <button class="filter-btn" onclick="cleanDuplicateSellerData()" style="background: #8e44ad; border-color: #8e44ad;">üîß Opravit duplicity</button>
                        <button class="filter-btn" onclick="showSellerNameManager()" style="background: #6c5ce7; border-color: #6c5ce7;">üë§ Spr√°va jmen</button>
                        <button class="filter-btn" onclick="resetAllFilters()" style="background: #ff9500; border-color: #ff9500;">üîÑ Reset filtr≈Ø</button>
                        <button class="filter-btn" onclick="showDeleteDataModal()" style="background: #ff4757; border-color: #ff4757;">üóëÔ∏è Smazat data</button>
                    </div>
                </div>
            </div>

            <div id="analyticsContent">
                <div class="loading">
                    <div class="loading-spinner">‚è≥</div>
                    <p>Naƒç√≠t√°m analytick√© data...</p>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2025 Mobil Maj√°k. V≈°echna pr√°va vyhrazena.</p>
        </div>
    </footer>

    <script src="theme-toggle.js"></script>
    <script src="sales-assistant.js"></script>
    <script src="navigation.js"></script>
    <script src="access-control.js"></script>
    
    <script>
        let currentTimeFilter = 'all';
        let currentStoreFilter = 'all';
        let analyticsData = null;
        let availableStores = [];

        // Kontrola p≈ô√≠stupu - pouze pro administr√°tory
        function checkAdminAccess() {
            const userRole = localStorage.getItem('role');
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            
            if (!isLoggedIn || (userRole !== 'Administrator' && userRole !== 'Administr√°tor')) {
                alert('Nem√°te opr√°vnƒõn√≠ k p≈ô√≠stupu k t√©to str√°nce.');
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // Naƒçten√≠ dostupn√Ωch prodejen z dat
        function loadAvailableStores() {
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                console.log('üè™ Naƒç√≠t√°m prodejny ze', localData.length, 'sessions');
                
                const stores = new Set();
                const storeDebug = {};
                
                localData.forEach((session, index) => {
                    const store = session.store || session.prodejna || 'Nezn√°m√° prodejna';
                    if (store && store !== 'undefined' && store !== '') {
                        stores.add(store);
                        storeDebug[store] = (storeDebug[store] || 0) + 1;
                    }
                    
                    // Debug prvn√≠ 3 sessions
                    if (index < 3) {
                        console.log(`üè™ Session ${index}:`, {
                            store: session.store,
                            prodejna: session.prodejna,
                            keys: Object.keys(session)
                        });
                    }
                });
                
                availableStores = Array.from(stores).sort();
                console.log('üè™ Dostupn√© prodejny:', availableStores);
                console.log('üè™ Poƒçty podle prodejen:', storeDebug);
                
                // Aktualizuj UI filtr≈Ø prodejen
                updateStoreFilters();
                
            } catch (error) {
                console.error('Chyba p≈ôi naƒç√≠t√°n√≠ prodejen:', error);
            }
        }

        // Aktualizace UI filtr≈Ø prodejen
        function updateStoreFilters() {
            const storeFiltersContainer = document.getElementById('store-filters');
            if (!storeFiltersContainer) return;
            
            // Zachovej tlaƒç√≠tko "V≈°echny prodejny"
            const allButton = storeFiltersContainer.querySelector('.store-filter[onclick*="all"]');
            storeFiltersContainer.innerHTML = '';
            if (allButton) {
                storeFiltersContainer.appendChild(allButton);
            } else {
                storeFiltersContainer.innerHTML = '<button class="filter-btn store-filter active" onclick="setStoreFilter(\'all\')">V≈°echny prodejny</button>';
            }
            
            // P≈ôidej tlaƒç√≠tka pro jednotliv√© prodejny
            availableStores.forEach(store => {
                const button = document.createElement('button');
                button.className = 'filter-btn store-filter';
                button.textContent = `üè™ ${store}`;
                button.onclick = () => setStoreFilter(store);
                storeFiltersContainer.appendChild(button);
            });
        }

        // Nastaven√≠ ƒçasov√©ho filtru
        function setTimeFilter(filter) {
            currentTimeFilter = filter;
            
            // Aktualizuj aktivn√≠ tlaƒç√≠tko
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Najdi a aktivuj spr√°vn√© tlaƒç√≠tko
            const targetBtn = Array.from(document.querySelectorAll('.time-filter')).find(btn => 
                btn.onclick.toString().includes(filter)
            );
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            console.log('üìÖ Nastaven ƒçasov√Ω filtr:', filter);
            loadAnalytics();
        }

        // Nastaven√≠ filtru prodejny
        function setStoreFilter(store) {
            currentStoreFilter = store;
            
            // Aktualizuj aktivn√≠ tlaƒç√≠tko
            document.querySelectorAll('.store-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Najdi a aktivuj spr√°vn√© tlaƒç√≠tko
            if (store === 'all') {
                const allBtn = document.querySelector('.store-filter[onclick*="all"]');
                if (allBtn) allBtn.classList.add('active');
            } else {
                const targetBtn = Array.from(document.querySelectorAll('.store-filter')).find(btn => 
                    btn.textContent.includes(store)
                );
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
            }
            
            console.log('üè™ Nastaven filtr prodejny:', store);
            loadAnalytics();
        }

        // Naƒçten√≠ analytick√Ωch dat
        async function loadAnalytics() {
            if (!checkAdminAccess()) return;
            
            const contentDiv = document.getElementById('analyticsContent');
            contentDiv.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner">‚è≥</div>
                    <p>Naƒç√≠t√°m analytick√© data...</p>
                </div>
            `;
            
            console.log(`üìä Naƒç√≠t√°m data s filtry: ƒças="${currentTimeFilter}", prodejna="${currentStoreFilter}"`);
            
            try {
                // Zkus naƒç√≠st ze serveru - PRIM√ÅRN√ç zdroj dat
                console.log('üåê Naƒç√≠t√°m data ze serveru...');
                const response = await fetch('/api/sales-data');
                
                if (response.ok) {
                    const serverData = await response.json();
                    console.log('üåê Server response:', serverData);
                    
                    if (serverData.success && serverData.salesData && Array.isArray(serverData.salesData)) {
                        console.log(`üåê Server vr√°til ${serverData.salesData.length} sessions`);
                        console.log('üåê Sample server data:', serverData.salesData.slice(0, 2));
                        
                        // Synchronizuj server data do localStorage pro konzistenci
                        localStorage.setItem('sales_sessions', JSON.stringify(serverData.salesData));
                        
                        // Filtruj server data podle filtr≈Ø
                        const filteredData = filterSalesData(serverData.salesData);
                        console.log(`üåê Po filtrov√°n√≠: ${filteredData.length} sessions`);
                        
                        if (filteredData.length === 0) {
                            console.warn('‚ö†Ô∏è Server data po filtrov√°n√≠ pr√°zdn√°');
                            // Zkus bez filtr≈Ø
                            const unfilteredStats = generateLocalStats(serverData.salesData);
                            if (unfilteredStats) {
                                // Reset filtr≈Ø a zobraz warning
                                currentTimeFilter = 'all';
                                currentStoreFilter = 'all';
                                updateFilterButtons();
                                
                                contentDiv.innerHTML = `
                                    <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid #ff9800; border-radius: 10px; padding: 1rem; margin-bottom: 2rem;">
                                        <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">‚ö†Ô∏è Filtry resetov√°ny</h4>
                                        <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">
                                            Aktivn√≠ filtry nevr√°tily ≈æ√°dn√° data ze serveru. Zobrazuji v≈°echna data.
                                        </p>
                                    </div>
                                `;
                                
                                renderAnalytics(unfilteredStats);
                                return;
                            }
                        }
                        
                        const stats = generateLocalStats(filteredData);
                        if (stats) {
                            analyticsData = stats;
                            renderAnalytics(analyticsData);
                            
                            // Aktualizuj info o filtrov√°n√≠
                            updateFilterInfo(serverData.salesData.length, filteredData.length);
                            return;
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Server nevr√°til validn√≠ data:', serverData);
                    }
                } else {
                    console.warn('‚ö†Ô∏è Server error:', response.status, response.statusText);
                }
                
                // Fallback na localStorage data
                console.log('üì± Fallback na localStorage...');
                throw new Error('Server nedostupn√Ω');
                
            } catch (error) {
                console.warn('‚ö†Ô∏è Server nedostupn√Ω, naƒç√≠t√°m data z localStorage:', error.message);
                
                // Naƒçti data z localStorage jako fallback
                try {
                    const localSalesData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                    console.log('üì± localStorage fallback:', localSalesData.length, 'sessions');
                    
                    if (localSalesData.length === 0) {
                        contentDiv.innerHTML = `
                            <div class="no-data">
                                <span class="no-data-emoji">üìà</span>
                                <h3>Zat√≠m ≈æ√°dn√° data</h3>
                                <p>Server nen√≠ dostupn√Ω a v localStorage nejsou ≈æ√°dn√° data.</p>
                                <p>Jakmile prodejci zaƒçnou pou≈æ√≠vat prodejn√≠ asistent, zde se zobraz√≠ analytick√© √∫daje.</p>
                                <div style="margin-top: 1rem;">
                                    <button class="filter-btn" onclick="loadAnalytics()">üîÑ Zkusit znovu</button>
                                    <button class="filter-btn" onclick="syncWithServer()">üåê Sync se serverem</button>
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    // Zpracuj localStorage data stejnƒõ jako server data
                    const filteredData = filterSalesData(localSalesData);
                    console.log(`üì± Po filtrov√°n√≠ localStorage: ${filteredData.length} sessions`);
                    
                    if (filteredData.length === 0) {
                        console.warn('‚ö†Ô∏è localStorage data po filtrov√°n√≠ pr√°zdn√°');
                        // Zobraz v≈°echna data bez filtr≈Ø
                        const unfilteredStats = generateLocalStats(localSalesData);
                        if (unfilteredStats) {
                            // Reset filtr≈Ø
                            currentTimeFilter = 'all';
                            currentStoreFilter = 'all';
                            updateFilterButtons();
                            
                            contentDiv.innerHTML = `
                                <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid #ff9800; border-radius: 10px; padding: 1rem; margin-bottom: 2rem;">
                                    <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">‚ö†Ô∏è Filtry resetov√°ny (Offline)</h4>
                                    <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">
                                        Server nen√≠ dostupn√Ω. Zobrazuji v≈°echna localStorage data bez filtr≈Ø.
                                    </p>
                                </div>
                            `;
                            
                            renderAnalytics(unfilteredStats);
                            return;
                        }
                    }
                    
                    const stats = generateLocalStats(filteredData);
                    if (stats) {
                        analyticsData = stats;
                        
                        // P≈ôidej info o offline re≈æimu
                        contentDiv.innerHTML = `
                            <div style="background: rgba(255, 152, 0, 0.1); border: 1px solid #ff9800; border-radius: 10px; padding: 1rem; margin-bottom: 2rem;">
                                <h4 style="color: #ff9800; margin: 0 0 0.5rem 0;">üì± Offline re≈æim</h4>
                                <p style="margin: 0; color: var(--text-primary); font-size: 0.9rem;">
                                    Server nen√≠ dostupn√Ω. Zobrazuji data z localStorage.
                                </p>
                            </div>
                        `;
                        
                        renderAnalytics(analyticsData);
                        updateFilterInfo(localSalesData.length, filteredData.length);
                    } else {
                        contentDiv.innerHTML = `
                            <div class="no-data">
                                <span class="no-data-emoji">‚ö†Ô∏è</span>
                                <h3>Chyba p≈ôi zpracov√°n√≠ dat</h3>
                                <p>Data jsou dostupn√° (${localSalesData.length} sessions), ale nelze je zpracovat.</p>
                                <div style="margin-top: 1rem;">
                                    <button class="filter-btn" onclick="debugLoadData()">üîç Debug info</button>
                                    <button class="filter-btn" onclick="resetAllFilters()">üîÑ Reset filtr≈Ø</button>
                                </div>
                            </div>
                        `;
                    }
                    
                } catch (localError) {
                    console.error('‚ùå Chyba p≈ôi naƒç√≠t√°n√≠ localStorage:', localError);
                    contentDiv.innerHTML = `
                        <div class="no-data">
                            <span class="no-data-emoji">üí•</span>
                            <h3>Kritick√° chyba</h3>
                            <p>Server nen√≠ dostupn√Ω a nelze naƒç√≠st ani localStorage data.</p>
                            <button class="filter-btn" onclick="location.reload()">üîÑ Obnovit str√°nku</button>
                        </div>
                    `;
                }
            }
        }

        // Filtrov√°n√≠ dat podle ƒçasu a prodejny
        function filterSalesData(salesData) {
            console.log('üîç Filtrov√°n√≠ dat:', {
                inputData: salesData.length,
                timeFilter: currentTimeFilter,
                storeFilter: currentStoreFilter
            });
            
            const filtered = salesData.filter(session => {
                // Debug pro prvn√≠ session
                if (salesData.indexOf(session) === 0) {
                    console.log('üîç Sample session struktura:', {
                        timestamp: session.timestamp,
                        store: session.store,
                        prodejna: session.prodejna,
                        seller: session.seller,
                        keys: Object.keys(session)
                    });
                }
                
                // ƒåasov√Ω filtr
                if (currentTimeFilter !== 'all') {
                    const sessionDate = new Date(session.timestamp);
                    const now = new Date();
                    
                    if (!session.timestamp) {
                        console.warn('‚ö†Ô∏è Session bez timestamp:', session);
                        return false;
                    }
                    
                    switch(currentTimeFilter) {
                        case 'today':
                            if (sessionDate.toDateString() !== now.toDateString()) {
                                return false;
                            }
                            break;
                        case 'week':
                            const weekAgo = new Date(now);
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            if (sessionDate < weekAgo) {
                                return false;
                            }
                            break;
                        case 'month':
                            const monthAgo = new Date(now);
                            monthAgo.setMonth(monthAgo.getMonth() - 1);
                            if (sessionDate < monthAgo) {
                                return false;
                            }
                            break;
                    }
                }
                
                // Filtr prodejny
                if (currentStoreFilter !== 'all') {
                    const sessionStore = session.store || session.prodejna || 'Nezn√°m√° prodejna';
                    if (sessionStore !== currentStoreFilter) {
                        return false;
                    }
                }
                
                return true;
            });
            
            console.log(`üîç V√Ωsledek filtrov√°n√≠: ${filtered.length} z ${salesData.length} sessions`);
            return filtered;
        }

        // Aktualizace informac√≠ o filtrov√°n√≠
        function updateFilterInfo(totalSessions, filteredSessions) {
            const filterInfo = document.getElementById('filter-info');
            if (filterInfo) {
                filterInfo.remove();
            }
            
            // Pouze pokud jsou nƒõjak√© filtry aktivn√≠
            if (currentTimeFilter !== 'all' || currentStoreFilter !== 'all') {
                const analyticsContainer = document.querySelector('.analytics-container');
                const contentDiv = document.getElementById('analyticsContent');
                
                if (analyticsContainer && contentDiv) {
                    const infoDiv = document.createElement('div');
                    infoDiv.id = 'filter-info';
                    infoDiv.innerHTML = `
                        <div style="
                            background: rgba(33, 150, 243, 0.1); border: 1px solid #2196F3; 
                            border-radius: 10px; padding: 1rem; margin-bottom: 2rem; 
                            border-left: 4px solid #2196F3; text-align: center;
                        ">
                            <div style="color: #2196F3; font-weight: 600; margin-bottom: 0.5rem;">
                                üìä Aktivn√≠ filtry
                            </div>
                            <div style="color: var(--text-primary, #333); font-size: 0.9rem;">
                                üìÖ <strong>Obdob√≠:</strong> ${getTimeFilterName()} | 
                                üè™ <strong>Prodejna:</strong> ${currentStoreFilter === 'all' ? 'V≈°echny' : currentStoreFilter}
                            </div>
                            <div style="color: var(--text-secondary, #666); font-size: 0.8rem; margin-top: 0.5rem;">
                                Zobrazuji ${filteredSessions} z ${totalSessions} celkov√Ωch sessions
                            </div>
                        </div>
                    `;
                    
                    analyticsContainer.insertBefore(infoDiv, contentDiv);
                }
            }
        }

        // N√°zev ƒçasov√©ho filtru pro zobrazen√≠
        function getTimeFilterName() {
            switch(currentTimeFilter) {
                case 'all': return 'V≈°echna data';
                case 'today': return 'Dnes';
                case 'week': return 'Tento t√Ωden';
                case 'month': return 'Tento mƒõs√≠c';
                default: return currentTimeFilter;
            }
        }

        // Aktualizace stavu tlaƒç√≠tek filtr≈Ø
        function updateFilterButtons() {
            // Aktualizuj ƒçasov√© filtry
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.store-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Aktivuj spr√°vn√° tlaƒç√≠tka
            const allTimeBtn = Array.from(document.querySelectorAll('.time-filter')).find(btn => 
                btn.textContent.includes('V≈°echna data')
            );
            if (allTimeBtn) allTimeBtn.classList.add('active');
            
            const allStoreBtn = Array.from(document.querySelectorAll('.store-filter')).find(btn => 
                btn.textContent.includes('V≈°echny prodejny')
            );
            if (allStoreBtn) allStoreBtn.classList.add('active');
        }
        
        // Generov√°n√≠ statistik z lok√°ln√≠ch dat
        function generateLocalStats(salesData) {
            console.log('üè≠ Generuji statistiky z dat:', {
                inputLength: salesData.length,
                sampleData: salesData.slice(0, 2)
            });
            
            if (!salesData || salesData.length === 0) {
                console.warn('‚ö†Ô∏è ≈Ω√°dn√° data pro generov√°n√≠ statistik!');
                return null;
            }
            
            const stats = {
                totalSessions: salesData.length,
                successfulSales: 0,
                unsuccessfulSales: 0,
                conversionRate: 0,
                topSellers: {},
                popularItems: {},
                discountUsage: { used: 0, notUsed: 0 },
                scenarioStats: {},
                storeStats: {},
                dailyStats: {},
                totalSessionTime: 0,
                sessionsWithTime: 0,
                averageSessionTime: 0
            };
            
            // Poƒç√≠tej z√°kladn√≠ statistiky
            salesData.forEach(session => {
                // √öspƒõ≈°nost prodeje
                if (session.result === 'sold') {
                    stats.successfulSales++;
                    
                    // Popul√°rn√≠ polo≈æky
                    if (session.soldItems) {
                        session.soldItems.forEach(item => {
                            stats.popularItems[item] = (stats.popularItems[item] || 0) + 1;
                        });
                    }
                    
                    // Pou≈æ√≠v√°n√≠ slevy
                    if (session.discountUsed === true) {
                        stats.discountUsage.used++;
                    } else if (session.discountUsed === false) {
                        stats.discountUsage.notUsed++;
                    }
                } else {
                    stats.unsuccessfulSales++;
                }
                
                // ƒåasov√© statistiky
                if (session.sessionDurationMinutes && session.sessionDurationMinutes > 0) {
                    stats.totalSessionTime += session.sessionDurationMinutes;
                    stats.sessionsWithTime++;
                }
                
                // Top prodejci - normalizace jm√©na
                let seller = session.seller || session.sellerId || 'Unknown';
                
                // Normalizace jmen - mapov√°n√≠ cel√Ωch jmen na usernames
                const nameMapping = {
                    'Tom√°≈° Valenta': 'tvalenta',
                    'Admin Administr√°tor': 'admin',
                    '≈†imon Gabriel': 'sgabriel',
                    // P≈ôidej dal≈°√≠ mapov√°n√≠ podle pot≈ôeby
                };
                
                // Pokud je seller cel√© jm√©no, p≈ôeveƒè na username
                if (nameMapping[seller]) {
                    seller = nameMapping[seller];
                }
                
                // Naƒçti custom jm√©na z localStorage
                const customDisplayNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
                
                // V√Ωchoz√≠ zobrazovac√≠ jm√©na (fallback)
                const defaultDisplayNames = {
                    'tvalenta': 'Tom√°≈° Valenta',
                    'admin': 'Admin Administr√°tor', 
                    'sgabriel': '≈†imon Gabriel',
                    'malek': 'Pavel Malek',  // P≈ôedpokl√°dan√° hodnota - zmƒõnit p≈ôes "üë§ Spr√°va jmen"
                };
                
                if (!stats.topSellers[seller]) {
                    // Vytvo≈ô lep≈°√≠ zobrazovac√≠ jm√©no
                    let displayName = customDisplayNames[seller] || defaultDisplayNames[seller];
                    
                    if (!displayName) {
                        // Automatick√© generov√°n√≠ lep≈°√≠ho zobrazen√≠ pro nezn√°m√© usernames
                        if (seller.length > 1) {
                            // Kapitalizuj prvn√≠ p√≠smeno
                            displayName = seller.charAt(0).toUpperCase() + seller.slice(1);
                        } else {
                            displayName = seller;
                        }
                    }
                    
                    stats.topSellers[seller] = { 
                        total: 0, 
                        sold: 0, 
                        notSold: 0, 
                        totalTime: 0, 
                        avgTime: 0,
                        displayName: displayName,
                        username: seller  // Ulo≈æ i p≈Øvodn√≠ username
                    };
                }
                stats.topSellers[seller].total++;
                if (session.result === 'sold') {
                    stats.topSellers[seller].sold++;
                } else {
                    stats.topSellers[seller].notSold++;
                }
                
                // ƒåas pro prodejce
                if (session.sessionDurationMinutes && session.sessionDurationMinutes > 0) {
                    stats.topSellers[seller].totalTime += session.sessionDurationMinutes;
                }
                
                // Statistiky sc√©n√°≈ô≈Ø
                const scenario = session.scenario || 'unknown';
                if (!stats.scenarioStats[scenario]) {
                    stats.scenarioStats[scenario] = { total: 0, sold: 0, notSold: 0 };
                }
                stats.scenarioStats[scenario].total++;
                if (session.result === 'sold') {
                    stats.scenarioStats[scenario].sold++;
                } else {
                    stats.scenarioStats[scenario].notSold++;
                }
                
                // Statistiky prodejen
                const store = session.store || 'Unknown';
                if (!stats.storeStats[store]) {
                    stats.storeStats[store] = { total: 0, sold: 0, notSold: 0 };
                }
                stats.storeStats[store].total++;
                if (session.result === 'sold') {
                    stats.storeStats[store].sold++;
                } else {
                    stats.storeStats[store].notSold++;
                }
            });
            
            // Spoƒç√≠tej conversion rate
            if (stats.totalSessions > 0) {
                stats.conversionRate = ((stats.successfulSales / stats.totalSessions) * 100).toFixed(1);
            }
            
            // Spoƒç√≠tej pr≈Ømƒõrn√Ω ƒças session
            if (stats.sessionsWithTime > 0) {
                stats.averageSessionTime = (stats.totalSessionTime / stats.sessionsWithTime).toFixed(1);
            }
            
            // Spoƒç√≠tej pr≈Ømƒõrn√Ω ƒças pro ka≈æd√©ho prodejce
            Object.keys(stats.topSellers).forEach(seller => {
                if (stats.topSellers[seller].total > 0) {
                    stats.topSellers[seller].avgTime = (stats.topSellers[seller].totalTime / stats.topSellers[seller].total).toFixed(1);
                }
            });
            
            console.log('üè≠ Statistiky vygenerov√°ny:', {
                totalSessions: stats.totalSessions,
                successfulSales: stats.successfulSales,
                unsuccessfulSales: stats.unsuccessfulSales,
                conversionRate: stats.conversionRate,
                sellersCount: Object.keys(stats.topSellers).length,
                scenariosCount: Object.keys(stats.scenarioStats).length,
                storesCount: Object.keys(stats.storeStats).length,
                stats: stats
            });
            
            return stats;
        }

        // Renderov√°n√≠ analytiky
        function renderAnalytics(stats) {
            console.log('üé® Renderuji analytiku s daty:', stats);
            
            const contentDiv = document.getElementById('analyticsContent');
            if (!contentDiv) {
                console.error('‚ùå Element analyticsContent nenalezen!');
                return;
            }
            
            if (!stats) {
                console.error('‚ùå ≈Ω√°dn√° data pro renderov√°n√≠!');
                contentDiv.innerHTML = `
                    <div class="no-data">
                        <span class="no-data-emoji">‚ö†Ô∏è</span>
                        <h3>Chyba p≈ôi renderov√°n√≠</h3>
                        <p>Statistiky nebyly p≈ôed√°ny funkci renderAnalytics.</p>
                    </div>
                `;
                return;
            }
            
            if (stats.totalSessions === 0) {
                contentDiv.innerHTML = `
                    <div class="no-data">
                        <span class="no-data-emoji">üìà</span>
                        <h3>Zat√≠m ≈æ√°dn√° data</h3>
                        <p>Jakmile prodejci zaƒçnou pou≈æ√≠vat prodejn√≠ asistent, zde se zobraz√≠ analytick√© √∫daje.</p>
                    </div>
                `;
                return;
            }
            
            contentDiv.innerHTML = `
                <!-- Z√°kladn√≠ statistiky -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-emoji">üìã</span>
                        <div class="stat-value">${stats.totalSessions}</div>
                        <div class="stat-label">Celkem rozhovor≈Ø</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">‚úÖ</span>
                        <div class="stat-value">${stats.successfulSales}</div>
                        <div class="stat-label">√öspƒõ≈°n√Ωch prodej≈Ø</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">‚ùå</span>
                        <div class="stat-value">${stats.unsuccessfulSales}</div>
                        <div class="stat-label">Ne√∫spƒõ≈°n√Ωch pokus≈Ø</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">üìä</span>
                        <div class="stat-value">${stats.conversionRate}%</div>
                        <div class="stat-label">√öspƒõ≈°nost prodeje</div>
                    </div>
                    
                    <div class="stat-card">
                        <span class="stat-emoji">‚è±Ô∏è</span>
                        <div class="stat-value">${stats.averageSessionTime || '0'} min</div>
                        <div class="stat-label">Pr≈Ømƒõrn√Ω ƒças session</div>
                    </div>
                </div>

                <!-- Top prodejci -->
                <h2 class="section-title">üèÜ V√Ωkonnost prodejc≈Ø</h2>
                <div class="chart-container">
                    ${renderSellersTable(stats.topSellers)}
                </div>

                <!-- Statistiky sc√©n√°≈ô≈Ø -->
                <h2 class="section-title">üì± Statistiky sc√©n√°≈ô≈Ø</h2>
                <div class="chart-container">
                    ${renderScenariosTable(stats.scenarioStats)}
                </div>

                <!-- Popul√°rn√≠ polo≈æky -->
                ${stats.popularItems && Object.keys(stats.popularItems).length > 0 ? `
                <h2 class="section-title">üõçÔ∏è Nejprod√°vanƒõj≈°√≠ polo≈æky</h2>
                <div class="chart-container">
                    ${renderPopularItems(stats.popularItems)}
                </div>
                ` : ''}

                <!-- Pou≈æ√≠v√°n√≠ slevy -->
                ${stats.discountUsage.used > 0 || stats.discountUsage.notUsed > 0 ? `
                <h2 class="section-title">üí∞ Pou≈æ√≠v√°n√≠ slev</h2>
                <div class="chart-container">
                    ${renderDiscountUsage(stats.discountUsage)}
                </div>
                ` : ''}
            `;
            
            console.log('üé® Renderov√°n√≠ analytiky dokonƒçeno √∫spƒõ≈°nƒõ');
        }

        // Tabulka prodejc≈Ø
        function renderSellersTable(topSellers) {
            if (!topSellers || Object.keys(topSellers).length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">≈Ω√°dn√≠ prodejci zat√≠m nezaznamenali data.</p>';
            }
            
            const sellers = Object.entries(topSellers)
                .map(([username, stats]) => ({
                    username,
                    displayName: stats.displayName || username,
                    ...stats,
                    successRate: stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.sold - a.sold);
            
            return `
                <table class="seller-table">
                    <thead>
                        <tr>
                            <th>Prodejce</th>
                            <th>Celkem</th>
                            <th>Prod√°no</th>
                            <th>Neprod√°no</th>
                            <th>√öspƒõ≈°nost</th>
                            <th>√ò ƒåas</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${sellers.map(seller => `
                            <tr>
                                <td><strong>${seller.displayName}</strong></td>
                                <td>${seller.total}</td>
                                <td style="color: #2ed573;">${seller.sold}</td>
                                <td style="color: #ff4757;">${seller.notSold}</td>
                                <td>
                                    ${seller.successRate}%
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${seller.successRate}%"></div>
                                    </div>
                                </td>
                                <td style="color: var(--text-secondary);">${seller.avgTime || '0'} min</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Tabulka sc√©n√°≈ô≈Ø
        function renderScenariosTable(scenarioStats) {
            if (!scenarioStats || Object.keys(scenarioStats).length === 0) {
                return '<p style="text-align: center; color: var(--text-secondary);">≈Ω√°dn√© sc√©n√°≈ôe zat√≠m nebyly pou≈æity.</p>';
            }
            
            const scenarios = Object.entries(scenarioStats)
                .map(([name, stats]) => ({
                    name,
                    ...stats,
                    successRate: stats.total > 0 ? ((stats.sold / stats.total) * 100).toFixed(1) : 0
                }))
                .sort((a, b) => b.total - a.total);
            
            const scenarioNames = {
                'zasilkovna': 'üì¶ Z√°silkovna',
                'prislusenstvi': 'üîå P≈ô√≠slu≈°enstv√≠',
                'novy-telefon': 'üì± Nov√Ω telefon',
                'vykup': 'üí∞ V√Ωkup',
                'jen-se-kouka': 'üëÄ Jen se kouk√°',
                'konzultace': 'üí¨ Konzultace',
                'servis': 'üîß Servis'
            };
            
            return `
                <table class="scenario-table">
                    <thead>
                        <tr>
                            <th>Sc√©n√°≈ô</th>
                            <th>Celkem</th>
                            <th>Prod√°no</th>
                            <th>Neprod√°no</th>
                            <th>√öspƒõ≈°nost</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${scenarios.map(scenario => `
                            <tr>
                                <td><strong>${scenarioNames[scenario.name] || scenario.name}</strong></td>
                                <td>${scenario.total}</td>
                                <td style="color: #2ed573;">${scenario.sold}</td>
                                <td style="color: #ff4757;">${scenario.notSold}</td>
                                <td>
                                    ${scenario.successRate}%
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: ${scenario.successRate}%"></div>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Popul√°rn√≠ polo≈æky
        function renderPopularItems(popularItems) {
            const items = Object.entries(popularItems)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10);
            
            const total = Object.values(popularItems).reduce((sum, count) => sum + count, 0);
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    ${items.map(([item, count]) => {
                        const percentage = ((count / total) * 100).toFixed(1);
                        return `
                            <div style="text-align: center; padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 10px;">
                                <div style="font-size: 2rem; margin-bottom: 0.5rem; color: var(--primary-color);">${count}</div>
                                <div style="color: var(--text-primary); font-weight: 500; margin-bottom: 0.5rem;">${item}</div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem;">${percentage}%</div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Pou≈æ√≠v√°n√≠ slev
        function renderDiscountUsage(discountUsage) {
            const total = discountUsage.used + discountUsage.notUsed;
            const usedPercentage = total > 0 ? ((discountUsage.used / total) * 100).toFixed(1) : 0;
            const notUsedPercentage = total > 0 ? ((discountUsage.notUsed / total) * 100).toFixed(1) : 0;
            
            return `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 2rem;">
                    <div style="text-align: center; padding: 2rem; background: rgba(46, 213, 115, 0.1); border-radius: 15px;">
                        <div style="font-size: 3rem; color: #2ed573; margin-bottom: 1rem;">${discountUsage.used}</div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Sleva pou≈æita</div>
                        <div style="color: var(--text-secondary);">${usedPercentage}% p≈ô√≠pad≈Ø</div>
                    </div>
                    
                    <div style="text-align: center; padding: 2rem; background: rgba(255, 71, 87, 0.1); border-radius: 15px;">
                        <div style="font-size: 3rem; color: #ff4757; margin-bottom: 1rem;">${discountUsage.notUsed}</div>
                        <div style="color: var(--text-primary); font-weight: 600; margin-bottom: 0.5rem;">Sleva nepou≈æita</div>
                        <div style="color: var(--text-secondary);">${notUsedPercentage}% p≈ô√≠pad≈Ø</div>
                    </div>
                </div>
            `;
        }

        // Debug funkce
        function debugLoadData() {
            console.log('üîç DEBUG: Kontroluji localStorage...');
            console.log('üîç Aktu√°ln√≠ filtry:', {
                ƒçasov√Ω: currentTimeFilter,
                prodejna: currentStoreFilter
            });
            
            const localData = localStorage.getItem('sales_sessions');
            console.log('üîç Raw localStorage data:', localData);
            
            try {
                const parsed = JSON.parse(localData || '[]');
                console.log('üîç Parsed data:', parsed);
                console.log('üîç Poƒçet sessions:', parsed.length);
                
                if (parsed.length > 0) {
                    console.log('üîç Prvn√≠ session:', parsed[0]);
                    console.log('üîç Posledn√≠ session:', parsed[parsed.length - 1]);
                    
                    // Anal√Ωza prodejc≈Ø
                    const sellers = new Set();
                    parsed.forEach(session => {
                        const seller = session.seller || session.sellerId || 'Unknown';
                        sellers.add(seller);
                    });
                    console.log('üîç Unik√°tn√≠ prodejci v datech:', Array.from(sellers));
                    
                    // Zkontroluj duplicity
                    const sellerCounts = {};
                    parsed.forEach(session => {
                        const seller = session.seller || session.sellerId || 'Unknown';
                        sellerCounts[seller] = (sellerCounts[seller] || 0) + 1;
                    });
                    console.log('üîç Poƒçty sessions podle prodejc≈Ø:', sellerCounts);
                    
                    // Detekce mo≈æn√Ωch duplicit
                    const possibleDuplicates = [];
                    const checkPairs = [
                        ['Tom√°≈° Valenta', 'tvalenta'],
                        ['Admin Administr√°tor', 'admin'],
                        ['≈†imon Gabriel', 'sgabriel']
                    ];
                    
                    checkPairs.forEach(([fullName, username]) => {
                        if (sellerCounts[fullName] && sellerCounts[username]) {
                            possibleDuplicates.push({
                                fullName,
                                username,
                                fullNameCount: sellerCounts[fullName],
                                usernameCount: sellerCounts[username],
                                total: sellerCounts[fullName] + sellerCounts[username]
                            });
                        }
                    });
                    
                    if (possibleDuplicates.length > 0) {
                        console.warn('‚ö†Ô∏è NALEZENY DUPLICITN√ç PRODEJCI:');
                        possibleDuplicates.forEach(dup => {
                            console.warn(`   üë§ ${dup.fullName} (${dup.fullNameCount}) + ${dup.username} (${dup.usernameCount}) = ${dup.total} sessions`);
                        });
                        console.warn('üí° Pou≈æijte tlaƒç√≠tko "üîß Opravit duplicity" pro slouƒçen√≠');
                    } else {
                        console.log('‚úÖ ≈Ω√°dn√© duplicitn√≠ prodejci nenalezeni');
                    }
                }
            } catch (e) {
                console.error('üîç Chyba p≈ôi parsov√°n√≠:', e);
            }
            
            // Naƒçti prodejny znovu a vynut√≠ naƒçten√≠
            loadAvailableStores();
            loadAnalytics();
        }

        // Spr√°va jmen prodejc≈Ø
        function showSellerNameManager() {
            // Naƒçti aktu√°ln√≠ prodejce z dat
            const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
            const sellers = new Set();
            
            localData.forEach(session => {
                const seller = session.seller || session.sellerId || 'Unknown';
                if (seller && seller !== 'Unknown') {
                    sellers.add(seller);
                }
            });
            
            const sellerList = Array.from(sellers).sort();
            console.log('üë§ Nalezen√≠ prodejci:', sellerList);
            
            // Naƒçti aktu√°ln√≠ mapov√°n√≠ jmen z localStorage
            const customDisplayNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
            
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 1rem; overflow-y: auto;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #ffffff); border-radius: 15px; padding: 2rem; 
                    max-width: 600px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 10px 30px rgba(0,0,0,0.5); max-height: 80vh; overflow-y: auto;
                ">
                    <h3 style="color: var(--text-primary, #333); margin: 0 0 1.5rem 0; text-align: center;">
                        üë§ Spr√°va jmen prodejc≈Ø
                    </h3>
                    
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(108, 92, 231, 0.1); border-radius: 8px; border-left: 4px solid #6c5ce7;">
                        <h4 style="color: #6c5ce7; margin: 0 0 0.5rem 0; font-size: 0.9rem;">‚ÑπÔ∏è Jak to funguje</h4>
                        <p style="margin: 0; color: var(--text-primary); font-size: 0.85rem; line-height: 1.4;">
                            Zde m≈Ø≈æete nastavit zobrazovac√≠ jm√©na pro prodejce. Zmƒõny se projev√≠ okam≈æitƒõ v analytice.
                        </p>
                    </div>
                    
                    <div id="seller-name-list" style="margin-bottom: 2rem;">
                        ${sellerList.map(seller => {
                            const currentDisplayName = customDisplayNames[seller] || getDefaultDisplayName(seller);
                            return `
                                <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem; padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px;">
                                    <div style="flex: 1;">
                                        <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Username:</div>
                                        <div style="color: var(--text-primary); font-weight: 500; font-family: monospace;">${seller}</div>
                                    </div>
                                    <div style="flex: 2;">
                                        <div style="color: var(--text-secondary); font-size: 0.8rem; margin-bottom: 0.25rem;">Zobrazovan√© jm√©no:</div>
                                        <input type="text" 
                                               value="${currentDisplayName}" 
                                               data-seller="${seller}"
                                               style="width: 100%; padding: 0.5rem; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; background: rgba(255,255,255,0.1); color: var(--text-primary);"
                                               placeholder="Zadejte cel√© jm√©no">
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="closeSellerNameManager()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary, #333); 
                            border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; 
                            border-radius: 8px; cursor: pointer; font-weight: 500;
                        ">Zru≈°it</button>
                        
                        <button onclick="saveSellerNames()" style="
                            background: #6c5ce7; color: white; border: none; 
                            padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600;
                        ">üíæ Ulo≈æit zmƒõny</button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            modal.id = 'seller-name-modal';
            document.body.appendChild(modal);
            
            // Zav≈ôen√≠ na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }

        // Z√≠sk√°n√≠ v√Ωchoz√≠ho zobrazovac√≠ho jm√©na
        function getDefaultDisplayName(seller) {
            // Naƒçti custom jm√©na nejd≈ô√≠ve
            const customDisplayNames = JSON.parse(localStorage.getItem('seller_display_names') || '{}');
            if (customDisplayNames[seller]) {
                return customDisplayNames[seller];
            }
            
                         // Fallback na v√Ωchoz√≠ jm√©na
            const defaultDisplayNames = {
                'tvalenta': 'Tom√°≈° Valenta',
                'admin': 'Admin Administr√°tor', 
                'sgabriel': '≈†imon Gabriel',
                'malek': 'Pavel Malek',  // P≈ôedpokl√°dan√° hodnota - zmƒõnit p≈ôes "üë§ Spr√°va jmen"
            };
            
            return defaultDisplayNames[seller] || (seller.charAt(0).toUpperCase() + seller.slice(1));
        }

        // Zav≈ôen√≠ spr√°vce jmen
        function closeSellerNameManager() {
            const modal = document.getElementById('seller-name-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Ulo≈æen√≠ jmen prodejc≈Ø
        function saveSellerNames() {
            const inputs = document.querySelectorAll('#seller-name-list input[data-seller]');
            const customDisplayNames = {};
            
            inputs.forEach(input => {
                const seller = input.dataset.seller;
                const displayName = input.value.trim();
                if (displayName && displayName !== getDefaultDisplayName(seller)) {
                    customDisplayNames[seller] = displayName;
                }
            });
            
            // Ulo≈æ do localStorage
            localStorage.setItem('seller_display_names', JSON.stringify(customDisplayNames));
            
            console.log('üë§ Ulo≈æen√° jm√©na prodejc≈Ø:', customDisplayNames);
            
            // Zav≈ôi modal
            closeSellerNameManager();
            
            // Refresh analytiky
            loadAnalytics();
            
            alert(`‚úÖ Jm√©na prodejc≈Ø byla ulo≈æena!\n\nChanges saved: ${Object.keys(customDisplayNames).length} custom names`);
        }

        // Reset v≈°ech filtr≈Ø
        function resetAllFilters() {
            console.log('üîÑ Resetuji v≈°echny filtry...');
            
            // Reset filtr≈Ø
            currentTimeFilter = 'all';
            currentStoreFilter = 'all';
            
            // Aktivuj spr√°vn√° tlaƒç√≠tka
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelectorAll('.store-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Aktivuj "V≈°echna data"
            const allTimeBtn = Array.from(document.querySelectorAll('.time-filter')).find(btn => 
                btn.textContent.includes('V≈°echna data')
            );
            if (allTimeBtn) allTimeBtn.classList.add('active');
            
            // Aktivuj "V≈°echny prodejny"
            const allStoreBtn = Array.from(document.querySelectorAll('.store-filter')).find(btn => 
                btn.textContent.includes('V≈°echny prodejny')
            );
            if (allStoreBtn) allStoreBtn.classList.add('active');
            
            // Naƒçti data
            loadAnalytics();
        }

        // Nov√° funkce pro normalizaci existuj√≠c√≠ch dat
        function cleanDuplicateSellerData() {
            if (!confirm('Opravdu chcete normalizovat jm√©na prodejc≈Ø v existuj√≠c√≠ch datech?\n\nToto slouƒç√≠ duplicitn√≠ z√°znamy pro stejn√© prodejce.')) {
                return;
            }
            
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                
                // Mapov√°n√≠ pro normalizaci jmen
                const nameMapping = {
                    'Tom√°≈° Valenta': 'tvalenta',
                    'Admin Administr√°tor': 'admin',
                    '≈†imon Gabriel': 'sgabriel',
                };
                
                let changedCount = 0;
                
                // Projdi v≈°echny sessions a normalizuj jm√©na
                localData.forEach(session => {
                    const originalSeller = session.seller || session.sellerId;
                    
                    if (nameMapping[originalSeller]) {
                        // Aktualizuj seller i sellerId
                        session.seller = nameMapping[originalSeller];
                        session.sellerId = nameMapping[originalSeller];
                        changedCount++;
                        console.log(`‚úÖ Normalizov√°no: "${originalSeller}" ‚Üí "${nameMapping[originalSeller]}"`);
                    }
                });
                
                // Ulo≈æ opraven√° data
                localStorage.setItem('sales_sessions', JSON.stringify(localData));
                
                console.log(`üîß Normalizace dokonƒçena! Zmƒõnƒõno ${changedCount} z√°znam≈Ø.`);
                
                if (changedCount > 0) {
                    alert(`‚úÖ Normalizace dokonƒçena!\n\nZmƒõnƒõno ${changedCount} z√°znam≈Ø.\n\nDuplicit√© prodejci (nap≈ô. "Tom√°≈° Valenta" + "tvalenta") jsou nyn√≠ slouƒçeni pod jednotn√Ωm jm√©nem.\n\nAnalytika se automaticky obnov√≠.`);
                } else {
                    alert('‚ÑπÔ∏è ≈Ω√°dn√© duplicity k opravƒõ nebyly nalezeny.\n\nData jsou ji≈æ v po≈ô√°dku.');
                }
                
                // Aktualizuj seznam prodejen a refresh analytiky
                loadAvailableStores();
                loadAnalytics();
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi normalizaci dat:', error);
                alert('‚ùå Chyba p≈ôi normalizaci dat!');
            }
        }

        // Test serveru
        async function testServerConnection() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Testuji...';
            btn.disabled = true;
            
            try {
                const response = await fetch('/api/sales-data?type=stats');
                
                if (response.ok) {
                    btn.textContent = '‚úÖ Server OK';
                    btn.style.background = '#2ed573';
                    console.log('‚úÖ Server je dostupn√Ω');
                    
                    const data = await response.json();
                    console.log('üìä Server data:', data);
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
            } catch (error) {
                btn.textContent = '‚ùå Server nedostupn√Ω';
                btn.style.background = '#ff4757';
                console.error('‚ùå Server test failed:', error);
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '#2ed573';
            }, 3000);
        }

        // Reset server dat
        async function resetServerData() {
            if (!confirm('‚ö†Ô∏è POZOR: Reset serveru\n\nToto KOMPLETNƒö SMA≈ΩE v≈°echna data na serveru!\n\nTato akce je NEVRATN√Å!\n\nOpravdu chcete pokraƒçovat?')) {
                return;
            }
            
            if (!confirm('üî¥ FIN√ÅLN√ç POTVRZEN√ç\n\nPo kliknut√≠ na OK budou V≈†ECHNA DATA NA SERVERU SMAZ√ÅNA!\n\nTuto akci NELZE vz√≠t zpƒõt!\n\nJste si jisti?')) {
                return;
            }
            
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'üî• Ma≈æu server...';
            btn.disabled = true;
            btn.style.background = '#e74c3c';
            
            try {
                console.log('üåê Resetuji server data...');
                
                // Po≈°li po≈æadavek pro smaz√°n√≠ v≈°ech dat na serveru
                const response = await fetch('/api/sales-data/reset', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'delete_all',
                        confirmation: 'yes_delete_everything'
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Server resetov√°n:', result);
                    
                    // Sma≈æ i localStorage pro konzistenci
                    localStorage.setItem('sales_sessions', '[]');
                    console.log('‚úÖ localStorage tak√© vymaz√°n');
                    
                    btn.textContent = '‚úÖ Server resetov√°n';
                    btn.style.background = '#2ed573';
                    
                    // Aktualizuj analytiku
                    loadAvailableStores();
                    loadAnalytics();
                    
                    alert('‚úÖ Server i localStorage byly kompletnƒõ resetov√°ny!\n\nV≈°echna data byla smaz√°na.');
                    
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
                
            } catch (error) {
                console.error('‚ùå Reset server failed:', error);
                btn.textContent = '‚ùå Reset selhal';
                btn.style.background = '#ff4757';
                
                alert('‚ùå Nepoda≈ôilo se resetovat server!\n\nServer m≈Ø≈æe b√Ωt offline nebo nepodporuje reset endpoint.');
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '#e74c3c';
            }, 5000);
        }

        // Synchronizace se serverem
        async function syncWithServer() {
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚è≥ Synchronizuji...';
            btn.disabled = true;
            
            try {
                // Naƒçti data ze serveru
                const response = await fetch('/api/sales-data');
                
                if (response.ok) {
                    const serverData = await response.json();
                    
                    if (serverData.success && serverData.salesData) {
                        // Ulo≈æ server data do localStorage
                        localStorage.setItem('sales_sessions', JSON.stringify(serverData.salesData));
                        console.log('‚úÖ Data synchronizov√°na ze serveru:', serverData.salesData.length, 'sessions');
                        
                        btn.textContent = '‚úÖ Synchronizov√°no';
                        btn.style.background = '#2ed573';
                        
                        // Aktualizuj seznam prodejen a refresh analytiky
                        loadAvailableStores();
                        loadAnalytics();
                    } else {
                        throw new Error('Server nevr√°til validn√≠ data');
                    }
                } else {
                    throw new Error(`Server error: ${response.status}`);
                }
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
                
                // Zkus poslat lok√°ln√≠ data na server
                try {
                    const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                    if (localData.length > 0) {
                        console.log('üì§ Pos√≠l√°m lok√°ln√≠ data na server...');
                        
                        for (const session of localData) {
                            await fetch('/api/sales-data', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(session)
                            });
                        }
                        
                        btn.textContent = '‚úÖ Lok√°ln√≠ ‚Üí Server';
                        btn.style.background = '#2ed573';
                    } else {
                        throw error;
                    }
                } catch (uploadError) {
                    btn.textContent = '‚ùå Sync selhal';
                    btn.style.background = '#ff4757';
                }
            }
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.background = '#ff9500';
            }, 3000);
        }

        // Modal pro smaz√°n√≠ dat
        function showDeleteDataModal() {
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.8); z-index: 10000; display: flex; 
                align-items: center; justify-content: center; padding: 1rem;
            `;
            
            modal.innerHTML = `
                <div style="
                    background: var(--bg-primary, #ffffff); border-radius: 15px; padding: 2rem; 
                    max-width: 500px; width: 100%; border: 1px solid rgba(255,255,255,0.1);
                    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
                ">
                    <h3 style="color: var(--text-primary, #333); margin: 0 0 1.5rem 0; text-align: center;">
                        üóëÔ∏è Smazat prodejn√≠ data
                    </h3>
                    
                    <div style="margin-bottom: 2rem;">
                        <h4 style="color: var(--primary-color, #ff1493); margin-bottom: 1rem;">Vyberte obdob√≠:</h4>
                        
                        <div style="display: block;">
                            <div class="radio-option" data-value="today" style="
                                display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
                                padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; 
                                margin-bottom: 0.75rem; border: 2px solid transparent; transition: all 0.3s ease;
                            ">
                                <div class="radio-circle" style="
                                    width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
                                    position: relative; background: white;
                                ">
                                    <div class="radio-dot" style="
                                        width: 8px; height: 8px; background: #ff1493; border-radius: 50%; 
                                        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                        opacity: 0; transition: opacity 0.3s ease;
                                    "></div>
                                </div>
                                <span style="color: var(--text-primary, #333); font-weight: 500;">Pouze dne≈°n√≠ data</span>
                            </div>
                            
                            <div class="radio-option" data-value="week" style="
                                display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
                                padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; 
                                margin-bottom: 0.75rem; border: 2px solid transparent; transition: all 0.3s ease;
                            ">
                                <div class="radio-circle" style="
                                    width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
                                    position: relative; background: white;
                                ">
                                    <div class="radio-dot" style="
                                        width: 8px; height: 8px; background: #ff1493; border-radius: 50%; 
                                        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                        opacity: 0; transition: opacity 0.3s ease;
                                    "></div>
                                </div>
                                <span style="color: var(--text-primary, #333); font-weight: 500;">Tento t√Ωden</span>
                            </div>
                            
                            <div class="radio-option" data-value="month" style="
                                display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
                                padding: 1rem; background: rgba(255,255,255,0.05); border-radius: 8px; 
                                margin-bottom: 0.75rem; border: 2px solid transparent; transition: all 0.3s ease;
                            ">
                                <div class="radio-circle" style="
                                    width: 18px; height: 18px; border: 2px solid #ccc; border-radius: 50%; 
                                    position: relative; background: white;
                                ">
                                    <div class="radio-dot" style="
                                        width: 8px; height: 8px; background: #ff1493; border-radius: 50%; 
                                        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                        opacity: 0; transition: opacity 0.3s ease;
                                    "></div>
                                </div>
                                <span style="color: var(--text-primary, #333); font-weight: 500;">Tento mƒõs√≠c</span>
                            </div>
                            
                            <div class="radio-option" data-value="all" style="
                                display: flex; align-items: center; gap: 0.75rem; cursor: pointer; 
                                padding: 1rem; background: rgba(255,71,87,0.1); border-radius: 8px; 
                                border: 2px solid rgba(255,71,87,0.3); transition: all 0.3s ease;
                            ">
                                <div class="radio-circle" style="
                                    width: 18px; height: 18px; border: 2px solid #ff4757; border-radius: 50%; 
                                    position: relative; background: white;
                                ">
                                    <div class="radio-dot" style="
                                        width: 8px; height: 8px; background: #ff4757; border-radius: 50%; 
                                        position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
                                        opacity: 0; transition: opacity 0.3s ease;
                                    "></div>
                                </div>
                                <span style="color: #ff4757; font-weight: 600;">‚ö†Ô∏è V≈°echna data (POZOR!)</span>
                            </div>
                        </div>
                        
                        <div id="selected-info" style="
                            margin-top: 1rem; padding: 0.75rem; background: rgba(33, 150, 243, 0.1); 
                            border-radius: 8px; border-left: 4px solid #2196F3; display: none;
                        ">
                            <span style="color: #2196F3; font-weight: 500;">üìã Vybr√°no: </span>
                            <span id="selected-text" style="color: var(--text-primary, #333);"></span>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: center;">
                        <button onclick="closeDeleteModal()" style="
                            background: rgba(255,255,255,0.1); color: var(--text-primary, #333); 
                            border: 1px solid rgba(255,255,255,0.2); padding: 0.75rem 1.5rem; 
                            border-radius: 8px; cursor: pointer; font-weight: 500;
                        ">Zru≈°it</button>
                        
                        <button id="confirm-delete-btn" onclick="confirmDeleteData(this)" style="
                            background: #cccccc; color: #666666; border: none; 
                            padding: 0.75rem 1.5rem; border-radius: 8px; cursor: not-allowed; font-weight: 600;
                        " disabled>üóëÔ∏è Smazat</button>
                    </div>
                </div>
            `;
            
            modal.className = 'modal';
            modal.id = 'delete-modal';
            document.body.appendChild(modal);
            
            // P≈ôidej event listenery pro radio buttony
            const radioOptions = modal.querySelectorAll('.radio-option');
            let selectedValue = null;
            
                         radioOptions.forEach(option => {
                 // Hover efekt
                 option.addEventListener('mouseenter', function() {
                     if (selectedValue !== this.dataset.value) {
                         this.style.background = this.dataset.value === 'all' 
                             ? 'rgba(255,71,87,0.15)' 
                             : 'rgba(255,255,255,0.1)';
                     }
                 });
                 
                 option.addEventListener('mouseleave', function() {
                     if (selectedValue !== this.dataset.value) {
                         this.style.background = this.dataset.value === 'all' 
                             ? 'rgba(255,71,87,0.1)' 
                             : 'rgba(255,255,255,0.05)';
                     }
                 });
                 
                 option.addEventListener('click', function() {
                    // Odznaƒç v≈°echny ostatn√≠
                    radioOptions.forEach(opt => {
                        opt.style.borderColor = 'transparent';
                        opt.style.background = opt.dataset.value === 'all' 
                            ? 'rgba(255,71,87,0.1)' 
                            : 'rgba(255,255,255,0.05)';
                        const dot = opt.querySelector('.radio-dot');
                        if (dot) dot.style.opacity = '0';
                    });
                    
                    // Oznaƒç aktu√°ln√≠
                    this.style.borderColor = this.dataset.value === 'all' ? '#ff4757' : '#2196F3';
                    this.style.background = this.dataset.value === 'all' 
                        ? 'rgba(255,71,87,0.2)' 
                        : 'rgba(33, 150, 243, 0.1)';
                    const dot = this.querySelector('.radio-dot');
                    if (dot) dot.style.opacity = '1';
                    
                    selectedValue = this.dataset.value;
                    
                    // Aktualizuj info a tlaƒç√≠tko
                    const infoDiv = modal.querySelector('#selected-info');
                    const textSpan = modal.querySelector('#selected-text');
                    const deleteBtn = modal.querySelector('#confirm-delete-btn');
                    
                    const optionTexts = {
                        today: 'Pouze dne≈°n√≠ data',
                        week: 'Tento t√Ωden',
                        month: 'Tento mƒõs√≠c',
                        all: 'V≈†ECHNA DATA (POZOR!)'
                    };
                    
                    if (infoDiv && textSpan && deleteBtn) {
                        infoDiv.style.display = 'block';
                        textSpan.textContent = optionTexts[selectedValue];
                        
                        deleteBtn.disabled = false;
                        deleteBtn.style.cursor = 'pointer';
                        deleteBtn.style.background = '#ff4757';
                        deleteBtn.style.color = 'white';
                    }
                    
                    console.log('üéØ Vybr√°no:', selectedValue);
                });
            });
            
            // Zav≈ôen√≠ na klik mimo
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
            
            // Ulo≈æ selected value pro pozdƒõj≈°√≠ pou≈æit√≠
            modal.selectedValue = null;
            modal.getSelectedValue = () => selectedValue;
        }

        // Zav≈ôen√≠ delete modalu
        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            if (modal) {
                modal.remove();
            }
        }

        // Potvrzen√≠ smaz√°n√≠ dat
        async function confirmDeleteData(btn) {
            const modal = document.getElementById('delete-modal');
            const selectedValue = modal ? modal.getSelectedValue() : null;
            
            console.log('üóëÔ∏è Attempting delete with selection:', selectedValue);
            
            if (!selectedValue) {
                alert('Pros√≠m vyberte obdob√≠ pro smaz√°n√≠.');
                return;
            }
            
            const period = selectedValue;
            const periodNames = {
                today: 'dne≈°n√≠ data',
                week: 'data z tohoto t√Ωdne',
                month: 'data z tohoto mƒõs√≠ce',
                all: 'V≈†ECHNA DATA'
            };
            
            if (!confirm(`Opravdu chcete smazat ${periodNames[period]}?\n\nTato akce je nevratn√°!`)) {
                return;
            }
            
            btn.textContent = '‚è≥ Maz√°n√≠...';
            btn.disabled = true;
            
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                let filteredData = [...localData];
                const now = new Date();
                
                // Filtruj podle obdob√≠
                if (period !== 'all') {
                    filteredData = localData.filter(session => {
                        const sessionDate = new Date(session.timestamp);
                        
                        switch(period) {
                            case 'today':
                                return sessionDate.toDateString() !== now.toDateString();
                            case 'week':
                                const weekAgo = new Date(now);
                                weekAgo.setDate(weekAgo.getDate() - 7);
                                return sessionDate < weekAgo;
                            case 'month':
                                const monthAgo = new Date(now);
                                monthAgo.setMonth(monthAgo.getMonth() - 1);
                                return sessionDate < monthAgo;
                            default:
                                return true;
                        }
                    });
                } else {
                    filteredData = [];
                }
                
                const deletedCount = localData.length - filteredData.length;
                
                // 1. Ulo≈æ filtrovan√° data lok√°lnƒõ
                localStorage.setItem('sales_sessions', JSON.stringify(filteredData));
                console.log(`üóëÔ∏è Lok√°lnƒõ smaz√°no: ${deletedCount} sessions`);
                console.log(`üìä Lok√°lnƒõ z≈Øst√°v√°: ${filteredData.length} sessions`);
                
                // 2. Synchronizuj se serverem - po≈°li aktualizovan√° data
                btn.textContent = 'üåê Sync se serverem...';
                
                try {
                    // Pokud ma≈æeme v≈°echna data, po≈°li pr√°zdn√Ω array
                    // Jinak po≈°li filtrovan√° data
                    const dataToSync = filteredData;
                    
                    console.log('üåê Synchronizuji smaz√°n√≠ se serverem...');
                    console.log('üåê Data k odesl√°n√≠:', dataToSync.length, 'sessions');
                    
                    // Mo≈ænost 1: Po≈°li v≈°echna zb√Ωvaj√≠c√≠ data na server (p≈ôep√≠≈°e kompletnƒõ)
                    const syncResponse = await fetch('/api/sales-data/bulk-update', {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            action: 'replace_all',
                            salesData: dataToSync,
                            deletedCount: deletedCount,
                            period: period
                        })
                    });
                    
                    if (syncResponse.ok) {
                        const syncResult = await syncResponse.json();
                        console.log('‚úÖ Server synchronizace √∫spƒõ≈°n√°:', syncResult);
                        btn.textContent = '‚úÖ Smaz√°no + Sync OK';
                        btn.style.background = '#2ed573';
                    } else {
                        // Fallback: Zkus individu√°lnƒõ smazat sessions na serveru
                        console.log('‚ö†Ô∏è Bulk update failed, zkou≈°√≠m individu√°ln√≠ maz√°n√≠...');
                        
                        // Najdi sessions k smaz√°n√≠
                        const sessionsToDelete = localData.filter(session => {
                            return !filteredData.some(kept => 
                                kept.timestamp === session.timestamp && 
                                kept.seller === session.seller
                            );
                        });
                        
                        console.log('üóëÔ∏è Individu√°lnƒõ ma≈æu', sessionsToDelete.length, 'sessions na serveru');
                        
                        // Po≈°li DELETE requesty pro jednotliv√© sessions
                        let serverDeletedCount = 0;
                        for (const session of sessionsToDelete) {
                            try {
                                const deleteResponse = await fetch('/api/sales-data/' + encodeURIComponent(session.timestamp), {
                                    method: 'DELETE'
                                });
                                if (deleteResponse.ok) {
                                    serverDeletedCount++;
                                }
                            } catch (deleteError) {
                                console.warn('‚ö†Ô∏è Nepoda≈ôilo se smazat session:', session.timestamp);
                            }
                        }
                        
                        btn.textContent = `‚úÖ Smaz√°no (${serverDeletedCount}/${sessionsToDelete.length} sync)`;
                        btn.style.background = serverDeletedCount === sessionsToDelete.length ? '#2ed573' : '#ff9500';
                    }
                    
                } catch (serverError) {
                    console.error('‚ùå Server sync error:', serverError);
                    btn.textContent = '‚ö†Ô∏è Smaz√°no lok√°lnƒõ (server offline)';
                    btn.style.background = '#ff9500';
                    
                    // Zobraz warning o offline re≈æimu
                    setTimeout(() => {
                        alert(`‚ö†Ô∏è Data byla smaz√°na lok√°lnƒõ, ale server nen√≠ dostupn√Ω.\n\nPro kompletn√≠ smaz√°n√≠ pou≈æijte pozdƒõji tlaƒç√≠tko "üîÑ Sync se serverem"`);
                    }, 1000);
                }
                
                // 3. Aktualizuj UI
                loadAvailableStores();
                loadAnalytics();
                
                // Zav≈ôi modal
                closeDeleteModal();
                
                // Zobraz v√Ωsledek
                setTimeout(() => {
                    alert(`‚úÖ √öspƒõ≈°nƒõ smaz√°no ${deletedCount} z√°znam≈Ø!\n\n${filteredData.length} z√°znam≈Ø z≈Øst√°v√°.`);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Chyba p≈ôi maz√°n√≠:', error);
                btn.textContent = '‚ùå Chyba p≈ôi maz√°n√≠';
                btn.style.background = '#ff4757';
                alert('‚ùå Chyba p≈ôi maz√°n√≠ dat!');
            }
        }

        // Zobrazen√≠ statusu ukl√°d√°n√≠ dat
        function showDataStatus() {
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                const statusDiv = document.getElementById('storage-info');
                
                if (statusDiv) {
                    const statusHTML = `
                        <div style="display: grid; gap: 0.5rem;">
                            <div>üíæ <strong>Lok√°ln√≠ √∫lo≈æi≈°tƒõ:</strong> ${localData.length} sessions ulo≈æeno</div>
                            <div>üåê <strong>Server:</strong> <span id="server-status">Testuji...</span></div>
                            <div>üîÑ <strong>Synchronizace:</strong> <span id="sync-status">Automatick√° p≈ôi ulo≈æen√≠</span></div>
                            <div style="font-size: 0.8rem; margin-top: 0.5rem; color: var(--text-secondary);">
                                ‚úÖ Data jsou ukl√°d√°na lok√°lnƒõ i na server pro dlouhodob√© uchov√°v√°n√≠
                            </div>
                        </div>
                    `;
                    statusDiv.innerHTML = statusHTML;
                    
                    // Test server status
                    testServerStatusQuiet();
                }
            } catch (error) {
                console.error('Chyba p≈ôi zobrazov√°n√≠ statusu dat:', error);
            }
        }

        // Tich√Ω test serveru pro status
        async function testServerStatusQuiet() {
            const statusElement = document.getElementById('server-status');
            if (!statusElement) return;
            
            try {
                // Chrome kompatibiln√≠ timeout implementace
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                
                const response = await fetch('/api/sales-data?type=stats', { 
                    method: 'GET',
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                if (response.ok) {
                    statusElement.innerHTML = '<span style="color: #2ed573;">‚úÖ P≈ôipojen a funkƒçn√≠</span>';
                } else {
                    throw new Error('Server nedostupn√Ω');
                }
            } catch (error) {
                statusElement.innerHTML = '<span style="color: #ff9500;">‚ö†Ô∏è Offline (data v localStorage)</span>';
            }
        }

        // Funkce pro kontrolu duplicit p≈ôi startu
        function checkForDuplicates() {
            try {
                const localData = JSON.parse(localStorage.getItem('sales_sessions') || '[]');
                if (localData.length === 0) return;
                
                const sellerCounts = {};
                localData.forEach(session => {
                    const seller = session.seller || session.sellerId || 'Unknown';
                    sellerCounts[seller] = (sellerCounts[seller] || 0) + 1;
                });
                
                const checkPairs = [
                    ['Tom√°≈° Valenta', 'tvalenta'],
                    ['Admin Administr√°tor', 'admin'],
                    ['≈†imon Gabriel', 'sgabriel']
                ];
                
                const duplicates = [];
                checkPairs.forEach(([fullName, username]) => {
                    if (sellerCounts[fullName] && sellerCounts[username]) {
                        duplicates.push({ fullName, username });
                    }
                });
                
                if (duplicates.length > 0) {
                    // Zobraz upozornƒõn√≠ o duplicit√°ch
                    const analyticsContainer = document.querySelector('.analytics-container');
                    if (analyticsContainer) {
                        const warningDiv = document.createElement('div');
                        warningDiv.innerHTML = `
                            <div style="
                                background: rgba(255, 152, 0, 0.1); border: 1px solid #ff9800; 
                                border-radius: 10px; padding: 1rem; margin-bottom: 2rem; 
                                border-left: 4px solid #ff9800;
                            ">
                                <h4 style="color: #ff9800; margin: 0 0 0.5rem 0; font-size: 1rem;">
                                    ‚ö†Ô∏è Nalezeny duplicitn√≠ prodejci
                                </h4>
                                <p style="color: var(--text-primary); margin: 0 0 1rem 0; font-size: 0.9rem;">
                                    V datech se na≈°li duplicitn√≠ z√°znamy pro stejn√© prodejce. To zp≈Øsobuje rozdƒõlen√≠ statistik.
                                </p>
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                                    <button onclick="cleanDuplicateSellerData()" style="
                                        background: #8e44ad; color: white; border: none; 
                                        padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; 
                                        font-size: 0.9rem; font-weight: 500;
                                    ">üîß Opravit automaticky</button>
                                    <button onclick="this.closest('div').style.display='none'" style="
                                        background: rgba(255,255,255,0.1); color: var(--text-primary); 
                                        border: 1px solid rgba(255,255,255,0.2); padding: 0.5rem 1rem; 
                                        border-radius: 6px; cursor: pointer; font-size: 0.9rem;
                                    ">Zav≈ô√≠t upozornƒõn√≠</button>
                                </div>
                            </div>
                        `;
                        
                        const filterSection = document.querySelector('.filter-section');
                        if (filterSection) {
                            analyticsContainer.insertBefore(warningDiv, filterSection);
                        }
                    }
                    
                    console.warn('‚ö†Ô∏è Nalezeny duplicitn√≠ prodejci p≈ôi startu aplikace');
                }
            } catch (error) {
                console.error('Chyba p≈ôi kontrole duplicit:', error);
            }
        }

        // Inicializace p≈ôi naƒçten√≠ str√°nky
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Analytika se inicializuje...');
            
            // P≈ôidej status section p≈ôed analytiky
            const analyticsContainer = document.querySelector('.analytics-container');
            const filterSection = document.querySelector('.filter-section');
            
            if (analyticsContainer && filterSection) {
                const statusSection = document.createElement('div');
                statusSection.innerHTML = `
                    <div style="
                        background: rgba(255,255,255,0.05); border-radius: 10px; padding: 1rem; 
                        margin-bottom: 2rem; border-left: 4px solid var(--primary-color);
                    ">
                        <h4 style="color: var(--primary-color); margin: 0 0 0.5rem 0; font-size: 0.9rem;">
                            üìä Status ukl√°d√°n√≠ dat
                        </h4>
                        <div id="storage-info" style="color: var(--text-secondary); font-size: 0.85rem;">
                            <div>üîç Kontroluji stav √∫lo≈æi≈°tƒõ...</div>
                        </div>
                    </div>
                `;
                
                analyticsContainer.insertBefore(statusSection, filterSection.nextSibling);
                
                // Zobraz status dat
                setTimeout(showDataStatus, 200);
            }
            
            // Zkontroluj duplicity
            setTimeout(checkForDuplicates, 300);
            
            // Naƒçti dostupn√© prodejny
            setTimeout(loadAvailableStores, 150);
            
            // Mal√© zpo≈ædƒõn√≠ aby se v≈°echno naƒçetlo
            setTimeout(() => {
                loadAnalytics();
            }, 500);
        });
    </script>
</body>
</html> 